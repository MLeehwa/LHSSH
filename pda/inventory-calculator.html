<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title data-i18n="inventory_calculator_title">재고 계산기 - PDA</title>
    
    <!-- Supabase 설정 (먼저 로드) -->
    <script src="../js/config.js"></script>
    
    <!-- Supabase 클라이언트 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- i18n 스크립트 -->
    <script src="../js/i18n.js"></script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        /* 타블렛 세로 모드 최적화 */
        @media (max-width: 1024px) and (orientation: portrait) {
            body {
                padding-bottom: 90px;
            }
            
            .glass-card {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            header {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            main {
                padding: 0.75rem !important;
            }
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .input-group {
            margin-bottom: 1rem;
        }
        
        .input-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }
        
        .input-field, .select-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .input-field:focus, .select-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .result-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 1rem;
            margin-top: 1rem;
        }
        
        .result-value {
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            margin: 0.5rem 0;
        }
        
        .difference-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            border-left: 4px solid #10b981;
        }
        
        .difference-negative {
            border-left-color: #ef4444;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
        
        .item-row {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .item-row input {
            flex: 1;
        }
        
        .fixed-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 1rem;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        /* 태블릿 최적화 스타일 */
        .table-input {
            font-size: 20px !important;
            padding: 14px 10px !important;
            min-height: 56px;
            border: 3px solid #e5e7eb !important;
            background-color: #f9fafb;
            transition: all 0.2s;
            text-align: center;
            font-weight: 600;
            /* 타블렛에서 스피너 화살표 숨기기 */
            -moz-appearance: textfield;
            flex: 1;
        }
        
        /* 스피너 화살표 숨기기 (Chrome, Safari, Edge) */
        .table-input::-webkit-outer-spin-button,
        .table-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* 수량 조절 버튼 컨테이너 */
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 2px;
            width: 100%;
        }
        
        .quantity-control .table-input {
            flex: 1 1 auto;
            min-width: 30px;
            max-width: none;
        }
        
        /* 수량 조절 버튼 */
        .quantity-btn {
            min-width: 28px;
            min-height: 40px;
            background-color: #3b82f6;
            color: white;
            border: 3px solid #2563eb;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        .quantity-btn:active {
            background-color: #2563eb;
            transform: scale(0.95);
        }
        
        .quantity-btn:hover {
            background-color: #2563eb;
        }
        
        .quantity-btn.decrease {
            background-color: #ef4444;
            border-color: #dc2626;
        }
        
        .quantity-btn.decrease:active {
            background-color: #dc2626;
        }
        
        .quantity-btn.decrease:hover {
            background-color: #dc2626;
        }
        
        .table-input:focus {
            background-color: #eff6ff !important;
            border-color: #3b82f6 !important;
            outline: none;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
            transform: scale(1.02);
            z-index: 10;
            position: relative;
        }
        
        .table-input:not(:placeholder-shown) {
            background-color: #f0f9ff !important;
            border-color: #0ea5e9 !important;
        }
        
        .table-row:has(.table-input:focus) {
            background-color: #eff6ff;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.3);
        }
        
        .table-select {
            font-size: 18px !important;
            padding: 12px 8px !important;
            min-height: 48px;
            border: 2px solid #e5e7eb !important;
            background-color: #f9fafb;
        }
        
        .table-select:focus {
            background-color: #ffffff;
            border-color: #3b82f6 !important;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .subtotal-cell {
            font-size: 18px;
            font-weight: 700;
            padding: 10px 4px;
            min-height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f3f4f6;
            border-radius: 4px;
        }
        
        .total-cell {
            font-size: 22px;
            font-weight: 700;
            padding: 8px 4px;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* 반응형 스타일 - 타블렛 세로 모드 최적화 */
        @media (max-width: 1200px) {
            #calculationTable {
                min-width: 900px !important;
            }
            
            .table-input {
                font-size: 16px !important;
                padding: 10px 6px !important;
                min-height: 48px;
            }
            
            .quantity-btn {
                min-width: 40px;
                min-height: 48px;
                font-size: 20px;
            }
            
            .quantity-control .table-input {
                min-width: 28px !important;
            }
            
            .subtotal-cell {
                font-size: 12px !important;
                padding: 6px 3px !important;
                min-height: 48px;
            }
            
            .total-cell {
                font-size: 18px !important;
            }
            
            table {
                font-size: 12px;
            }
            
            th, td {
                padding: 4px 2px !important;
            }
        }
        
        /* 타블렛 세로 모드 (768px ~ 1024px) */
        @media (max-width: 1024px) and (orientation: portrait) {
            #calculationTable {
                min-width: 800px !important;
            }
            
            .table-input {
                font-size: 14px !important;
                padding: 8px 4px !important;
                min-height: 44px;
            }
            
            .quantity-btn {
                min-width: 32px !important;
                min-height: 44px !important;
                font-size: 16px;
            }
            
            .quantity-control .table-input {
                min-width: 24px !important;
            }
            
            .subtotal-cell {
                font-size: 11px !important;
                padding: 5px 2px !important;
                min-height: 44px;
            }
            
            .total-cell {
                font-size: 15px !important;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 3px 1px !important;
            }
            
            th {
                font-size: 10px !important;
            }
            
            /* 헤더 텍스트 줄바꿈 최적화 */
            th br {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            #calculationTable {
                min-width: 700px !important;
            }
            
            .table-input {
                font-size: 14px !important;
                padding: 8px 4px !important;
                min-height: 40px;
            }
            
            .quantity-btn {
                min-width: 36px;
                min-height: 40px;
                font-size: 18px;
            }
            
            .quantity-control .table-input {
                min-width: 25px !important;
            }
            
            .quantity-btn {
                min-width: 20px !important;
                min-height: 36px !important;
            }
            
            .subtotal-cell {
                font-size: 10px !important;
                padding: 4px 2px !important;
                min-height: 40px;
            }
            
            .total-cell {
                font-size: 16px !important;
            }
            
            table {
                font-size: 11px;
            }
            
            th, td {
                padding: 3px 1px !important;
            }
            
            th {
                font-size: 10px !important;
            }
        }
        
        /* 테이블 스크롤 최적화 */
        .overflow-x-auto {
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }
        
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        
        .overflow-x-auto::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* 터치 최적화 버튼 */
        .btn-table {
            min-width: 48px;
            min-height: 48px;
            padding: 12px;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="glass-card p-4 mb-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <button onclick="window.location.href='index.html'" class="btn btn-secondary mr-3">
                    <i class="fas fa-home"></i>
                </button>
                <div>
                    <h1 class="text-xl font-bold text-gray-800" data-i18n="inventory_calculator_title">재고 계산기</h1>
                    <p class="text-xs text-gray-600" data-i18n="inventory_calculator_subtitle">박스/잔량/렉 수량 계산</p>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4">
        <!-- 세션 정보 -->
        <div class="glass-card p-3 mb-3">
            <h2 class="text-base font-bold text-gray-800 mb-2" data-i18n="session_info">세션 정보</h2>
            <div class="input-group">
                <label class="input-label" data-i18n="date">날짜</label>
                <input type="date" id="sessionDate" class="input-field" value="" onchange="loadSessionsForDate()">
            </div>
            <div class="input-group mt-3">
                <label class="input-label" data-i18n="session_name">세션 (Notes)</label>
                <select id="sessionSelect" class="input-field" onchange="handleSessionSelect()">
                    <option value="">-- 새 세션 생성 --</option>
                </select>
            </div>
            <div class="input-group mt-3" id="sessionNameGroup" style="display: none;">
                <label class="input-label" data-i18n="session_name">세션명</label>
                <input type="text" id="sessionName" class="input-field" placeholder="세션명을 입력하세요">
            </div>
        </div>

        <!-- 입력 테이블 -->
        <div class="glass-card p-3 mb-3">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-base font-bold text-gray-800" data-i18n="inventory_calculation_table">재고 계산 테이블</h2>
                <div class="flex gap-2">
                    <span class="text-xs text-gray-600" id="partsStatus">파트 로딩 중...</span>
                </div>
            </div>
            <div class="overflow-x-auto w-full">
                <table class="w-full border-collapse table-auto" id="calculationTable" style="min-width: 1160px; width: 100%;">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center" style="width: 35px; min-width: 35px;" data-i18n="no">번호</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center" style="width: 100px; min-width: 100px;" data-i18n="part_number">파트</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-gray-50" colspan="5" style="min-width: 180px;">박스</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-gray-100" style="width: 45px; min-width: 45px;" data-i18n="box1_subtotal">박스<br>소계</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-gray-50" colspan="3" style="min-width: 110px;">렉</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-gray-100" style="width: 45px; min-width: 45px;" data-i18n="rack_subtotal">렉<br>소계</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-gray-50" style="width: 45px; min-width: 45px;" data-i18n="remaining_quantity">잔량</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-bold text-gray-800 text-center bg-red-50" style="width: 70px; min-width: 70px; border-left: 3px solid #ef4444;" data-i18n="total">총합계</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-bold text-blue-800 text-center bg-blue-50" style="width: 70px; min-width: 70px;" data-i18n="system_stock">시스템<br>재고</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-bold text-gray-800 text-center bg-gray-50" style="width: 60px; min-width: 60px;">차이</th>
                        </tr>
                        <tr class="bg-gray-50">
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center"></th>
                            <th class="border-2 border-gray-400 px-2 py-2 text-sm font-semibold text-gray-800 text-center"></th>
                            <th class="border-2 border-gray-400 px-1 py-1 text-xs font-semibold text-gray-800 text-center bg-gray-50" style="width: 40px; min-width: 40px;">1</th>
                            <th class="border-2 border-gray-400 px-1 py-1 text-xs font-semibold text-gray-800 text-center bg-gray-50" style="width: 40px; min-width: 40px;">2</th>
                            <th class="border-2 border-gray-400 px-1 py-1 text-xs font-semibold text-gray-800 text-center bg-gray-50" style="width: 40px; min-width: 40px;">3</th>
                            <th class="border-2 border-gray-400 px-1 py-1 text-xs font-semibold text-gray-800 text-center bg-gray-50" style="width: 40px; min-width: 40px;">4</th>
                            <th class="border-2 border-gray-400 px-1 py-1 text-xs font-semibold text-gray-800 text-center bg-gray-50" style="width: 40px; min-width: 40px;">5</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-gray-100"></th>
                            <th class="border-2 border-gray-400 px-1 py-1 text-xs font-semibold text-gray-800 text-center bg-gray-50" style="width: 40px; min-width: 40px;">1</th>
                            <th class="border-2 border-gray-400 px-1 py-1 text-xs font-semibold text-gray-800 text-center bg-gray-50" style="width: 40px; min-width: 40px;">2</th>
                            <th class="border-2 border-gray-400 px-1 py-1 text-xs font-semibold text-gray-800 text-center bg-gray-50" style="width: 40px; min-width: 40px;">3</th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-gray-100"></th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-gray-50"></th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-red-50"></th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-blue-50"></th>
                            <th class="border-2 border-gray-400 px-1 py-2 text-xs font-semibold text-gray-800 text-center bg-gray-50"></th>
                        </tr>
                    </thead>
                    <tbody id="calculationTableBody">
                        <!-- 테이블 행들이 여기에 동적으로 추가됨 -->
                    </tbody>
                </table>
            </div>
        </div>

    </main>

    <!-- 하단 고정 버튼 -->
    <div class="fixed-bottom">
        <div class="flex gap-2">
            <button onclick="saveAllToPhysicalInventory()" class="btn btn-success flex-1">
                <i class="fas fa-save mr-2"></i>
                <span data-i18n="save_all_to_inventory">전체 저장</span>
            </button>
            <button onclick="clearAllRows()" class="btn btn-secondary">
                <i class="fas fa-trash mr-2"></i>
                <span data-i18n="clear_all">전체 삭제</span>
            </button>
        </div>
    </div>

    <script>
        let supabaseClient = null; // Supabase 클라이언트 인스턴스
        let allParts = [];
        let tableRowCount = 0;
        let systemStocks = {}; // 파트별 시스템 재고 캐시

        // Supabase 설정 (physical-inventory.html과 동일)
        const supabaseUrl = 'https://vzemucykhxlxgjuldibf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6ZW11Y3lraHhseGdqdWxkaWJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzA4MjcsImV4cCI6MjA2ODk0NjgyN30.L9DN-V33rQj6atDnDhVeIOyzGP5I_3uVWSVfMObqrbQ';
        
        // Supabase 초기화 (physical-inventory.html과 동일한 방식)
        function initSupabase() {
            try {
                if (window.supabase) {
                    supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabase 클라이언트 초기화 성공');
                    return true;
                } else {
                    throw new Error('Supabase 라이브러리가 로드되지 않았습니다.');
                }
            } catch (error) {
                console.error('Supabase 클라이언트 초기화 실패:', error);
                return false;
            }
        }

        // 파트 목록 로드
        async function loadPartsList() {
            if (!supabaseClient) {
                console.error('Supabase 클라이언트가 초기화되지 않았습니다.');
                return;
            }
            
            try {
                console.log('파트 목록 로드 시작... (AS 파트 제외)');
                
                // AS 파트 제외하고 로드
                let query = supabaseClient
                    .from('parts')
                    .select('part_number, description, category, product_type')
                    .eq('status', 'ACTIVE')
                    .neq('product_type', 'AS'); // AS 파트 제외
                
                const { data, error } = await query.order('part_number');
                
                if (error) {
                    console.error('Supabase 쿼리 오류:', error);
                    throw error;
                }
                
                allParts = data || [];
                console.log('파트 목록 로드 완료:', allParts.length + '개');
            } catch (error) {
                console.error('파트 목록 로드 오류:', error);
                alert('파트 목록을 불러오는 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 세션 목록 관리
        let availableSessions = [];
        let selectedSessionId = null;

        // 날짜별 세션 목록 로드
        async function loadSessionsForDate() {
            const sessionDate = document.getElementById('sessionDate').value;
            const sessionSelect = document.getElementById('sessionSelect');
            const sessionNameGroup = document.getElementById('sessionNameGroup');
            const sessionNameInput = document.getElementById('sessionName');
            
            if (!sessionDate || !supabaseClient) {
                sessionSelect.innerHTML = '<option value="">-- 새 세션 생성 --</option>';
                sessionNameGroup.style.display = 'none';
                selectedSessionId = null;
                return;
            }
            
            try {
                // 해당 날짜의 PENDING 또는 COMPLETED 세션 조회
                const { data, error } = await supabaseClient
                    .from('physical_inventory_sessions')
                    .select('id, notes, status, session_date')
                    .eq('session_date', sessionDate)
                    .in('status', ['PENDING', 'COMPLETED'])
                    .order('created_at', { ascending: false });
                
                if (error) {
                    console.error('세션 목록 로드 오류:', error);
                    sessionSelect.innerHTML = '<option value="">-- 새 세션 생성 --</option>';
                    return;
                }
                
                availableSessions = data || [];
                sessionSelect.innerHTML = '<option value="">-- 새 세션 생성 --</option>';
                
                // 세션 목록 추가
                availableSessions.forEach(session => {
                    const option = document.createElement('option');
                    option.value = session.id;
                    option.textContent = session.notes || `세션 #${session.id}`;
                    if (session.status === 'COMPLETED') {
                        option.textContent += ' (완료)';
                    }
                    sessionSelect.appendChild(option);
                });
                
                // 세션이 없으면 세션명 자동 생성
                if (availableSessions.length === 0) {
                    sessionNameGroup.style.display = 'none'; // 숨김 (자동 생성)
                    generateAutoSessionName();
                }
            } catch (error) {
                console.error('세션 목록 로드 오류:', error);
                sessionSelect.innerHTML = '<option value="">-- 새 세션 생성 --</option>';
            }
        }

        // 세션 선택 핸들러
        function handleSessionSelect() {
            const sessionSelect = document.getElementById('sessionSelect');
            const sessionNameGroup = document.getElementById('sessionNameGroup');
            const sessionNameInput = document.getElementById('sessionName');
            
            selectedSessionId = sessionSelect.value;
            
            if (!selectedSessionId) {
                // 새 세션 생성 모드 - 세션명 자동 생성
                sessionNameGroup.style.display = 'none'; // 숨김 (자동 생성)
                generateAutoSessionName();
            } else {
                // 기존 세션 선택
                const selectedSession = availableSessions.find(s => s.id == selectedSessionId);
                if (selectedSession) {
                    sessionNameGroup.style.display = 'none'; // 숨김 (기존 세션명 사용)
                    sessionNameInput.value = selectedSession.notes || '';
                }
            }
        }

        // 자동 세션명 생성
        function generateAutoSessionName() {
            const sessionDate = document.getElementById('sessionDate').value;
            const sessionNameInput = document.getElementById('sessionName');
            
            if (sessionDate && sessionNameInput) {
                const dateObj = new Date(sessionDate);
                const sessionName = `계산기 실사 ${dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}`;
                sessionNameInput.value = sessionName;
            }
        }

        // 모든 파트를 테이블에 미리 로드
        async function loadAllPartsToTable() {
            const tbody = document.getElementById('calculationTableBody');
            const statusEl = document.getElementById('partsStatus');
            
            if (!allParts || allParts.length === 0) {
                if (statusEl) statusEl.textContent = '파트가 없습니다';
                return;
            }
            
            // INNER와 REAR로 분류
            const innerParts = allParts.filter(p => p.part_number.startsWith('49560'));
            const rearParts49600 = allParts.filter(p => p.part_number.startsWith('49600'));
            const rearParts49601 = allParts.filter(p => p.part_number.startsWith('49601'));
            const otherParts = allParts.filter(p => !p.part_number.startsWith('49560') && !p.part_number.startsWith('49600') && !p.part_number.startsWith('49601'));
            
            tbody.innerHTML = '';
            tableRowCount = 0;
            
            // INNER 파트들 추가
            if (innerParts.length > 0) {
                const headerRow = document.createElement('tr');
                headerRow.className = 'bg-blue-100 table-row';
                headerRow.innerHTML = `
                    <td colspan="16" class="border-2 border-gray-400 px-3 py-2 font-bold text-blue-800 text-center">
                        INNER (${innerParts.length}개)
                    </td>
                `;
                tbody.appendChild(headerRow);
                
                innerParts.forEach(part => {
                    addPartRow(part, 'INNER', 'text-blue-600');
                });
            }
            
            // REAR 파트들 추가 (49600과 49601을 뒤의 파트 번호로 그룹화)
            const allRearParts = [...rearParts49600, ...rearParts49601];
            if (allRearParts.length > 0) {
                const headerRow = document.createElement('tr');
                headerRow.className = 'bg-green-100 table-row';
                headerRow.innerHTML = `
                    <td colspan="16" class="border-2 border-gray-400 px-3 py-2 font-bold text-green-800 text-center">
                        REAR (${allRearParts.length}개)
                    </td>
                `;
                tbody.appendChild(headerRow);
                
                // 뒤의 파트 번호로 그룹화 (예: l3000)
                const groupedRearParts = {};
                allRearParts.forEach(part => {
                    // 49600-xxxxx 또는 49601-xxxxx 형식에서 뒤의 부분 추출
                    const match = part.part_number.match(/^4960[01]-(.+)$/);
                    if (match) {
                        const suffix = match[1];
                        if (!groupedRearParts[suffix]) {
                            groupedRearParts[suffix] = [];
                        }
                        groupedRearParts[suffix].push(part);
                    } else {
                        // 매칭되지 않는 경우 (49600 또는 49601만 있는 경우)
                        if (!groupedRearParts['']) {
                            groupedRearParts[''] = [];
                        }
                        groupedRearParts[''].push(part);
                    }
                });
                
                // 그룹화된 파트들을 정렬하여 추가 (49600 먼저, 49601 나중에)
                Object.keys(groupedRearParts).sort().forEach(suffix => {
                    const parts = groupedRearParts[suffix];
                    // 49600으로 시작하는 파트 먼저, 49601으로 시작하는 파트 나중에
                    const parts49600 = parts.filter(p => p.part_number.startsWith('49600'));
                    const parts49601 = parts.filter(p => p.part_number.startsWith('49601'));
                    
                    parts49600.forEach(part => {
                        addPartRow(part, 'REAR', 'text-green-600');
                    });
                    parts49601.forEach(part => {
                        addPartRow(part, 'REAR', 'text-green-600');
                    });
                });
            }
            
            // 기타 파트들 추가
            if (otherParts.length > 0) {
                const headerRow = document.createElement('tr');
                headerRow.className = 'bg-gray-100 table-row';
                headerRow.innerHTML = `
                    <td colspan="16" class="border-2 border-gray-400 px-3 py-2 font-bold text-gray-800 text-center">
                        기타 (${otherParts.length}개)
                    </td>
                `;
                tbody.appendChild(headerRow);
                
                otherParts.forEach(part => {
                    addPartRow(part, '', 'text-gray-600');
                });
            }
            
            if (statusEl) {
                statusEl.textContent = `총 ${allParts.length}개 파트`;
            }
            
        }

        // 개별 파트 행 추가
        function addPartRow(part, category, categoryColor) {
            const tbody = document.getElementById('calculationTableBody');
            const rowId = `row_${tableRowCount++}`;
            const rowNumber = tableRowCount;
            
            const row = document.createElement('tr');
            row.id = rowId;
            row.className = 'table-row';
            row.dataset.partNumber = part.part_number;
            
            const displayText = part.description 
                ? `${part.part_number} - ${part.description}`
                : `${part.part_number}${part.category ? ' - ' + part.category : ''}`;
            
            // 박스 5개 인풋 생성
            let boxInputs = '';
            for (let i = 1; i <= 5; i++) {
                const nextInput = i === 5 ? 'rack1' : `box${i + 1}`;
                boxInputs += `
                    <td class="border-2 border-gray-400 px-1 py-1 bg-gray-50" style="width: 40px; min-width: 40px;">
                        <input type="number" class="table-input w-full rounded text-center" 
                               min="0" oninput="calculateRowTotal('${rowId}')" 
                               onkeydown="handleInputKeydown(event, '${rowId}', '${nextInput}')"
                               onfocus="highlightRow('${rowId}')"
                               onblur="unhighlightRow('${rowId}')"
                               data-row="${rowId}" data-type="box${i}" placeholder="" id="box${i}-${rowId}" inputmode="numeric">
                    </td>
                `;
            }
            
            // 렉 3개 인풋 생성
            let rackInputs = '';
            for (let i = 1; i <= 3; i++) {
                const nextInput = i === 3 ? 'remaining' : `rack${i + 1}`;
                rackInputs += `
                    <td class="border-2 border-gray-400 px-1 py-1 bg-gray-50" style="width: 40px; min-width: 40px;">
                        <input type="number" class="table-input w-full rounded text-center" 
                               min="0" oninput="calculateRowTotal('${rowId}')" 
                               onkeydown="handleInputKeydown(event, '${rowId}', '${nextInput}')"
                               onfocus="highlightRow('${rowId}')"
                               onblur="unhighlightRow('${rowId}')"
                               data-row="${rowId}" data-type="rack${i}" placeholder="" id="rack${i}-${rowId}" inputmode="numeric">
                    </td>
                `;
            }
            
            row.innerHTML = `
                <td class="border-2 border-gray-400 px-1 py-1 text-center text-xs font-semibold" style="width: 40px; min-width: 40px;">${rowNumber}</td>
                <td class="border-2 border-gray-400 px-2 py-1" id="part-cell-${rowId}" style="width: 130px; min-width: 130px;">
                    <div class="text-lg font-bold text-gray-800">${part.part_number}</div>
                    ${part.description ? `<div class="text-xs text-gray-600 mt-1">${part.description}</div>` : ''}
                </td>
                ${boxInputs}
                <td class="border-2 border-gray-400 px-1 py-1 text-center bg-gray-100" style="width: 50px; min-width: 50px;">
                    <span class="subtotal-cell text-gray-800 font-bold text-sm" data-row="${rowId}" data-type="box-total">0</span>
                </td>
                ${rackInputs}
                <td class="border-2 border-gray-400 px-1 py-1 text-center bg-gray-100" style="width: 50px; min-width: 50px;">
                    <span class="subtotal-cell text-gray-800 font-bold text-sm" data-row="${rowId}" data-type="rack-total">0</span>
                </td>
                <td class="border-2 border-gray-400 px-1 py-1 bg-gray-50" style="width: 50px; min-width: 50px;">
                    <input type="number" class="table-input w-full rounded" 
                           min="0" oninput="calculateRowTotal('${rowId}')" 
                           onkeydown="handleInputKeydown(event, '${rowId}', null)"
                           onfocus="highlightRow('${rowId}')"
                           onblur="unhighlightRow('${rowId}')"
                           data-row="${rowId}" data-type="remaining" placeholder="" id="remaining-${rowId}" inputmode="numeric">
                </td>
                <td class="border-2 border-gray-400 px-1 py-2 text-center" id="total-cell-${rowId}" style="width: 80px; min-width: 80px; border-left: 3px solid #ef4444; background-color: #fee2e2;">
                    <span class="total-cell text-red-800 font-bold text-lg" data-row="${rowId}" data-type="total">0</span>
                </td>
                <td class="border-2 border-gray-400 px-1 py-2 text-center bg-blue-50" style="width: 80px; min-width: 80px;">
                    <span class="text-blue-800 font-bold text-lg" data-row="${rowId}" data-type="system-stock">-</span>
                </td>
                <td class="border-2 border-gray-400 px-1 py-2 text-center bg-gray-50" id="difference-cell-${rowId}" style="width: 80px; min-width: 80px;">
                    <span class="font-bold text-lg" data-row="${rowId}" data-type="difference">-</span>
                </td>
            `;
            
            tbody.appendChild(row);
            
            // 파트 번호로 기본값 설정
            const partNumber = part.part_number;
            setTimeout(() => {
                // 시스템 재고 조회
                loadSystemStockForPart(partNumber).then(() => {
                    // 시스템 재고와 차이 표시 업데이트
                    updateRowStockDisplay(rowId, partNumber);
                });
            }, 100);
        }

        // 행의 시스템 재고와 차이 표시 업데이트
        function updateRowStockDisplay(rowId, partNumber) {
            const systemStock = systemStocks[partNumber] || 0;
            const totalEl = document.querySelector(`[data-row="${rowId}"][data-type="total"]`);
            const systemStockEl = document.querySelector(`[data-row="${rowId}"][data-type="system-stock"]`);
            const differenceEl = document.querySelector(`[data-row="${rowId}"][data-type="difference"]`);
            const totalCell = document.getElementById(`total-cell-${rowId}`);
            const differenceCell = document.getElementById(`difference-cell-${rowId}`);
            
            if (!totalEl || !systemStockEl || !differenceEl || !totalCell || !differenceCell) return;
            
            const total = parseFloat(totalEl.textContent.replace(/,/g, '')) || 0;
            const difference = total - systemStock;
            
            systemStockEl.textContent = systemStock.toLocaleString();
            differenceEl.textContent = difference > 0 ? `+${difference.toLocaleString()}` : difference.toLocaleString();
            
            // 시스템 재고 스타일 (항상 파란색, 큰 글씨)
            systemStockEl.className = 'text-blue-800 font-bold text-lg';
            
            // 총합계와 차이 셀 색상 설정
            if (difference === 0) {
                differenceEl.className = 'font-bold text-lg text-green-700';
                totalEl.className = 'total-cell text-green-800 font-bold text-lg';
                totalCell.style.backgroundColor = '#dcfce7'; // 초록색 배경
                totalCell.style.borderLeftColor = '#10b981';
                differenceCell.style.backgroundColor = '#dcfce7';
            } else if (difference > 0) {
                differenceEl.className = 'font-bold text-lg text-orange-700';
                totalEl.className = 'total-cell text-orange-800 font-bold text-lg';
                totalCell.style.backgroundColor = '#fed7aa'; // 주황색 배경
                totalCell.style.borderLeftColor = '#f97316';
                differenceCell.style.backgroundColor = '#fed7aa';
            } else {
                differenceEl.className = 'font-bold text-lg text-red-700';
                totalEl.className = 'total-cell text-red-800 font-bold text-lg';
                totalCell.style.backgroundColor = '#fee2e2'; // 빨간색 배경
                totalCell.style.borderLeftColor = '#ef4444';
                differenceCell.style.backgroundColor = '#fee2e2';
            }
        }


        // 파트 번호에 따른 기본 박스1 UNIT 반환
        function getDefaultBox1Unit(partNumber) {
            if (!partNumber) return null;
            
            // 49560으로 시작하는 파트: 박스1 UNIT = 84
            if (partNumber.startsWith('49560')) {
                return 84;
            }
            
            // 49600 또는 49601로 시작하는 파트: 박스1 UNIT = 80
            if (partNumber.startsWith('49600') || partNumber.startsWith('49601')) {
                return 80;
            }
            
            return null;
        }

        // 파트 번호에 따른 기본 RACK UNIT 반환
        function getDefaultRackUnit(partNumber) {
            if (!partNumber) return null;
            
            // 예외: 49560-DO000 파트만 RACK UNIT = 64
            if (partNumber === '49560-DO000') {
                return 64;
            }
            
            // 49560으로 시작하는 파트: RACK UNIT = 40
            if (partNumber.startsWith('49560')) {
                return 40;
            }
            
            // 49600 또는 49601로 시작하는 파트: RACK UNIT = 50
            if (partNumber.startsWith('49600') || partNumber.startsWith('49601')) {
                return 50;
            }
            
            return null;
        }

        // 파트별 시스템 재고 조회
        async function loadSystemStockForPart(partNumber) {
            if (!supabaseClient || !partNumber) return Promise.resolve();
            
            // 이미 조회한 경우 캐시된 값 반환
            if (systemStocks[partNumber] !== undefined) {
                return Promise.resolve();
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('inventory')
                    .select('current_stock')
                    .eq('part_number', partNumber)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                systemStocks[partNumber] = data ? data.current_stock : 0;
                return Promise.resolve();
            } catch (error) {
                console.error('시스템 재고 조회 오류:', error);
                systemStocks[partNumber] = 0;
                return Promise.resolve();
            }
        }

        // 행별 합계 계산
        function calculateRowTotal(rowId) {
            const row = document.getElementById(rowId);
            if (!row) return;
            
            // 파트 번호에 따라 자동으로 INNER/REAR 구분하여 UNIT 결정
            const partNumber = row.dataset.partNumber;
            let boxUnit = 0;
            let rackUnit = 0;
            
            if (partNumber && partNumber.startsWith('49560')) {
                boxUnit = 84; // INNER 박스 UNIT
                rackUnit = partNumber === '49560-DO000' ? 64 : 40; // INNER 렉 UNIT
            } else if (partNumber && (partNumber.startsWith('49600') || partNumber.startsWith('49601'))) {
                boxUnit = 80; // REAR 박스 UNIT
                rackUnit = 50; // REAR 렉 UNIT
            }
            
            // 박스 5개 합계 계산
            let boxTotal = 0;
            for (let i = 1; i <= 5; i++) {
                const boxQty = parseFloat(row.querySelector(`[data-type="box${i}"]`)?.value) || 0;
                boxTotal += boxUnit * boxQty;
            }
            
            // 렉 3개 합계 계산
            let rackTotal = 0;
            for (let i = 1; i <= 3; i++) {
                const rackQty = parseFloat(row.querySelector(`[data-type="rack${i}"]`)?.value) || 0;
                rackTotal += rackUnit * rackQty;
            }
            
            // 잔량
            const remaining = parseFloat(row.querySelector('[data-type="remaining"]')?.value) || 0;
            
            // 각 항목별 합계 표시
            const boxTotalEl = row.querySelector('[data-type="box-total"]');
            if (boxTotalEl) {
                boxTotalEl.textContent = boxTotal.toLocaleString();
            }
            
            const rackTotalEl = row.querySelector('[data-type="rack-total"]');
            if (rackTotalEl) {
                rackTotalEl.textContent = rackTotal.toLocaleString();
            }
            
            // 총 합계
            const total = boxTotal + rackTotal + remaining;
            
            // 총합계 표시
            const totalEl = row.querySelector('[data-type="total"]');
            if (totalEl) {
                totalEl.textContent = total.toLocaleString();
            }
            
            // 파트 번호 셀 배경색 업데이트 (수량을 샜으면 색상 표시)
            const partCell = document.getElementById(`part-cell-${rowId}`);
            if (partCell) {
                if (total > 0) {
                    partCell.style.backgroundColor = '#dbeafe'; // 파란색 배경
                    partCell.style.borderLeft = '3px solid #3b82f6';
                } else {
                    partCell.style.backgroundColor = '';
                    partCell.style.borderLeft = '';
                }
            }
            
            // 시스템 재고와 차이 표시 업데이트
            if (partNumber) {
                updateRowStockDisplay(row.id, partNumber);
            }
            
            // 요약 업데이트
        }


        // 요약 업데이트
        function updateSummary() {
            const rows = document.querySelectorAll('.table-row');
            let totalParts = 0;
            let totalQuantity = 0;
            let completedParts = 0;
            let totalPartRows = 0;
            
            rows.forEach(row => {
                // 헤더 행은 건너뛰기
                if (row.classList.contains('bg-blue-100') || row.classList.contains('bg-green-100') || row.classList.contains('bg-gray-100')) {
                    return;
                }
                
                totalPartRows++;
                const totalEl = row.querySelector('[data-type="total"]');
                
                if (totalEl) {
                    const total = parseFloat(totalEl.textContent.replace(/,/g, '')) || 0;
                    if (total > 0) {
                        totalParts++;
                        completedParts++;
                        totalQuantity += total;
                    }
                }
            });
            
            const summaryPartCountEl = document.getElementById('summaryPartCount');
            const summaryTotalQuantityEl = document.getElementById('summaryTotalQuantity');
            const progressPercentageEl = document.getElementById('progressPercentage');
            const progressBarEl = document.getElementById('progressBar');
            const progressTextEl = document.getElementById('progressText');
            
            if (summaryPartCountEl) {
                summaryPartCountEl.textContent = totalParts;
            }
            if (summaryTotalQuantityEl) {
                summaryTotalQuantityEl.textContent = totalQuantity.toLocaleString();
            }
            
            // 진행률 업데이트
            if (totalPartRows > 0) {
                const progressPercentage = Math.round((completedParts / totalPartRows) * 100);
                if (progressPercentageEl) {
                    progressPercentageEl.textContent = `${progressPercentage}%`;
                }
                if (progressBarEl) {
                    progressBarEl.style.width = `${progressPercentage}%`;
                }
                if (progressTextEl) {
                    progressTextEl.textContent = `${completedParts} / ${totalPartRows} 파트 완료`;
                }
            }
        }

        // 행 하이라이트
        function highlightRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.style.backgroundColor = '#eff6ff';
                row.style.boxShadow = '0 0 12px rgba(59, 130, 246, 0.4)';
                row.style.transition = 'all 0.2s';
                // 스크롤하여 행이 보이도록
                row.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // 행 하이라이트 제거
        function unhighlightRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.style.backgroundColor = '';
                row.style.boxShadow = '';
            }
        }

        // 수량 조절 함수
        function adjustQuantity(rowId, inputType, change) {
            const input = document.getElementById(`${inputType}-${rowId}`);
            if (!input) return;
            
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, currentValue + change);
            input.value = newValue;
            
            // 입력 이벤트 트리거하여 계산 실행
            input.dispatchEvent(new Event('input', { bubbles: true }));
            
            // 포커스 유지
            input.focus();
        }
        
        // 입력 필드 간 이동 처리
        function handleInputKeydown(event, rowId, nextType) {
            if (event.key === 'Enter' || event.key === 'Tab') {
                event.preventDefault();
                
                if (!nextType) {
                    // 다음 행의 첫 번째 입력 필드로 이동
                    const currentRow = document.getElementById(rowId);
                    let nextRow = currentRow.nextElementSibling;
                    
                    // 헤더 행 건너뛰기
                    while (nextRow && (nextRow.classList.contains('bg-blue-100') || nextRow.classList.contains('bg-green-100') || nextRow.classList.contains('bg-gray-100'))) {
                        nextRow = nextRow.nextElementSibling;
                    }
                    
                    if (nextRow) {
                        const firstInput = nextRow.querySelector('input[type="number"]');
                        if (firstInput) {
                            setTimeout(() => {
                                firstInput.focus();
                                firstInput.select();
                            }, 50);
                        }
                    }
                    return;
                }
                
                // nextType이 'box-total'이나 'rack-total'이면 다음 입력 필드로 이동
                let nextInput = null;
                if (nextType === 'box-total') {
                    nextInput = document.querySelector(`[data-row="${rowId}"][data-type="rack1"]`);
                } else if (nextType === 'rack-total') {
                    nextInput = document.querySelector(`[data-row="${rowId}"][data-type="remaining"]`);
                } else {
                    nextInput = document.querySelector(`[data-row="${rowId}"][data-type="${nextType}"]`);
                }
                
                if (nextInput) {
                    setTimeout(() => {
                        nextInput.focus();
                        nextInput.select();
                    }, 50);
                }
            }
        }

        // 전체 행 삭제 (모든 입력값 초기화)
        function clearAllRows() {
            if (confirm('모든 입력값을 초기화하시겠습니까?')) {
                resetCalculatorForm();
            }
        }
        
        // 계산기 폼 초기화 (확인 없이)
        function resetCalculatorForm() {
            const rows = document.querySelectorAll('.table-row');
            rows.forEach(row => {
                // 헤더 행은 건너뛰기
                if (row.classList.contains('bg-blue-100') || row.classList.contains('bg-green-100') || row.classList.contains('bg-gray-100')) {
                    return;
                }
                
                // 모든 입력 필드 초기화
                const inputs = row.querySelectorAll('input[type="number"]');
                inputs.forEach(input => {
                    // 모든 수량 필드는 빈 값으로 초기화
                    input.value = '';
                });
                
                // 합계 재계산
                if (row.id) {
                    calculateRowTotal(row.id);
                }
            });
            
            // 요약 정보 업데이트
            
            // 세션 선택 초기화 (선택 사항)
            // selectedSessionId는 유지하여 같은 세션에 계속 추가할 수 있도록 함
        }

        // 파트 선택 시
        async function onPartSelected() {
            const select = document.getElementById('partNumberSelect');
            const partNumber = select.value;
            
            if (!partNumber) {
                currentPartNumber = '';
                document.getElementById('partInfo').classList.add('hidden');
                document.getElementById('differenceCard').classList.add('hidden');
                return;
            }
            
            currentPartNumber = partNumber;
            
            // 파트 정보 표시
            const part = allParts.find(p => p.part_number === partNumber);
            if (part) {
                const partInfo = document.getElementById('partInfo');
                partInfo.classList.remove('hidden');
                partInfo.innerHTML = `
                    <strong>${part.part_number}</strong><br>
                    ${part.description || part.category || ''}
                `;
            }
            
            // 시스템 재고 조회
            await loadSystemStock(partNumber);
            
            // 계산 업데이트
            calculateTotal();
        }

        // 시스템 재고 조회
        async function loadSystemStock(partNumber) {
            if (!supabaseClient || !partNumber) return;
            
            try {
                const { data, error } = await supabaseClient
                    .from('inventory')
                    .select('current_stock')
                    .eq('part_number', partNumber)
                    .single();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                systemStock = data ? data.current_stock : 0;
                updateDifferenceDisplay();
            } catch (error) {
                console.error('시스템 재고 조회 오류:', error);
                systemStock = 0;
                updateDifferenceDisplay();
            }
        }

        // 박스 행 추가
        function addBoxRow() {
            const container = document.getElementById('boxRows');
            const rowId = `box_${boxRowCount++}`;
            const row = document.createElement('div');
            row.className = 'item-row';
            row.id = rowId;
            row.innerHTML = `
                <input type="number" class="input-field" placeholder="박스 수량" min="0" value="0" 
                       oninput="calculateTotal()" data-type="box">
                <button onclick="removeRow('${rowId}')" class="btn btn-danger btn-sm">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(row);
        }

        // 잔량 행 추가
        function addRemainingRow() {
            const container = document.getElementById('remainingRows');
            const rowId = `remaining_${remainingRowCount++}`;
            const row = document.createElement('div');
            row.className = 'item-row';
            row.id = rowId;
            row.innerHTML = `
                <input type="number" class="input-field" placeholder="잔량" min="0" value="0" 
                       oninput="calculateTotal()" data-type="remaining">
                <button onclick="removeRow('${rowId}')" class="btn btn-danger btn-sm">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(row);
        }

        // 렉 행 추가
        function addRackRow() {
            const container = document.getElementById('rackRows');
            const rowId = `rack_${rackRowCount++}`;
            const row = document.createElement('div');
            row.className = 'item-row';
            row.id = rowId;
            row.innerHTML = `
                <input type="number" class="input-field" placeholder="렉 수량" min="0" value="0" 
                       oninput="calculateTotal()" data-type="rack">
                <button onclick="removeRow('${rowId}')" class="btn btn-danger btn-sm">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(row);
        }

        // 행 제거
        function removeRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
                calculateTotal();
            }
        }

        // 총 수량 계산
        function calculateTotal() {
            // 박스 수량 합계
            const boxInputs = document.querySelectorAll('input[data-type="box"]');
            let boxTotal = 0;
            boxInputs.forEach(input => {
                boxTotal += parseInt(input.value) || 0;
            });
            
            // 잔량 합계
            const remainingInputs = document.querySelectorAll('input[data-type="remaining"]');
            let remainingTotal = 0;
            remainingInputs.forEach(input => {
                remainingTotal += parseInt(input.value) || 0;
            });
            
            // 렉 수량 합계
            const rackInputs = document.querySelectorAll('input[data-type="rack"]');
            let rackTotal = 0;
            rackInputs.forEach(input => {
                rackTotal += parseInt(input.value) || 0;
            });
            
            const total = boxTotal + remainingTotal + rackTotal;
            
            // 결과 표시
            const resultCard = document.getElementById('resultCard');
            const totalQuantity = document.getElementById('totalQuantity');
            const calculationDetail = document.getElementById('calculationDetail');
            
            totalQuantity.textContent = total.toLocaleString();
            
            // 계산 상세
            const details = [];
            if (boxTotal > 0) {
                details.push(`박스: ${boxTotal.toLocaleString()}`);
            }
            if (remainingTotal > 0) {
                details.push(`잔량: ${remainingTotal.toLocaleString()}`);
            }
            if (rackTotal > 0) {
                details.push(`렉: ${rackTotal.toLocaleString()}`);
            }
            calculationDetail.textContent = details.length > 0 ? details.join(' + ') : '';
            
            if (total > 0 || boxInputs.length > 0 || remainingInputs.length > 0 || rackInputs.length > 0) {
                resultCard.classList.remove('hidden');
            } else {
                resultCard.classList.add('hidden');
            }
            
            // 차이 표시 업데이트
            updateDifferenceDisplay(total);
        }

        // 차이 표시 업데이트
        function updateDifferenceDisplay(physicalStock = null) {
            if (physicalStock === null) {
                const totalText = document.getElementById('totalQuantity').textContent.replace(/,/g, '');
                physicalStock = parseInt(totalText) || 0;
            }
            
            const differenceCard = document.getElementById('differenceCard');
            const systemStockEl = document.getElementById('systemStock');
            const physicalStockEl = document.getElementById('physicalStock');
            const differenceValueEl = document.getElementById('differenceValue');
            
            if (currentPartNumber && systemStock !== undefined) {
                systemStockEl.textContent = systemStock.toLocaleString();
                physicalStockEl.textContent = physicalStock.toLocaleString();
                
                const difference = physicalStock - systemStock;
                differenceValueEl.textContent = difference > 0 ? `+${difference.toLocaleString()}` : difference.toLocaleString();
                
                // 차이에 따라 색상 변경
                if (difference > 0) {
                    differenceCard.classList.remove('difference-negative');
                    differenceValueEl.className = 'text-xl font-bold text-green-600';
                } else if (difference < 0) {
                    differenceCard.classList.add('difference-negative');
                    differenceValueEl.className = 'text-xl font-bold text-red-600';
                } else {
                    differenceCard.classList.remove('difference-negative');
                    differenceValueEl.className = 'text-xl font-bold text-gray-600';
                }
                
                differenceCard.classList.remove('hidden');
            } else {
                differenceCard.classList.add('hidden');
            }
        }

        // 현재 입력 초기화
        function clearCurrent() {
            document.getElementById('partNumberSelect').value = '';
            document.getElementById('boxRows').innerHTML = '';
            document.getElementById('remainingRows').innerHTML = '';
            document.getElementById('rackRows').innerHTML = '';
            document.getElementById('partInfo').classList.add('hidden');
            document.getElementById('resultCard').classList.add('hidden');
            document.getElementById('differenceCard').classList.add('hidden');
            currentPartNumber = '';
            systemStock = 0;
            boxRowCount = 0;
            remainingRowCount = 0;
            rackRowCount = 0;
            
            // 초기 행 하나씩 추가
            addBoxRow();
            addRemainingRow();
            addRackRow();
        }

        // 파트를 목록에 추가
        function addPartToList() {
            if (!currentPartNumber) {
                alert('파트를 선택해주세요.');
                return;
            }
            
            const totalText = document.getElementById('totalQuantity').textContent.replace(/,/g, '');
            const total = parseInt(totalText) || 0;
            
            if (total === 0) {
                alert('총 수량이 0입니다.');
                return;
            }
            
            // 박스, 잔량, 렉 데이터 수집
            const boxes = [];
            document.querySelectorAll('input[data-type="box"]').forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) boxes.push(qty);
            });
            
            const remainings = [];
            document.querySelectorAll('input[data-type="remaining"]').forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) remainings.push(qty);
            });
            
            const racks = [];
            document.querySelectorAll('input[data-type="rack"]').forEach(input => {
                const qty = parseInt(input.value) || 0;
                if (qty > 0) racks.push(qty);
            });
            
            // 파트 정보 가져오기
            const part = allParts.find(p => p.part_number === currentPartNumber);
            
            // 세션 날짜 가져오기
            const sessionDate = document.getElementById('sessionDate').value || new Date().toISOString().split('T')[0];
            
            // 목록에 추가
            const partItem = {
                id: Date.now(),
                partNumber: currentPartNumber,
                partDescription: part ? (part.description || part.category || '') : '',
                quantity: total,
                systemStock: systemStock,
                difference: total - systemStock,
                sessionDate: sessionDate, // 세션 날짜 포함
                calculation: {
                    boxes: boxes,
                    remainings: remainings,
                    racks: racks
                },
                timestamp: new Date().toLocaleString('ko-KR')
            };
            
            partsList.push(partItem);
            renderPartsList();
            
            // 현재 입력 초기화
            clearCurrent();
        }

        // 파트 목록 렌더링
        function renderPartsList() {
            const container = document.getElementById('partsList');
            const countEl = document.getElementById('partsCount');
            
            countEl.textContent = `${partsList.length}개`;
            
            if (partsList.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4" data-i18n="no_parts_added">추가된 파트가 없습니다</p>';
                return;
            }
            
            container.innerHTML = partsList.map((item, index) => `
                <div class="bg-white p-3 rounded mb-2 border-l-4 ${item.difference > 0 ? 'border-green-500' : item.difference < 0 ? 'border-red-500' : 'border-gray-300'}">
                    <div class="flex items-center justify-between mb-2">
                        <div>
                            <strong class="text-gray-800">${item.partNumber}</strong>
                            ${item.partDescription ? `<span class="text-sm text-gray-600 ml-2">${item.partDescription}</span>` : ''}
                        </div>
                        <button onclick="removePartFromList(${item.id})" class="btn btn-danger btn-sm">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-3 gap-2 text-sm">
                        <div>
                            <span class="text-gray-600" data-i18n="system_stock">시스템:</span>
                            <span class="font-semibold">${item.systemStock.toLocaleString()}</span>
                        </div>
                        <div>
                            <span class="text-gray-600" data-i18n="physical_stock">실사:</span>
                            <span class="font-semibold">${item.quantity.toLocaleString()}</span>
                        </div>
                        <div>
                            <span class="text-gray-600" data-i18n="difference">차이:</span>
                            <span class="font-semibold ${item.difference > 0 ? 'text-green-600' : item.difference < 0 ? 'text-red-600' : 'text-gray-600'}">
                                ${item.difference > 0 ? '+' : ''}${item.difference.toLocaleString()}
                            </span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${item.timestamp}</div>
                </div>
            `).join('');
        }

        // 목록에서 파트 제거
        function removePartFromList(id) {
            partsList = partsList.filter(item => item.id !== id);
            renderPartsList();
        }

        // 세션 정보 업데이트
        function updateSessionInfo() {
            const sessionDate = document.getElementById('sessionDate').value;
            if (sessionDate) {
                // 날짜가 변경되면 기존 파트 목록 초기화 여부 확인
                if (partsList.length > 0) {
                    const firstPartDate = partsList[0].sessionDate;
                    if (firstPartDate && firstPartDate !== sessionDate) {
                        if (confirm('날짜가 변경되었습니다. 기존 파트 목록을 초기화하시겠습니까?')) {
                            partsList = [];
                            renderPartsList();
                        } else {
                            // 날짜를 원래대로 되돌림
                            document.getElementById('sessionDate').value = firstPartDate;
                            return;
                        }
                    }
                }
            }
        }

        // 모든 파트를 실사 재고에 저장
        async function saveAllToPhysicalInventory() {
            const sessionDate = document.getElementById('sessionDate').value;
            
            if (!sessionDate) {
                alert('날짜를 선택해주세요.');
                return;
            }
            
            // 테이블에서 모든 행 데이터 수집 (입력이 있는 파트만)
            const rows = document.querySelectorAll('.table-row');
            const parts = [];
            
            for (const row of rows) {
                // 헤더 행은 건너뛰기
                if (row.classList.contains('bg-blue-100') || row.classList.contains('bg-green-100') || row.classList.contains('bg-gray-100')) {
                    continue;
                }
                
                const partNumber = row.dataset.partNumber;
                if (!partNumber) continue;
                
                // 시스템 재고 조회
                if (!systemStocks[partNumber]) {
                    await loadSystemStockForPart(partNumber);
                }
                
                // 입력값 수집
                // 파트 번호에 따라 자동으로 INNER/REAR 구분하여 UNIT 결정
                let boxUnit = 0;
                let rackUnit = 0;
                if (partNumber && partNumber.startsWith('49560')) {
                    boxUnit = 84; // INNER 박스 UNIT
                    rackUnit = partNumber === '49560-DO000' ? 64 : 40; // INNER 렉 UNIT
                } else if (partNumber && (partNumber.startsWith('49600') || partNumber.startsWith('49601'))) {
                    boxUnit = 80; // REAR 박스 UNIT
                    rackUnit = 50; // REAR 렉 UNIT
                }
                
                // 박스 5개 합계 계산
                let boxTotal = 0;
                const boxes = [];
                for (let i = 1; i <= 5; i++) {
                    const boxQty = parseFloat(row.querySelector(`[data-type="box${i}"]`)?.value) || 0;
                    const boxValue = boxUnit * boxQty;
                    boxTotal += boxValue;
                    if (boxValue > 0) boxes.push(boxValue);
                }
                
                // 렉 3개 합계 계산
                let rackTotal = 0;
                const racks = [];
                for (let i = 1; i <= 3; i++) {
                    const rackQty = parseFloat(row.querySelector(`[data-type="rack${i}"]`)?.value) || 0;
                    const rackValue = rackUnit * rackQty;
                    rackTotal += rackValue;
                    if (rackValue > 0) racks.push(rackValue);
                }
                
                const remaining = parseFloat(row.querySelector('[data-type="remaining"]')?.value) || 0;
                
                // 합계 계산
                const total = boxTotal + rackTotal + remaining;
                
                // 숫자를 하나도 세지 않은 파트는 제외 (실사재고를 하지 않은 것으로 처리)
                // 0으로 저장하지 않고, 해당 파트는 실사재고 목록에 포함되지 않음
                if (total === 0) continue;
                
                // 파트 정보 가져오기
                const part = allParts.find(p => p.part_number === partNumber);
                
                // 계산 상세 정보
                const remainings = remaining > 0 ? [remaining] : [];
                
                parts.push({
                    partNumber: partNumber,
                    partDescription: part ? (part.description || part.category || '') : '',
                    quantity: total,
                    systemStock: systemStocks[partNumber] || 0,
                    difference: total - (systemStocks[partNumber] || 0),
                    sessionDate: sessionDate,
                    calculation: {
                        boxes: boxes,
                        remainings: remainings,
                        racks: racks
                    }
                });
            }
            
            if (parts.length === 0) {
                alert('저장할 파트가 없습니다. 최소 하나 이상의 파트에 수량을 입력해주세요.');
                return;
            }
            
            // 세션명 가져오기
            const sessionNameInput = document.getElementById('sessionName');
            let sessionName = sessionNameInput ? sessionNameInput.value.trim() : '';
            
            // 세션명이 없으면 자동 생성
            if (!sessionName) {
                const dateObj = new Date(sessionDate);
                sessionName = `계산기 실사 ${dateObj.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' })}`;
            }
            
            // Supabase 클라이언트 확인
            if (!supabaseClient) {
                alert('Supabase 연결에 실패했습니다. 페이지를 새로고침해주세요.');
                return;
            }
            
            // 저장 확인
            if (!confirm(`총 ${parts.length}개 파트를 저장하시겠습니까?\n날짜: ${sessionDate}\n세션: ${sessionName}`)) {
                return;
            }
            
            // 로딩 표시
            const saveBtn = document.querySelector('button[onclick="saveAllToPhysicalInventory()"]');
            const originalText = saveBtn?.innerHTML;
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>저장 중...';
            }
            
            try {
                // 1. 세션 처리 (기존 세션이 있으면 업데이트, 없으면 생성)
                let sessionId = selectedSessionId ? parseInt(selectedSessionId) : null;
                
                if (sessionId) {
                    // 기존 세션 업데이트
                    const { data: updatedSession, error: updateError } = await supabaseClient
                        .from('physical_inventory_sessions')
                        .update({
                            session_date: sessionDate,
                            notes: sessionName
                        })
                        .eq('id', sessionId)
                        .select()
                        .single();
                    
                    if (updateError) {
                        throw new Error(`세션 업데이트 실패: ${updateError.message}`);
                    }
                } else {
                    // 새 세션 생성
                    const { data: newSession, error: sessionError } = await supabaseClient
                        .from('physical_inventory_sessions')
                        .insert({
                            session_date: sessionDate,
                            status: 'PENDING',
                            notes: sessionName
                        })
                        .select()
                        .single();
                    
                    if (sessionError) {
                        throw new Error(`세션 생성 실패: ${sessionError.message}`);
                    }
                    if (!newSession || !newSession.id) {
                        throw new Error('세션 생성 결과를 받지 못했습니다.');
                    }
                    sessionId = newSession.id;
                }
                
                // 2. 기존 세션의 경우 기존 항목 삭제
                if (sessionId) {
                    const { error: deleteError } = await supabaseClient
                        .from('physical_inventory_items')
                        .delete()
                        .eq('session_id', sessionId);
                    
                    if (deleteError) {
                        console.warn('기존 항목 삭제 오류:', deleteError);
                    }
                }
                
                // 3. 실사 항목 및 거래 내역 생성
                const inventoryItems = [];
                const transactions = [];
                
                for (const part of parts) {
                    const difference = part.difference;
                    
                    // 실사 항목 생성
                    inventoryItems.push({
                        session_id: sessionId,
                        part_number: part.partNumber,
                        system_stock: part.systemStock,
                        physical_stock: part.quantity,
                        notes: `계산기 - ${part.calculation ? JSON.stringify(part.calculation) : ''} (차이: ${difference > 0 ? '+' : ''}${difference})`
                    });
                    
                    // 차이가 있으면 ADJUSTMENT 거래 내역 추가
                    // 주의: difference는 양수(증가) 또는 음수(감소)일 수 있습니다.
                    // DB 제약 조건이 ADJUSTMENT의 경우 음수도 허용하도록 수정되어야 합니다.
                    if (difference !== 0) {
                        transactions.push({
                            transaction_date: sessionDate,
                            part_number: part.partNumber,
                            transaction_type: 'ADJUSTMENT',
                            quantity: difference, // 양수면 증가, 음수면 감소
                            reference_id: `PHYSICAL_INV_SESSION_${sessionId}`,
                            notes: `재고 실사 조정 (계산기) - 세션: ${sessionName}`
                        });
                    }
                }
                
                // 4. 실사 항목 저장 (배치 처리)
                if (inventoryItems.length > 0) {
                    const BATCH_SIZE = 1000;
                    for (let i = 0; i < inventoryItems.length; i += BATCH_SIZE) {
                        const batch = inventoryItems.slice(i, i + BATCH_SIZE);
                        const { error: itemsError } = await supabaseClient
                            .from('physical_inventory_items')
                            .insert(batch);
                        
                        if (itemsError) {
                            throw new Error(`실사 항목 저장 실패: ${itemsError.message}`);
                        }
                    }
                }
                
                // 5. inventory_transactions에 거래 내역 추가 (배치 처리)
                // 주의: DB 트리거(track_inventory_movement)가 자동으로 inventory 테이블을 업데이트하므로
                // 여기서는 수동으로 inventory를 업데이트하지 않습니다.
                if (transactions.length > 0) {
                    const BATCH_SIZE = 1000;
                    for (let i = 0; i < transactions.length; i += BATCH_SIZE) {
                        const batch = transactions.slice(i, i + BATCH_SIZE);
                        const { error: transError } = await supabaseClient
                            .from('inventory_transactions')
                            .insert(batch);
                        
                        if (transError) {
                            throw new Error(`거래 내역 저장 실패: ${transError.message}`);
                        }
                    }
                }
                
                // 6. inventory 테이블 업데이트는 DB 트리거(track_inventory_movement)가 자동으로 처리합니다.
                // inventory_transactions에 ADJUSTMENT를 삽입하면 트리거가 자동으로 inventory.current_stock을 업데이트합니다.
                // 따라서 여기서는 수동으로 업데이트하지 않습니다. (중복 업데이트 방지)
                
                // 저장 성공
                alert(`✅ 저장 완료!\n총 ${parts.length}개 파트가 저장되었습니다.\n날짜: ${sessionDate}\n세션: ${sessionName}`);
                
                // 화면 초기화 (확인 없이)
                resetCalculatorForm();
                
            } catch (error) {
                console.error('저장 오류:', error);
                alert(`❌ 저장 실패: ${error.message}`);
            } finally {
                // 버튼 상태 복원
                if (saveBtn) {
                    saveBtn.disabled = false;
                    if (originalText) {
                        saveBtn.innerHTML = originalText;
                    }
                }
            }
        }

        // 페이지 로드 후 Supabase 초기화 시도 (physical-inventory.html과 동일한 방식)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', async function() {
                if (!initSupabase()) {
                    alert('Supabase 연결에 실패했습니다. 페이지를 새로고침해주세요.');
                    return;
                }
                
                // i18n 초기화
                if (window.i18n) {
                    window.i18n.init();
                }
                
                // 날짜 기본값 설정
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('sessionDate').value = today;
                
                // 날짜 변경 시 세션 목록 로드 및 세션명 자동 생성
                await loadSessionsForDate();
                generateAutoSessionName();
                
                // 날짜 변경 시 세션명 자동 재생성
                document.getElementById('sessionDate').addEventListener('change', function() {
                    if (!selectedSessionId) {
                        generateAutoSessionName();
                    }
                });
                
                // 파트 목록 로드
                await loadPartsList();
                
                // 모든 파트를 테이블에 미리 로드
                await loadAllPartsToTable();
            });
        } else {
            // 이미 로드된 경우
            (async function() {
                if (!initSupabase()) {
                    alert('Supabase 연결에 실패했습니다. 페이지를 새로고침해주세요.');
                    return;
                }
                
                // i18n 초기화
                if (window.i18n) {
                    window.i18n.init();
                }
                
                // 날짜 기본값 설정
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('sessionDate').value = today;
                
                // 날짜 변경 시 세션 목록 로드 및 세션명 자동 생성
                await loadSessionsForDate();
                generateAutoSessionName();
                
                // 날짜 변경 시 세션명 자동 재생성
                document.getElementById('sessionDate').addEventListener('change', function() {
                    if (!selectedSessionId) {
                        generateAutoSessionName();
                    }
                });
                
                // 파트 목록 로드
                await loadPartsList();
                
                // 모든 파트를 테이블에 미리 로드
                await loadAllPartsToTable();
            })();
        }
    </script>
</body>
</html>
