<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title data-i18n="outbound_title">출고 작업 - 이화 - 서한 시스템</title>
    
    <!-- Supabase 클라이언트 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- i18n 스크립트 -->
    <script src="../js/i18n.js"></script>
    
    <!-- Supabase 설정 -->
    <script src="../js/config.js"></script>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- 키보드 숨김 기능 -->
    <script>
        // 강화된 키보드 숨김 함수
        function hideKeyboard() {
            // 1. 모든 입력 필드에서 포커스 제거
            const inputs = document.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.blur();
                input.setAttribute('readonly', 'readonly');
                input.setAttribute('tabindex', '-1');
                setTimeout(() => {
                    input.removeAttribute('readonly');
                    input.removeAttribute('tabindex');
                }, 100);
            });
            
            // 2. 화면을 터치하여 키보드 숨김
            document.body.click();
            
            // 3. 모바일에서 키보드 숨김을 위한 추가 처리
            if (window.scrollTo) {
                window.scrollTo(0, 0);
            }
            
            // 4. 가상 키보드 숨김을 위한 추가 처리
            document.activeElement && document.activeElement.blur();
            
            // 5. 포커스를 body로 이동
            document.body.focus();
            
            // 6. 입력 필드 비활성화 후 재활성화
            inputs.forEach(input => {
                input.disabled = true;
                setTimeout(() => {
                    input.disabled = false;
                }, 50);
            });
        }
        
        // 입력 필드 포커스 방지 함수
        function preventInputFocus() {
            // 바코드 입력 필드와 드롭다운, 날짜 선택은 완전히 제외
            const allowedIds = ['barcodeInput', 'shiftSelect', 'asPartSelect', 'dateSelect'];
            
            // 모든 입력 요소를 찾아서 허용된 ID가 아닌 것만 제어
            const allInputs = document.querySelectorAll('input, textarea, select');
            allInputs.forEach(input => {
                // 허용된 ID는 완전히 제외
                if (allowedIds.includes(input.id)) {
                    return;
                }
                
                // input[type="text"], input[type="number"], textarea만 포커스 방지
                if (input.tagName === 'INPUT' && 
                    (input.type === 'text' || input.type === 'number') ||
                    input.tagName === 'TEXTAREA') {
                    
                    // 포커스 이벤트 방지
                    input.addEventListener('focus', function(e) {
                        e.preventDefault();
                        e.target.blur();
                        hideKeyboard();
                    });
                    
                    // 클릭 이벤트 방지
                    input.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.target.blur();
                        hideKeyboard();
                    });
                    
                    // 터치 이벤트 방지
                    input.addEventListener('touchstart', function(e) {
                        e.preventDefault();
                        e.target.blur();
                        hideKeyboard();
                    });
                }
            });
            
            // 허용된 요소들은 키보드만 숨김
            allowedIds.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('focus', function(e) {
                        setTimeout(hideKeyboard, 100);
                    });
                    
                    element.addEventListener('change', function(e) {
                        setTimeout(hideKeyboard, 100);
                    });
                }
            });
        }
        
        // 바코드 입력 필드 특별 처리
        function setupBarcodeInput() {
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput) {
                // 바코드 입력 시 키보드 숨김 (입력 완료 후)
                barcodeInput.addEventListener('input', function() {
                    // 입력이 완료된 후 키보드 숨김
                    setTimeout(hideKeyboard, 500);
                });
                
                // 바코드 입력 완료 시 키보드 숨김
                barcodeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        setTimeout(hideKeyboard, 200);
                    }
                });
                
                // 바코드 입력 필드 포커스는 자유롭게 허용
                // (스캔을 위해 포커스 제어하지 않음)
            }
        }
        
        // 페이지 로드 시 키보드 숨김
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(hideKeyboard, 100);
            setTimeout(hideKeyboard, 500);
            setTimeout(hideKeyboard, 1000);
            setTimeout(preventInputFocus, 200);
            setTimeout(setupBarcodeInput, 300);
        });
        
        // 화면 터치 시 키보드 숨김
        document.addEventListener('touchstart', function(e) {
            if (!e.target.matches('input, textarea, select, button')) {
                hideKeyboard();
            }
        });
        
        // 포커스 이벤트 시 키보드 숨김
        document.addEventListener('focusin', function(e) {
            if (!e.target.matches('input, textarea, select')) {
                hideKeyboard();
            }
        });
        
        // 키보드 이벤트 시 키보드 숨김
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideKeyboard();
            }
        });
    </script>
    
    <script>
        // Tailwind 설정은 CDN 로드 후에 실행
        function configureTailwind() {
            if (window.tailwind) {
                tailwind.config = {
                    theme: {
                        extend: {
                            colors: {
                                primary: '#3B82F6',
                                secondary: '#64748B',
                                success: '#10B981',
                                warning: '#F59E0B',
                                danger: '#EF4444'
                            },
                            animation: {
                                'fade-in': 'fadeIn 0.5s ease-in-out',
                                'slide-up': 'slideUp 0.5s ease-out',
                                'bounce-in': 'bounceIn 0.6s ease-out',
                                'float': 'float 3s ease-in-out infinite',
                                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                            },
                            keyframes: {
                                fadeIn: {
                                    '0%': { opacity: '0' },
                                    '100%': { opacity: '1' }
                                },
                                slideUp: {
                                    '0%': { transform: 'translateY(20px)', opacity: '0' },
                                    '100%': { transform: 'translateY(0)', opacity: '1' }
                                },
                                bounceIn: {
                                    '0%': { transform: 'scale(0.3)', opacity: '0' },
                                    '50%': { transform: 'scale(1.05)' },
                                    '70%': { transform: 'scale(0.9)' },
                                    '100%': { transform: 'scale(1)', opacity: '1' }
                                },
                                float: {
                                    '0%, 100%': { transform: 'translateY(0px)' },
                                    '50%': { transform: 'translateY(-10px)' }
                                }
                            }
                        }
                    }
                }
            } else {
                // CDN이 아직 로드되지 않았다면 잠시 후 다시 시도
                setTimeout(configureTailwind, 100);
            }
        }
        
        // 페이지 로드 시 Tailwind 설정
        document.addEventListener('DOMContentLoaded', configureTailwind);
    </script>
    <style>
        /* PDA 최적화 스타일 */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-button {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
            border: none;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .action-button:active::before {
            left: 100%;
        }
        
        .action-button:active {
            transform: scale(0.98);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }
        
        .dropdown-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .dropdown-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .scan-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
        }
        
        .scan-input:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
        }
        
        .main-menu-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            border-radius: 12px;
            padding: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
        }
        
        .main-menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .main-menu-btn:active {
            transform: scale(0.98);
        }
        
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .language-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 8px 16px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .language-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }
        
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: none;
        }
        
        .language-dropdown.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .language-option {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .language-option:last-child {
            border-bottom: none;
        }
        
        .language-option:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .language-option.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- 언어 선택기 -->
    <div class="language-selector">
        <button class="language-btn" onclick="toggleLanguageDropdown()">
            <i class="fas fa-globe mr-2"></i>
            <span id="currentLanguage">한국어</span>
            <i class="fas fa-chevron-down ml-2"></i>
        </button>
        <div class="language-dropdown" id="languageDropdown">
            <div class="language-option active" onclick="changeLanguage('ko')">
                <i class="fas fa-flag mr-2"></i><span data-i18n="korean">한국어</span>
            </div>
            <div class="language-option" onclick="changeLanguage('en')">
                <i class="fas fa-flag mr-2"></i><span data-i18n="english">English</span>
            </div>
            <div class="language-option" onclick="changeLanguage('es')">
                <i class="fas fa-flag mr-2"></i><span data-i18n="spanish">Español</span>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="glass-effect p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <button onclick="window.location.href='index.html'" class="main-menu-btn mr-3">
                    <i class="fas fa-home text-lg"></i>
                </button>
                <button onclick="hideKeyboard()" class="main-menu-btn mr-3" title="키보드 숨김">
                    <i class="fas fa-keyboard text-lg"></i>
                </button>
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center mr-3">
                    <i class="fas fa-arrow-up text-white text-lg"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white" data-i18n="outbound_title">출고 작업</h1>
                    <p class="text-xs text-white/80" data-i18n="outbound_subtitle">바코드 스캔 및 출고 등록</p>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
                    <i class="fas fa-user text-white text-sm"></i>
                </div>
                <div class="text-white/80 text-sm" id="currentTime">00:00:00</div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-4 space-y-6">
        <!-- Date and Shift Selection -->
        <div class="glass-card rounded-2xl p-6 animate-slide-up">
            <h2 class="text-lg font-bold text-gray-800 mb-4" data-i18n="date_shift_selection">날짜 및 차수 선택</h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="date">날짜</label>
                    <input type="date" id="dateSelect" class="dropdown-select">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="shift">차수</label>
                    <select id="shiftSelect" class="dropdown-select">
                        <option value="" data-i18n="select_shift">차수를 선택하세요</option>
                        <option value="1" data-i18n="shift_1">1차</option>
                        <option value="2" data-i18n="shift_2">2차</option>
                        <option value="3" data-i18n="shift_3">3차</option>
                        <option value="AS" data-i18n="shift_as">AS</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Confirmation Section -->
        <div id="confirmationSection" class="glass-card rounded-2xl p-6 animate-slide-up hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-check-circle text-red-600 text-xl mr-3"></i>
                    <div>
                        <h3 class="font-semibold text-red-800" data-i18n="all_parts_scanned">모든 파트 스캔 완료</h3>
                        <p class="text-sm text-red-700" data-i18n="quantity_confirmed">수량이 확인되었습니다. 출고를 등록하시겠습니까?</p>
                    </div>
                </div>
                <div class="flex space-x-3">
                    <button onclick="confirmOutbound()" class="action-button px-6 py-3 text-white">
                        <i class="fas fa-check mr-2"></i><span data-i18n="confirm">확정</span>
                    </button>
                    <button onclick="cancelOutbound()" class="action-button cancel-btn px-6 py-3 text-white">
                        <i class="fas fa-times mr-2"></i><span data-i18n="cancel">취소</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Scan Section -->
        <div id="scanSection" class="glass-card rounded-2xl p-6 animate-slide-up hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-4" data-i18n="barcode_scan">바코드 스캔</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="part_number_scan">파트 번호 스캔</label>
                    <input type="text" id="barcodeInput" class="scan-input w-full" 
                           data-i18n-placeholder="scan_barcode_placeholder"
                           placeholder="바코드를 스캔하거나 파트 번호를 입력하세요" autocomplete="off">
                </div>
                <div class="flex justify-end">
                    <button onclick="clearScan()" class="action-button cancel-btn px-6 py-3 text-white">
                        <i class="fas fa-times mr-2"></i><span data-i18n="clear">초기화</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- AS Manual Input Section (only visible for AS shift) -->
        <div id="asManualSection" class="glass-card rounded-2xl p-6 animate-slide-up hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-4" data-i18n="as_manual_input">AS 수동 입력</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="select_part_manual">파트 선택</label>
                    <select id="asPartSelect" class="form-control w-full">
                        <option value="" data-i18n="select_part_manual">파트를 선택하세요</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="quantity">수량</label>
                    <input type="number" id="asQuantityInput" class="form-control w-full" 
                           data-i18n-placeholder="quantity" placeholder="수량을 입력하세요" min="1">
                </div>
                <div class="flex space-x-3">
                    <button onclick="addAsPart()" class="action-button px-6 py-3 text-white flex-1">
                        <i class="fas fa-plus mr-2"></i><span data-i18n="add">추가</span>
                    </button>
                    <button onclick="clearAsInput()" class="action-button cancel-btn px-6 py-3 text-white flex-1">
                        <i class="fas fa-times mr-2"></i><span data-i18n="clear">초기화</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Parts List -->
        <div id="partsSection" class="glass-card rounded-2xl p-6 animate-slide-up hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-4" data-i18n="outbound_parts_list">출고 파트 목록</h2>
            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-600" data-i18n="part_number">파트 번호</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-600" data-i18n="scanned_quantity">스캔 수량</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-600">CART</th>
                            <th class="px-4 py-3 text-center text-sm font-medium text-gray-600" data-i18n="status">상태</th>
                        </tr>
                    </thead>
                    <tbody id="partsList" class="divide-y divide-gray-200">
                        <!-- 파트 목록이 여기에 동적으로 추가됩니다 -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Confirmation Section -->
        <div id="confirmationSection" class="glass-card rounded-2xl p-6 animate-slide-up hidden">
            <h2 class="text-lg font-bold text-gray-800 mb-4" data-i18n="outbound_registration">출고 등록</h2>
        </div>

    </main>

    <!-- 하단 고정 홈 버튼 -->
    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
        <button onclick="window.location.href='index.html'" 
                class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-4 rounded-full shadow-lg flex items-center space-x-2 transition-all duration-300 transform hover:scale-105">
            <i class="fas fa-home text-xl"></i>
            <span class="font-semibold" data-i18n="main_menu">메인 메뉴</span>
        </button>
    </div>

    <!-- Supabase 설정 및 스크립트 -->
    <script src="../js/config.js"></script>
    <script>
        // Supabase 클라이언트 초기화
        let supabase;
        let scannedParts = {};
        let currentDate = '';
        let currentShift = '';
        let scannedUniqueCodes = new Set();
        let scanCounts = {}; // 파트별 스캔 횟수 추적
        
        function initializeSupabase() {
            try {
                console.log('=== Supabase 초기화 시작 ===');
                console.log('window.getCurrentConfig 존재 여부:', !!window.getCurrentConfig);
                console.log('window.supabase 존재 여부:', !!window.supabase);
                
                if (!window.getCurrentConfig) {
                    console.error('getCurrentConfig 함수를 찾을 수 없습니다. config.js가 로드되었는지 확인하세요.');
                    console.log('window 객체 확인:', Object.keys(window).filter(key => key.includes('config')));
                    return false;
                }
                
                const config = window.getCurrentConfig();
                console.log('설정 로드됨:', config);
                console.log('config.url:', config.url);
                console.log('config.anonKey 길이:', config.anonKey ? config.anonKey.length : 'undefined');
                
                if (!window.supabase) {
                    console.error('Supabase 라이브러리가 로드되지 않았습니다.');
                    console.log('window 객체 확인:', Object.keys(window).filter(key => key.includes('supabase')));
                    return false;
                }
                
                console.log('Supabase 클라이언트 생성 시작...');
                supabase = window.supabase.createClient(config.url, config.anonKey);
                console.log('Supabase 클라이언트 초기화 성공');
                console.log('supabase 객체:', supabase);
                return true;
            } catch (error) {
                console.error('Supabase 클라이언트 초기화 실패:', error);
                console.error('오류 상세:', error.message, error.stack);
                return false;
            }
        }

        // 날짜 및 차수 선택 시 정보 업데이트
        function updateOutboundInfo() {
            const date = document.getElementById('dateSelect').value;
            const shift = document.getElementById('shiftSelect').value;
            
            console.log('updateOutboundInfo 호출됨:', { date, shift });
            
            currentDate = date;
            currentShift = shift;
            
            if (date && shift) {
                console.log('날짜와 차수가 모두 선택됨, 화면 업데이트 시작');
                
                // AS 차수인지 확인
                if (shift === 'AS') {
                    console.log('AS 차수 선택됨');
                    showAsManualSection();
                    loadMasterParts(); // 마스터 파트 목록 로드
                    // AS 차수일 때는 기존 출고 데이터를 로드하지 않음
                    scannedParts = {};
                } else {
                    console.log('일반 차수 선택됨:', shift);
                    hideAsManualSection();
                    document.getElementById('scanSection').classList.remove('hidden');
                    // 다른 차수일 때는 기존 출고 데이터 로드 (비동기)
                    loadOutboundParts().then(() => {
                        console.log('출고 파트 로드 완료');
                        // 파트 목록 렌더링
                        renderPartsList();
                    }).catch(error => {
                        console.error('출고 파트 로드 오류:', error);
                    });
                }
                
                document.getElementById('partsSection').classList.remove('hidden');
                
                // AS가 아닌 경우에만 바코드 입력창에 포커스
                if (shift !== 'AS') {
                    // 바코드 입력창이 표시되도록 강제로 설정
                    const scanSection = document.getElementById('scanSection');
                    if (scanSection) {
                        scanSection.classList.remove('hidden');
                    }
                    
                    setTimeout(() => {
                        const barcodeInput = document.getElementById('barcodeInput');
                        if (barcodeInput) {
                            barcodeInput.focus();
                            barcodeInput.select();
                            console.log('바코드 입력창에 포커스 설정됨');
                        } else {
                            console.log('바코드 입력창을 찾을 수 없음');
                        }
                    }, 300); // 시간을 더 늘림
                }
                
                console.log('화면 업데이트 완료');
            } else {
                console.log('날짜 또는 차수가 선택되지 않음, 화면 숨김');
                document.getElementById('scanSection').classList.add('hidden');
                document.getElementById('partsSection').classList.add('hidden');
                document.getElementById('confirmationSection').classList.add('hidden');
                hideAsManualSection();
            }
        }

        // 파트 목록 렌더링
        function renderPartsList() {
            const partsList = document.getElementById('partsList');
            partsList.innerHTML = '';

            Object.keys(scannedParts).forEach(partNumber => {
                const part = scannedParts[partNumber];
                const partItem = document.createElement('tr');
                partItem.className = 'hover:bg-gray-50 transition-colors duration-200';
                partItem.id = `part-${partNumber}`;
                
                // 출고 등록에서는 스캔된 수량이 0보다 크면 완료로 간주
                const isCompleted = part.scannedQuantity > 0;

                // 스캔된 파트는 빨간색 배경
                if (isCompleted) {
                    partItem.classList.add('bg-red-100', 'border-l-4', 'border-red-500');
                }

                partItem.innerHTML = `
                    <td class="px-4 py-3">
                        <div>
                            <div class="font-semibold text-gray-800">${partNumber}</div>
                            <div class="text-sm text-gray-500">카테고리: ${part.category || 'N/A'}</div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="font-medium ${part.scannedQuantity > 0 ? 'text-red-600' : 'text-gray-500'}">${part.scannedQuantity}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="font-medium ${part.scanCount > 0 ? 'text-blue-600' : 'text-gray-500'}">${part.scanCount || 0}</span>
                    </td>
                    <td class="px-4 py-3 text-center">
                        <span class="font-medium ${part.scannedQuantity > 0 ? 'text-red-600' : 'text-gray-500'}">
                            ${part.scannedQuantity > 0 ? '스캔됨' : '대기중'}
                        </span>
                    </td>
                `;

                partsList.appendChild(partItem);
            });
        }

        // 진행 상황 업데이트
        function updateProgress() {
            const completedParts = Object.values(scannedParts).filter(part => part.scannedQuantity > 0).length;

            // 스캔된 파트가 있으면 등록 섹션 표시
            if (completedParts > 0) {
                document.getElementById('confirmationSection').classList.remove('hidden');
            } else {
                document.getElementById('confirmationSection').classList.add('hidden');
            }
        }

        // 바코드 스캔 처리
        function handleBarcodeScan(barcode) {
            console.log('바코드 스캔 처리 시작:', barcode);
            console.log('현재 스캔된 파트 목록:', Object.keys(scannedParts));
            
            // GS1-128 바코드 파싱 시도
            const parsedData = parseGS1Barcode(barcode);
            
            if (parsedData) {
                console.log('GS1-128 파싱 성공, 파트 번호:', parsedData.partNumber);
                console.log('추출된 고유코드:', parsedData.uniqueNumber);
                
                // 고유코드 중복 검사
                if (scannedUniqueCodes.has(parsedData.uniqueNumber)) {
                    console.log('고유코드 중복 감지:', parsedData.uniqueNumber);
                    
                    // 바코드 입력창에 시각적 피드백 제공
                    const barcodeInput = document.getElementById('barcodeInput');
                    barcodeInput.style.backgroundColor = '#fee2e2'; // 빨간색 배경
                    barcodeInput.style.borderColor = '#ef4444'; // 빨간색 테두리
                    barcodeInput.placeholder = `중복 스캔: ${parsedData.uniqueNumber}`;
                    
                    // 1.5초 후 원래 상태로 복원
                    setTimeout(() => {
                        barcodeInput.style.backgroundColor = '';
                        barcodeInput.style.borderColor = '';
                        barcodeInput.placeholder = i18n.t('scan_barcode_placeholder');
                        barcodeInput.value = '';
                        barcodeInput.focus();
                        barcodeInput.select();
                    }, 1500);
                    
                    return false;
                }
                
                // 파트가 이미 스캔된 목록에 있는지 확인
                let part = scannedParts[parsedData.partNumber];
                
                if (!part) {
                    // 새로운 파트인 경우 추가
                    console.log('새로운 파트 추가:', parsedData.partNumber);
                    scannedParts[parsedData.partNumber] = {
                        partNumber: parsedData.partNumber,
                        quantity: parsedData.quantity,
                        scannedQuantity: 0,
                        scanCount: 0, // 스캔 횟수 추가
                        category: '출고 파트'
                    };
                    part = scannedParts[parsedData.partNumber];
                    scanCounts[parsedData.partNumber] = 0; // 스캔 횟수 초기화
                }
                
                // 고유코드를 스캔된 목록에 추가
                scannedUniqueCodes.add(parsedData.uniqueNumber);
                console.log('고유코드 등록됨:', parsedData.uniqueNumber);
                console.log('현재 스캔된 고유코드 목록:', Array.from(scannedUniqueCodes));
                
                // 스캔된 수량을 해당 파트에 추가
                part.scannedQuantity += parsedData.quantity;
                // 스캔 횟수 증가 (바코드 QTY와 관계없이 1회씩 증가)
                part.scanCount += 1;
                scanCounts[parsedData.partNumber] = part.scanCount;
                
                renderPartsList();
                updateProgress();
                
                // 스캔 성공 알림 제거 - 연속 스캔을 위해
                // showNotification(`${parsedData.partNumber} 스캔 완료 (수량: ${parsedData.quantity}, 총 스캔: ${part.scannedQuantity})`, 'success');
                
                // 입력 필드 초기화 및 포커스 유지
                const barcodeInput = document.getElementById('barcodeInput');
                barcodeInput.value = '';
                setTimeout(() => {
                    barcodeInput.focus();
                    barcodeInput.select();
                }, 100);
                
                return true;
            } else {
                console.log('GS1-128 파싱 실패, 직접 파트 번호 입력 시도');
                
                // 직접 파트 번호 입력인 경우 - 파트 번호 정리 (관리자 모드와 동일)
                let cleanPartNumber = barcode.trim();
                
                // 5자리 숫자 + 알파벳 + 4자리 숫자 형식인지 확인하고 마지막 알파벳 제거
                const partMatch = cleanPartNumber.match(/^(\d{5})([A-Za-z])(\d{4})$/);
                if (partMatch) {
                    // 마지막 알파벳 제거하고 하이픈 추가
                    cleanPartNumber = `${partMatch[1]}-${partMatch[2]}${partMatch[3]}`;
                    console.log('파트 번호 정리됨:', barcode, '->', cleanPartNumber);
                }
                
                let part = scannedParts[cleanPartNumber];
                
                if (!part) {
                    // 새로운 파트인 경우 추가
                    console.log('새로운 파트 추가 (직접 입력):', cleanPartNumber);
                    scannedParts[cleanPartNumber] = {
                        partNumber: cleanPartNumber,
                        quantity: 1,
                        scannedQuantity: 0,
                        scanCount: 0, // 스캔 횟수 추가
                        category: '출고 파트'
                    };
                    part = scannedParts[cleanPartNumber];
                    scanCounts[cleanPartNumber] = 0; // 스캔 횟수 초기화
                }
                
                // 스캔된 수량을 해당 파트에 추가 (수량 1)
                part.scannedQuantity += 1;
                // 스캔 횟수 증가 (직접 입력도 1회씩 증가)
                part.scanCount += 1;
                scanCounts[cleanPartNumber] = part.scanCount;
                
                renderPartsList();
                updateProgress();
                
                // 스캔 성공 알림 제거 - 연속 스캔을 위해
                // showNotification(`${cleanPartNumber} 스캔 완료 (수량: 1, 총 스캔: ${part.scannedQuantity})`, 'success');
                
                // 입력 필드 초기화 및 포커스 유지
                const barcodeInput = document.getElementById('barcodeInput');
                barcodeInput.value = '';
                setTimeout(() => {
                    barcodeInput.focus();
                    barcodeInput.select();
                }, 100);
                
                return true;
            }
        }

        // GS1-128 바코드 파싱 함수 (입고와 동일한 로직)
        function parseGS1Barcode(barcode) {
            try {
                console.log('바코드 파싱 시작:', barcode);
                
                // GS1-128 형식: [)>*06:D032125:5K:23L :24L :P49560l3010:7Q50:3SP11000321253583:VP1100*EOT
                
                // 파트 번호 추출 (P49560l3010) - 소문자 l도 포함
                const partMatch = barcode.match(/P\d{5}[a-zA-Z]\d{4}/);
                if (!partMatch) {
                    console.log('파트 번호 매칭 실패');
                    return null;
                }
                let partNumber = partMatch[0];
                console.log('추출된 파트 번호 (P 포함):', partNumber);
                
                // P 접두사 제거 (P49560l3010 -> 49560l3010)
                if (partNumber.startsWith('P')) {
                    partNumber = partNumber.substring(1);
                    console.log('P 접두사 제거 후:', partNumber);
                }
                
                // 마지막 알파벳 제거 (49560l3010 -> 49560l3010, 49560L3010 -> 49560L3010)
                // 숫자로 끝나는지 확인하고, 알파벳으로 끝나면 제거
                if (!partNumber.match(/\d$/)) {
                    partNumber = partNumber.replace(/[a-zA-Z]$/, '');
                    console.log('마지막 알파벳 제거 후:', partNumber);
                }
                
                // DB 형식에 맞게 하이픈 추가 (49560L3010 -> 49560-L3010)
                // 5자리 숫자 + 알파벳 + 4자리 숫자 형식인지 확인
                const hyphenMatch = partNumber.match(/^(\d{5})([A-Za-z])(\d{4})$/);
                if (hyphenMatch) {
                    partNumber = `${hyphenMatch[1]}-${hyphenMatch[2]}${hyphenMatch[3]}`;
                    console.log('하이픈 추가 후:', partNumber);
                }
                
                // 수량 추출 (7Q50 -> 50)
                const quantityMatch = barcode.match(/7Q(\d+)/);
                if (!quantityMatch) {
                    console.log('수량 매칭 실패');
                    return null;
                }
                const quantity = parseInt(quantityMatch[1]);
                console.log('추출된 수량:', quantity);
                
                // 유니크 넘버 추출 (3SP11000321253583 -> P11000321253583)
                // 3S 다음부터 다음 : 까지가 고유코드
                const uniqueMatch = barcode.match(/3S([^:]+)/);
                if (!uniqueMatch) {
                    console.log('유니크 넘버 매칭 실패');
                    return null;
                }
                const uniqueNumber = uniqueMatch[1];
                console.log('추출된 유니크 넘버:', uniqueNumber);
                
                const result = {
                    partNumber,
                    quantity,
                    uniqueNumber
                };
                
                console.log('최종 파싱 결과:', result);
                return result;
                
            } catch (error) {
                console.error('GS1 바코드 파싱 오류:', error);
                return null;
            }
        }

        // 바코드 스캔 시뮬레이션
        function scanBarcode() {
            const input = document.getElementById('barcodeInput');
            const barcode = input.value.trim();
            
            if (barcode) {
                handleBarcodeScan(barcode);
            } else {
                showNotification('바코드를 입력하거나 스캔하세요.', 'warning');
            }
        }

        // 스캔 초기화
        function clearScan() {
            // 모든 데이터 초기화
            scannedParts = {}; // 파트 목록 전체 초기화
            scannedUniqueCodes.clear(); // 고유코드 목록 초기화
            scanCounts = {}; // 스캔 횟수 초기화
            
            // UI 초기화
            renderPartsList();
            updateProgress();
            document.getElementById('barcodeInput').value = '';
            
            // 확인 섹션 숨기기
            document.getElementById('confirmationSection').classList.add('hidden');
            
            showNotification('스캔이 초기화되었습니다.', 'info');
        }

        // 출고 확정 (관리자 모드와 동일한 방식으로 PENDING 상태로 등록)
        async function confirmOutbound() {
            console.log('=== PDA 출고 등록 함수 시작 ===');
            console.log('currentDate:', currentDate);
            console.log('currentShift:', currentShift);
            console.log('scannedParts:', scannedParts);
            
            if (!currentDate || !currentShift) {
                console.error('날짜와 차수가 선택되지 않음');
                showNotification('날짜와 차수를 선택해주세요.', 'error');
                return;
            }

            // 스캔된 파트가 있는지 확인
            const hasScannedParts = Object.values(scannedParts).some(part => part.scannedQuantity > 0);
            console.log('hasScannedParts:', hasScannedParts);
            console.log('파트별 스캔 상태:', Object.entries(scannedParts).map(([partNum, part]) => ({part: partNum, scanned: part.scannedQuantity, quantity: part.quantity})));
            
            if (!hasScannedParts) {
                console.error('스캔된 파트가 없음');
                showNotification('스캔된 파트가 없습니다. 바코드를 스캔해주세요.', 'error');
                return;
            }

            try {
                console.log('PDA 출고 등록 시작:', currentDate, currentShift);
                
                // 0. 동일한 날짜와 차수의 중복 확인 (관리자 모드와 동일)
                const sequenceNumber = `${currentDate.replace(/-/g, '')}-${currentShift}`;
                const { data: existingSequence, error: checkError } = await supabase
                    .from('outbound_sequences')
                    .select('id, sequence_number, outbound_date, status')
                    .eq('outbound_date', currentDate)
                    .eq('sequence_number', sequenceNumber)
                    .maybeSingle();

                if (checkError) {
                    console.error('중복 확인 오류:', checkError);
                    throw checkError;
                }

                if (existingSequence) {
                    showNotification(`이미 등록된 차수입니다: ${existingSequence.sequence_number}`, 'error');
                    return;
                }
                
                // 1. 출고 차수 생성 (관리자 모드와 동일한 형식)
                const sequenceData = {
                    sequence_number: sequenceNumber,
                    outbound_date: currentDate,
                    status: 'PENDING'
                };

                console.log('출고 차수 데이터:', sequenceData);
                const { data: newSequence, error: sequenceError } = await supabase
                    .from('outbound_sequences')
                    .insert(sequenceData)
                    .select()
                    .single();

                if (sequenceError) {
                    console.error('출고 차수 생성 오류:', sequenceError);
                    showNotification(`출고 차수 생성 오류: ${sequenceError.message}`, 'error');
                    throw sequenceError;
                }

                console.log('출고 차수 생성 성공:', newSequence);

                // 2. 출고 파트들 생성 (관리자 모드와 동일한 형식)
                const partsData = Object.entries(scannedParts)
                    .filter(([partNumber, part]) => part.scannedQuantity > 0) // 스캔된 파트만 저장
                    .map(([partNumber, part]) => ({
                        sequence_id: newSequence.id,
                        part_number: partNumber,
                        planned_qty: currentShift === 'AS' ? 0 : (part.quantity || 0), // AS는 계획 수량 0
                        scanned_qty: part.scannedQuantity, // 실제 스캔된 수량
                        actual_qty: part.scannedQuantity, // PDA에서는 스캔된 수량 = 실제 출고 수량
                        status: 'PENDING'
                    }));

                console.log('출고 파트 데이터:', partsData);
                const { error: partsError } = await supabase
                    .from('outbound_parts')
                    .insert(partsData);

                if (partsError) {
                    console.error('출고 파트 생성 오류:', partsError);
                    showNotification(`출고 파트 생성 오류: ${partsError.message}`, 'error');
                    throw partsError;
                }

                console.log('출고 파트 생성 성공');

                const totalScannedQuantity = Object.values(scannedParts).reduce((sum, part) => sum + part.scannedQuantity, 0);
                console.log('PDA 출고 등록 완료:', {
                    sequenceId: newSequence.id,
                    sequenceNumber: sequenceNumber,
                    date: currentDate,
                    shift: currentShift,
                    totalScannedQuantity,
                    partsCount: partsData.length
                });
                showNotification(`출고가 성공적으로 등록되었습니다. (${sequenceNumber}, 총 스캔 수량: ${totalScannedQuantity})`, 'success');
                
                // 페이지 초기화
                setTimeout(() => {
                    resetPage();
                }, 2000);

            } catch (error) {
                console.error('PDA 출고 등록 오류:', error);
                showNotification(`출고 등록 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 출고 취소
        function cancelOutbound() {
            // 모든 데이터 초기화 (초기화 버튼과 동일)
            scannedParts = {}; // 파트 목록 전체 초기화
            scannedUniqueCodes.clear(); // 고유코드 목록 초기화
            scanCounts = {}; // 스캔 횟수 초기화
            
            // UI 초기화
            renderPartsList();
            updateProgress();
            document.getElementById('barcodeInput').value = '';
            document.getElementById('confirmationSection').classList.add('hidden');
            
            showNotification('출고가 취소되었습니다.', 'info');
        }

        // 페이지 초기화
        function resetPage() {
            scannedParts = {};
            scannedUniqueCodes.clear();
            scanCounts = {}; // 스캔 횟수 초기화
            
            document.getElementById('dateSelect').value = '';
            document.getElementById('shiftSelect').value = '';
            document.getElementById('scanSection').classList.add('hidden');
            document.getElementById('partsSection').classList.add('hidden');
            document.getElementById('confirmationSection').classList.add('hidden');
            document.getElementById('partsList').innerHTML = '';
            
            currentDate = '';
            currentShift = '';
        }

        // 알림 표시
        function showNotification(message, type = 'info') {
            // 간단한 알림 구현
            alert(message);
        }

        // 현재 시간 업데이트
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'America/Chicago'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // 전역 바코드 입력 버퍼
        let globalBarcodeBuffer = '';
        let globalBarcodeTimer = null;
        const BARCODE_TIMEOUT = 100; // 바코드 입력 완료 판단 시간 (ms)

        // 전역 바코드 입력 상태 표시
        function showGlobalBarcodeStatus() {
            // 상태 표시 요소 생성
            const statusElement = document.createElement('div');
            statusElement.id = 'globalBarcodeStatus';
            statusElement.className = 'fixed top-20 right-4 bg-green-100 border border-green-400 text-green-700 px-3 py-2 rounded-lg text-sm z-50';
            statusElement.innerHTML = '<i class="fas fa-barcode mr-2"></i>전역 바코드 스캔 활성화';
            document.body.appendChild(statusElement);
            
            // 3초 후 자동 숨김
            setTimeout(() => {
                if (statusElement) {
                    statusElement.style.opacity = '0.5';
                }
            }, 3000);
        }

        // 바코드 입력 중 시각적 피드백
        function showBarcodeInputFeedback() {
            const barcodeInput = document.getElementById('barcodeInput');
            if (barcodeInput) {
                // 입력창에 시각적 피드백 제공
                barcodeInput.style.backgroundColor = '#fef3c7'; // 노란색 배경
                barcodeInput.style.borderColor = '#f59e0b'; // 주황색 테두리
                
                // 0.5초 후 원래 상태로 복원
                setTimeout(() => {
                    barcodeInput.style.backgroundColor = '';
                    barcodeInput.style.borderColor = '';
                }, 500);
            }
        }

        // 출고 파트 목록 로드 함수
        async function loadOutboundParts() {
            try {
                const selectedShift = document.getElementById('shiftSelect').value;
                console.log('출고 파트 로드 시작, 선택된 차수:', selectedShift);
                
                if (!selectedShift || selectedShift === 'AS') {
                    console.log('AS 차수이거나 차수가 선택되지 않음 - 출고 파트 로드 안함');
                    return Promise.resolve();
                }

                // 선택된 차수에 해당하는 출고 시퀀스 찾기
                const { data: sequences, error: sequencesError } = await supabase
                    .from('outbound_sequences')
                    .select('id, sequence_name, shift')
                    .eq('shift', selectedShift)
                    .eq('status', 'PENDING')
                    .order('created_at', { ascending: false });

                if (sequencesError) {
                    console.error('출고 시퀀스 조회 오류:', sequencesError);
                    throw sequencesError;
                }

                if (!sequences || sequences.length === 0) {
                    console.log('해당 차수의 출고 시퀀스가 없음');
                    return Promise.resolve();
                }

                const sequenceId = sequences[0].id;
                console.log('출고 시퀀스 ID:', sequenceId);

                // 해당 시퀀스의 출고 파트 목록 조회
                const { data: outboundParts, error: partsError } = await supabase
                    .from('outbound_parts')
                    .select(`
                        id,
                        part_number,
                        planned_qty,
                        actual_qty,
                        status,
                        master_parts (
                            part_name,
                            part_description
                        )
                    `)
                    .eq('sequence_id', sequenceId)
                    .order('created_at', { ascending: true });

                if (partsError) {
                    console.error('출고 파트 조회 오류:', partsError);
                    throw partsError;
                }

                console.log('출고 파트 목록 로드 완료:', outboundParts);
                
                // 전역 변수에 저장
                window.outboundParts = outboundParts || [];
                
                return Promise.resolve();
            } catch (error) {
                console.error('출고 파트 로드 중 오류:', error);
                return Promise.reject(error);
            }
        }

        // 전역 바코드 입력 처리 함수
        function handleGlobalBarcodeInput(e) {
            // 특수 키는 무시 (Shift, Ctrl, Alt, Tab, Escape 등)
            if (e.key.length > 1 && !['Enter', 'Backspace'].includes(e.key)) {
                return;
            }

            // Enter 키로 바코드 입력 완료
            if (e.key === 'Enter') {
                e.preventDefault();
                
                if (globalBarcodeBuffer.trim().length > 0) {
                    console.log('전역 바코드 입력 완료:', globalBarcodeBuffer);
                    
                    // 바코드 입력창에 값 설정하고 스캔 실행
                    const barcodeInput = document.getElementById('barcodeInput');
                    if (barcodeInput) {
                        barcodeInput.value = globalBarcodeBuffer;
                        scanBarcode();
                    }
                    
                    // 버퍼 초기화
                    globalBarcodeBuffer = '';
                }
                return;
            }

            // Backspace 키 처리
            if (e.key === 'Backspace') {
                e.preventDefault();
                globalBarcodeBuffer = globalBarcodeBuffer.slice(0, -1);
                return;
            }

            // 일반 문자 입력
            if (e.key.length === 1) {
                e.preventDefault();
                globalBarcodeBuffer += e.key;
                
                // 바코드 입력 중 시각적 피드백
                showBarcodeInputFeedback();
                
                // 타이머 리셋 (연속 입력 중)
                if (globalBarcodeTimer) {
                    clearTimeout(globalBarcodeTimer);
                }
                
                // GS1-128 바코드 패턴 확인 (정확한 패턴)
                const isGS1BarcodePattern = /^\[\)>\*06:D\d+:5K:23L:24L:P\d{5}[a-zA-Z]\d{4}:7Q\d+:3S[^:]+:VP\d+\*EOT$/.test(globalBarcodeBuffer);
                
                // 바코드 길이가 30자 이상이거나 GS1 패턴이 맞으면 자동 엔터
                if (globalBarcodeBuffer.length >= 30 || (globalBarcodeBuffer.length >= 20 && isGS1BarcodePattern)) {
                    globalBarcodeTimer = setTimeout(() => {
                        // 엔터키 이벤트 시뮬레이션
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true,
                            cancelable: true
                        });
                        document.dispatchEvent(enterEvent);
                    }, 50);
                } else {
                    // 일반적인 경우 타이머 설정
                    globalBarcodeTimer = setTimeout(() => {
                        if (globalBarcodeBuffer.trim().length > 0) {
                            console.log('전역 바코드 입력 완료 (타이머):', globalBarcodeBuffer);
                            
                            // 바코드 입력창에 값 설정하고 스캔 실행
                            const barcodeInput = document.getElementById('barcodeInput');
                            if (barcodeInput) {
                                barcodeInput.value = globalBarcodeBuffer;
                                scanBarcode();
                            }
                            
                            // 버퍼 초기화
                            globalBarcodeBuffer = '';
                        }
                    }, BARCODE_TIMEOUT);
                }
            }
        }

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 날짜 및 차수 선택 이벤트
            document.getElementById('dateSelect').addEventListener('change', updateOutboundInfo);
            document.getElementById('shiftSelect').addEventListener('change', updateOutboundInfo);

            // 전역 키보드 이벤트 리스너 (바코드 스캐너용)
            document.addEventListener('keydown', function(e) {
                // 입력 필드가 포커스되어 있지 않은 경우에만 전역 처리
                const activeElement = document.activeElement;
                const isInputFocused = activeElement && (
                    activeElement.tagName === 'INPUT' || 
                    activeElement.tagName === 'SELECT' || 
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.contentEditable === 'true'
                );
                
                if (!isInputFocused) {
                    handleGlobalBarcodeInput(e);
                }
            });

            // 전역 바코드 입력 상태 표시
            showGlobalBarcodeStatus();

            // 바코드 입력 이벤트
            document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    scanBarcode();
                }
            });

            // 바코드 입력 필드 포커스
            document.getElementById('barcodeInput').addEventListener('focus', function() {
                this.select();
            });

            // 자동 엔터키 처리 (바코드 스캐너용)
            let barcodeInputTimer = null;
            document.getElementById('barcodeInput').addEventListener('input', function(e) {
                const input = e.target;
                const value = input.value;
                
                // 이전 타이머 클리어
                if (barcodeInputTimer) {
                    clearTimeout(barcodeInputTimer);
                }
                
                // GS1-128 바코드 패턴 확인 (정확한 패턴)
                const isGS1BarcodePattern = /^\[\)>\*06:D\d+:5K:23L:24L:P\d{5}[a-zA-Z]\d{4}:7Q\d+:3S[^:]+:VP\d+\*EOT$/.test(value);
                
                // 바코드 길이가 30자 이상이거나 GS1 패턴이 맞으면 자동 엔터
                if (value.length >= 30 || (value.length >= 20 && isGS1BarcodePattern)) {
                    barcodeInputTimer = setTimeout(() => {
                        // 엔터키 이벤트 시뮬레이션
                        const enterEvent = new KeyboardEvent('keypress', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true,
                            cancelable: true
                        });
                        input.dispatchEvent(enterEvent);
                    }, 50);
                }
            });

            // 포커스 유지 기능
            document.addEventListener('click', function(event) {
                // 바코드 입력창이나 관련 요소 클릭 시 포커스 유지하지 않음
                if (event.target.closest('#barcodeInput') || 
                    event.target.closest('#dateSelect') ||
                    event.target.closest('#shiftSelect') ||
                    event.target.closest('button')) {
                    return;
                }
                
                // 다른 곳 클릭 시 바코드 입력창에 포커스
                const barcodeInput = document.getElementById('barcodeInput');
                if (barcodeInput && !barcodeInput.classList.contains('hidden')) {
                    setTimeout(() => {
                        barcodeInput.focus();
                        barcodeInput.select();
                    }, 100);
                }
            });

            // 키보드 이벤트로 포커스 유지
            document.addEventListener('keydown', function(event) {
                // 특정 키나 요소에서 포커스 유지하지 않음
                if (event.target.closest('#dateSelect') || 
                    event.target.closest('#shiftSelect') ||
                    event.target.closest('button') ||
                    event.key === 'Tab') {
                    return;
                }
                
                // 다른 키 입력 시 바코드 입력창에 포커스
                const barcodeInput = document.getElementById('barcodeInput');
                if (barcodeInput && !barcodeInput.classList.contains('hidden') && 
                    event.target.id !== 'barcodeInput') {
                    barcodeInput.focus();
                    barcodeInput.select();
                }
            });
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            // Supabase 초기화
            if (initializeSupabase()) {
                console.log('Supabase 초기화 성공');
            } else {
                console.error('Supabase 초기화 실패');
            }
            
            // 이벤트 리스너 설정
            setupEventListeners();
            
            // 시간 업데이트 시작
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            // 오늘 날짜를 기본값으로 설정
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const todayString = `${year}-${month}-${day}`;
            
            document.getElementById('dateSelect').value = todayString;
            currentDate = todayString;
        });

        // AS 수동 입력 섹션 표시/숨김
        function showAsManualSection() {
            document.getElementById('asManualSection').classList.remove('hidden');
            document.getElementById('scanSection').classList.add('hidden');
        }
        
        function hideAsManualSection() {
            document.getElementById('asManualSection').classList.add('hidden');
        }
        
        // 마스터 파트 목록 로드
        async function loadMasterParts() {
            try {
                const { data, error } = await supabase
                    .from('parts')
                    .select('part_number, category')
                    .order('part_number');
                
                if (error) throw error;
                
                const select = document.getElementById('asPartSelect');
                select.innerHTML = `<option value="">${i18n.t('select_part_manual')}</option>`;
                
                data.forEach(part => {
                    const option = document.createElement('option');
                    option.value = part.part_number;
                    option.textContent = `${part.part_number} - ${part.category || 'N/A'}`;
                    select.appendChild(option);
                });
                
                console.log('마스터 파트 목록 로드 완료:', data.length, '개');
            } catch (error) {
                console.error('마스터 파트 로드 오류:', error);
                alert(i18n.t('error_prefix') + '마스터 파트 목록을 불러올 수 없습니다.');
            }
        }
        
        // AS 파트 추가
        function addAsPart() {
            const partSelect = document.getElementById('asPartSelect');
            const quantityInput = document.getElementById('asQuantityInput');
            
            const partNumber = partSelect.value;
            const quantity = parseInt(quantityInput.value);
            
            if (!partNumber) {
                alert(i18n.t('error_prefix') + i18n.t('select_part_required'));
                return;
            }
            
            if (!quantity || quantity <= 0) {
                alert(i18n.t('error_prefix') + i18n.t('quantity_required'));
                return;
            }
            
            // 스캔된 파트에 추가
            if (scannedParts[partNumber]) {
                scannedParts[partNumber].scannedQuantity += quantity;
            } else {
                scannedParts[partNumber] = {
                    partNumber: partNumber,
                    registeredQuantity: 0, // AS는 등록된 수량이 없음
                    scannedQuantity: quantity,
                    remainingQuantity: 0,
                    cart: 1
                };
            }
            
            // 파트 목록 업데이트
            renderPartsList();
            
            // 입력 필드 초기화
            clearAsInput();
            
            // 확인 섹션 표시
            document.getElementById('confirmationSection').classList.remove('hidden');
            
            console.log('AS 파트 추가:', partNumber, quantity);
        }
        
        // AS 입력 초기화
        function clearAsInput() {
            document.getElementById('asPartSelect').value = '';
            document.getElementById('asQuantityInput').value = '';
        }
        
        // 터치 이벤트 최적화
        document.addEventListener('touchstart', function() {}, {passive: true});
        document.addEventListener('touchmove', function() {}, {passive: true});
    </script>
</body>
</html> 