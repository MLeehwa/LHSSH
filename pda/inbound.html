<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ì…ê³ ì²˜ë¦¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* PDA ìµœì í™” ìŠ¤íƒ€ì¼ */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .action-button:active {
            transform: scale(0.98);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .save-btn {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
        }
        
        .reset-btn {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }
        
        .home-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        }
        
        .part-row {
            transition: all 0.3s ease;
            border-radius: 12px;
            margin-bottom: 8px;
        }
        
        .part-row.completed {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border: 2px solid #22c55e;
        }
        
        .part-row.incomplete {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e5e7eb;
        }
        
        .part-row.disabled {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #ef4444;
            opacity: 0.7;
        }
        
        .scan-input {
            background: rgba(144, 238, 144, 0.3);
            border: 2px solid #90ee90;
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .scan-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .dropdown {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .dropdown:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .floating-icon {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="glass-card shadow-lg">
        <div class="flex items-center justify-between px-6 py-4">
            <div class="flex items-center">
                <button onclick="goHome()" class="w-10 h-10 bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl flex items-center justify-center shadow-lg mr-4">
                    <i class="fas fa-home text-white text-lg"></i>
                </button>
                <div class="w-12 h-12 bg-gradient-to-br from-green-500 to-green-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-arrow-down text-white text-xl"></i>
                </div>
                <div class="ml-4">
                    <h1 class="text-xl font-bold text-gray-800" data-i18n="inboundTitle">ì…ê³ ì²˜ë¦¬</h1>
                    <p class="text-sm text-gray-600 font-medium" data-i18n="inboundSubtitle">ì¬ê³  ì…ê³  ê´€ë¦¬</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div class="text-right">
                    <div class="text-xs text-gray-500 font-medium" data-i18n="currentTime">í˜„ì¬ ì‹œê°„</div>
                    <div id="currentTime" class="text-lg font-bold text-gray-800 font-mono"></div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-6 space-y-6">
        <!-- Container Selection -->
        <div class="glass-card p-6 rounded-2xl">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-shipping-fast text-blue-600 mr-3"></i>
                <span data-i18n="containerSelection">ì»¨í…Œì´ë„ˆ ì„ íƒ</span>
            </h3>
            <select id="containerSelect" class="dropdown w-full" onchange="loadParts()">
                <option value="" data-i18n="selectContainer">ì»¨í…Œì´ë„ˆë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="CONT001">CONT001 - ì„œìš¸í•­</option>
                <option value="CONT002">CONT002 - ë¶€ì‚°í•­</option>
                <option value="CONT003">CONT003 - ì¸ì²œí•­</option>
                <option value="CONT004">CONT004 - ìš¸ì‚°í•­</option>
                <option value="CONT005">CONT005 - ê´‘ì–‘í•­</option>
            </select>
        </div>

        <!-- Barcode Scanner -->
        <div class="glass-card p-6 rounded-2xl" id="scannerSection">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-barcode text-purple-600 mr-3"></i>
                <span data-i18n="barcodeScan">ë°”ì½”ë“œ ìŠ¤ìº”</span>
            </h3>
            <div class="flex items-center space-x-4">
                <input type="text" 
                       id="barcodeInput" 
                       class="flex-1 scan-input text-center text-xl font-bold" 
                       placeholder="barcode"
                       autocomplete="off"
                       onkeypress="handleBarcodeScan(event)"
                       oninput="handleBarcodeInput(event)"
                       onfocus="this.select()">
                <button onclick="clearBarcodeInput()" class="w-12 h-12 bg-gradient-to-br from-gray-500 to-gray-600 rounded-xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-times text-white text-lg"></i>
                </button>
            </div>
            <div class="mt-3 text-sm text-gray-600">
                <i class="fas fa-info-circle mr-2"></i>
                <span data-i18n="scanInfo">ìŠ¤ìº” í›„ ìë™ìœ¼ë¡œ í•´ë‹¹ íŒŒíŠ¸ì˜ ìˆ˜ëŸ‰ì´ ì¦ê°€í•©ë‹ˆë‹¤</span>
            </div>
        </div>

        <!-- Parts List -->
        <div class="glass-card p-6 rounded-2xl" id="partsSection" style="display: none;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-800 flex items-center">
                    <i class="fas fa-boxes text-green-600 mr-3"></i>
                    <span data-i18n="partsList">íŒŒíŠ¸ ëª©ë¡</span>
                </h3>
                <div class="text-sm text-gray-600">
                    <span id="completedCount">0</span> / <span id="totalCount">0</span> <span data-i18n="completed">ì™„ë£Œ</span>
                </div>
            </div>
            
            <div id="partsList" class="space-y-3">
                <!-- Parts will be loaded here -->
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="grid grid-cols-3 gap-4" id="actionButtons">
            <button onclick="saveInbound()" class="action-button save-btn h-16 flex flex-col items-center justify-center text-white font-bold">
                <i class="fas fa-save text-xl mb-1"></i>
                <span class="text-sm" data-i18n="save">ì €ì¥</span>
            </button>
            
            <button onclick="resetInbound()" class="action-button reset-btn h-16 flex flex-col items-center justify-center text-white font-bold">
                <i class="fas fa-undo text-xl mb-1"></i>
                <span class="text-sm" data-i18n="reset">ì´ˆê¸°í™”</span>
            </button>
            
            <button onclick="goHome()" class="action-button home-btn h-16 flex flex-col items-center justify-center text-white font-bold">
                <i class="fas fa-home text-xl mb-1"></i>
                <span class="text-sm" data-i18n="home">í™ˆ</span>
            </button>
        </div>

        <!-- Status Message -->
        <div id="statusMessage" class="glass-card p-4 rounded-xl text-center" style="display: none;">
            <div id="statusText" class="text-lg font-bold"></div>
        </div>
    </main>

    <script>
        // ë‹¤ì¤‘ ì–¸ì–´ ì§€ì›
        const translations = {
            ko: {
                inboundTitle: 'ì…ê³ ì²˜ë¦¬',
                inboundSubtitle: 'ì¬ê³  ì…ê³  ê´€ë¦¬',
                currentTime: 'í˜„ì¬ ì‹œê°„',
                containerSelection: 'ì»¨í…Œì´ë„ˆ ì„ íƒ',
                selectContainer: 'ì»¨í…Œì´ë„ˆë¥¼ ì„ íƒí•˜ì„¸ìš”',
                barcodeScan: 'ë°”ì½”ë“œ ìŠ¤ìº”',
                scanInfo: 'ìŠ¤ìº” í›„ ìë™ìœ¼ë¡œ í•´ë‹¹ íŒŒíŠ¸ì˜ ìˆ˜ëŸ‰ì´ ì¦ê°€í•©ë‹ˆë‹¤',
                partsList: 'íŒŒíŠ¸ ëª©ë¡',
                completed: 'ì™„ë£Œ',
                save: 'ì €ì¥',
                reset: 'ì´ˆê¸°í™”',
                home: 'í™ˆ',
                registeredQuantity: 'ë“±ë¡ ìˆ˜ëŸ‰',
                scannedQuantity: 'ìŠ¤ìº” ìˆ˜ëŸ‰',
                quantityExceeded: 'ë“±ë¡ ìˆ˜ëŸ‰ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                incompleteParts: 'ë‹¤ìŒ íŒŒíŠ¸ë“¤ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:',
                continueSave: 'ê³„ì† ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                saveSuccess: 'ì…ê³ ì²˜ë¦¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                resetConfirm: 'ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                unsavedData: 'ì €ì¥í•˜ì§€ ì•Šì€ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. í™ˆìœ¼ë¡œ ì´ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
                invalidBarcode: 'ì˜ëª»ëœ ë°”ì½”ë“œ í˜•ì‹ì…ë‹ˆë‹¤.',
                unregisteredPart: 'ë“±ë¡ë˜ì§€ ì•Šì€ íŒŒíŠ¸:',
                duplicateBox: 'ì´ë¯¸ ìŠ¤ìº”ëœ ë°•ìŠ¤:',
                quantityOverflow: 'ìˆ˜ëŸ‰ ì´ˆê³¼!',
                scanComplete: 'ìŠ¤ìº” ì™„ë£Œ!',
                partComplete: 'ì™„ë£Œ! ğŸ‰',
                barcodeError: 'ë°”ì½”ë“œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
            },
            en: {
                inboundTitle: 'Inbound Processing',
                inboundSubtitle: 'Stock Inbound Management',
                currentTime: 'Current Time',
                containerSelection: 'Container Selection',
                selectContainer: 'Please select a container',
                barcodeScan: 'Barcode Scan',
                scanInfo: 'Quantity will automatically increase after scanning',
                partsList: 'Parts List',
                completed: 'Completed',
                save: 'Save',
                reset: 'Reset',
                home: 'Home',
                registeredQuantity: 'Registered Qty',
                scannedQuantity: 'Scanned Qty',
                quantityExceeded: 'Cannot exceed registered quantity.',
                incompleteParts: 'The following parts are not completed:',
                continueSave: 'Continue saving?',
                saveSuccess: 'Inbound processing has been saved.',
                resetConfirm: 'Reset all data?',
                unsavedData: 'There is unsaved data. Go to home?',
                invalidBarcode: 'Invalid barcode format.',
                unregisteredPart: 'Unregistered part:',
                duplicateBox: 'Already scanned box:',
                quantityOverflow: 'Quantity overflow!',
                scanComplete: 'Scan complete!',
                partComplete: 'Complete! ğŸ‰',
                barcodeError: 'Error occurred while processing barcode.'
            },
            es: {
                inboundTitle: 'Procesamiento de Entrada',
                inboundSubtitle: 'GestiÃ³n de Entrada de Inventario',
                currentTime: 'Hora Actual',
                containerSelection: 'SelecciÃ³n de Contenedor',
                selectContainer: 'Por favor seleccione un contenedor',
                barcodeScan: 'Escaneo de CÃ³digo de Barras',
                scanInfo: 'La cantidad aumentarÃ¡ automÃ¡ticamente despuÃ©s del escaneo',
                partsList: 'Lista de Partes',
                completed: 'Completado',
                save: 'Guardar',
                reset: 'Reiniciar',
                home: 'Inicio',
                registeredQuantity: 'Cant. Registrada',
                scannedQuantity: 'Cant. Escaneada',
                quantityExceeded: 'No puede exceder la cantidad registrada.',
                incompleteParts: 'Las siguientes partes no estÃ¡n completadas:',
                continueSave: 'Â¿Continuar guardando?',
                saveSuccess: 'El procesamiento de entrada ha sido guardado.',
                resetConfirm: 'Â¿Reiniciar todos los datos?',
                unsavedData: 'Hay datos sin guardar. Â¿Ir al inicio?',
                invalidBarcode: 'Formato de cÃ³digo de barras invÃ¡lido.',
                unregisteredPart: 'Parte no registrada:',
                duplicateBox: 'Caja ya escaneada:',
                quantityOverflow: 'Â¡Desbordamiento de cantidad!',
                scanComplete: 'Â¡Escaneo completo!',
                partComplete: 'Â¡Completado! ğŸ‰',
                barcodeError: 'Error al procesar el cÃ³digo de barras.'
            }
        };

        let currentLanguage = localStorage.getItem('language') || 'ko';
        let currentParts = [];
        let scannedParts = {};

        // ì–¸ì–´ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateLanguage() {
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    element.textContent = translations[currentLanguage][key];
                }
            });
        }

        // í˜„ì¬ ì‹œê°„ í‘œì‹œ
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit',
                timeZone: 'America/Chicago'
            });
            document.getElementById('currentTime').textContent = timeString;
        }
        
        updateTime();
        setInterval(updateTime, 1000);

        // ì»¨í…Œì´ë„ˆ ì„ íƒ ì‹œ íŒŒíŠ¸ ë¡œë“œ
        function loadParts() {
            const containerId = document.getElementById('containerSelect').value;
            if (!containerId) {
                document.getElementById('partsSection').style.display = 'none';
                return;
            }

            // ìƒ˜í”Œ ë°ì´í„° (ì‹¤ì œë¡œëŠ” APIì—ì„œ ê°€ì ¸ì˜´)
            currentParts = [
                { partNumber: 'P49601S9000', quantity: 80, scanned: 0 },
                { partNumber: 'P49602S8000', quantity: 50, scanned: 0 },
                { partNumber: 'P49603S7000', quantity: 30, scanned: 0 },
                { partNumber: 'P49604S6000', quantity: 100, scanned: 0 },
                { partNumber: 'P49605S5000', quantity: 25, scanned: 0 }
            ];

            scannedParts = {};
            renderPartsList();
            document.getElementById('partsSection').style.display = 'block';
            
            // ìŠ¤ìº” ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                document.getElementById('barcodeInput').focus();
            }, 100);
        }

        // íŒŒíŠ¸ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
        function renderPartsList() {
            const partsList = document.getElementById('partsList');
            partsList.innerHTML = '';

            currentParts.forEach((part, index) => {
                const partRow = document.createElement('div');
                partRow.className = `part-row p-4 ${getPartRowClass(part)}`;
                partRow.innerHTML = `
                    <div class="grid grid-cols-4 gap-4 items-center">
                        <div class="col-span-1">
                            <div class="font-bold text-gray-800">${part.partNumber}</div>
                        </div>
                        <div class="col-span-1 text-center">
                            <div class="text-lg font-bold text-blue-600">${part.quantity}</div>
                            <div class="text-xs text-gray-500">${translations[currentLanguage].registeredQuantity}</div>
                        </div>
                        <div class="col-span-1 text-center">
                            <div class="text-lg font-bold ${(part.scanned || 0) === part.quantity ? 'text-green-600' : 'text-orange-600'}">${part.scanned || 0}</div>
                            <div class="text-xs text-gray-500">${translations[currentLanguage].scannedQuantity}</div>
                        </div>
                        <div class="col-span-1">
                            <input type="number" 
                                   class="scan-input w-full text-center" 
                                   placeholder="0"
                                   value="${part.scanned || 0}"
                                   min="0" 
                                   max="${part.quantity}"
                                   onchange="updateScannedQuantity('${part.partNumber}', this.value)"
                                   ${(part.scanned || 0) >= part.quantity ? 'disabled' : ''}>
                        </div>
                    </div>
                `;
                partsList.appendChild(partRow);
            });

            updateProgress();
        }

        // íŒŒíŠ¸ í–‰ í´ë˜ìŠ¤ ê²°ì •
        function getPartRowClass(part) {
            const scanned = part.scanned || 0;
            if (scanned === part.quantity) {
                return 'completed';
            } else if (scanned > part.quantity) {
                return 'disabled';
            } else {
                return 'incomplete';
            }
        }

        // ìŠ¤ìº” ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸
        function updateScannedQuantity(partNumber, value) {
            const quantity = parseInt(value) || 0;
            const part = currentParts.find(p => p.partNumber === partNumber);
            
            if (part) {
                if (quantity > part.quantity) {
                    alert(translations[currentLanguage].quantityExceeded);
                    return;
                }
                part.scanned = quantity;
                
                // scannedPartsë¥¼ ê°ì²´ êµ¬ì¡°ë¡œ í†µì¼
                if (!scannedParts[partNumber]) {
                    scannedParts[partNumber] = {
                        quantity: 0,
                        uniqueNumbers: []
                    };
                }
                scannedParts[partNumber].quantity = quantity;
                
                renderPartsList();
            }
        }

        // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
        function updateProgress() {
            const completed = currentParts.filter(part => (part.scanned || 0) === part.quantity).length;
            const total = currentParts.length;
            
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('totalCount').textContent = total;
        }

        // ì €ì¥
        function saveInbound() {
            const containerId = document.getElementById('containerSelect').value;
            const incompleteParts = currentParts.filter(part => (part.scanned || 0) < part.quantity);
            
            if (incompleteParts.length > 0) {
                const incompleteList = incompleteParts.map(p => p.partNumber).join(', ');
                if (!confirm(`${translations[currentLanguage].incompleteParts}\n${incompleteList}\n\n${translations[currentLanguage].continueSave}`)) {
                    return;
                }
            }

            // ì‹¤ì œë¡œëŠ” API í˜¸ì¶œ
            showStatus(translations[currentLanguage].saveSuccess, 'success');
            
            // 2ì´ˆ í›„ ì´ˆê¸°í™”
            setTimeout(() => {
                resetInbound();
            }, 2000);
        }

        // ì´ˆê¸°í™”
        function resetInbound() {
            if (confirm(translations[currentLanguage].resetConfirm)) {
                document.getElementById('containerSelect').value = '';
                currentParts = [];
                scannedParts = {};
                document.getElementById('partsSection').style.display = 'none';
                document.getElementById('statusMessage').style.display = 'none';
                
                // ìŠ¤ìº” ì…ë ¥ì°½ ì´ˆê¸°í™”
                document.getElementById('barcodeInput').value = '';
                
                // íƒ€ì´ë¨¸ í´ë¦¬ì–´
                if (barcodeInputTimer) {
                    clearTimeout(barcodeInputTimer);
                    barcodeInputTimer = null;
                }
            }
        }

        // í™ˆìœ¼ë¡œ ì´ë™
        function goHome() {
            const hasScannedData = Object.keys(scannedParts).length > 0 && 
                                 Object.values(scannedParts).some(data => data.quantity > 0);
            
            if (hasScannedData) {
                if (confirm(translations[currentLanguage].unsavedData)) {
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        }

        // ë°”ì½”ë“œ ìŠ¤ìº” ì²˜ë¦¬
        function handleBarcodeScan(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const barcode = document.getElementById('barcodeInput').value.trim();
                
                if (barcode) {
                    processBarcode(barcode);
                    document.getElementById('barcodeInput').value = '';
                }
                
                // í¬ì»¤ìŠ¤ ìœ ì§€
                setTimeout(() => {
                    document.getElementById('barcodeInput').focus();
                }, 50);
            }
        }

        // ìë™ ì—”í„°í‚¤ ì²˜ë¦¬ (ë°”ì½”ë“œ ìŠ¤ìºë„ˆìš©)
        let barcodeInputTimer = null;
        function handleBarcodeInput(event) {
            const input = event.target;
            const value = input.value;
            
            // ì´ì „ íƒ€ì´ë¨¸ í´ë¦¬ì–´
            if (barcodeInputTimer) {
                clearTimeout(barcodeInputTimer);
            }
            
            // ë°”ì½”ë“œ íŒ¨í„´ í™•ì¸ (ì‹¤ì œ ë°”ì½”ë“œ í˜•ì‹ê³¼ ìœ ì‚¬í•œì§€)
            const isBarcodePattern = /^[)>*].*P\d{5}S\d{4}.*7Q\d+.*3SP\d+.*\*EOT$/.test(value);
            
            // ë°”ì½”ë“œ ê¸¸ì´ê°€ 30ì ì´ìƒì´ê±°ë‚˜ ë°”ì½”ë“œ íŒ¨í„´ì´ ë§ìœ¼ë©´ ìë™ ì—”í„°
            if (value.length >= 30 || (value.length >= 20 && isBarcodePattern)) {
                barcodeInputTimer = setTimeout(() => {
                    // ì—”í„°í‚¤ ì´ë²¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜
                    const enterEvent = new KeyboardEvent('keypress', {
                        key: 'Enter',
                        code: 'Enter',
                        keyCode: 13,
                        which: 13,
                        bubbles: true,
                        cancelable: true
                    });
                    input.dispatchEvent(enterEvent);
                }, 50); // 50ms ëŒ€ê¸° (ë” ë¹ ë¥¸ ì‘ë‹µ)
            }
        }

        // ë°”ì½”ë“œ íŒŒì‹± ë° ì²˜ë¦¬
        function processBarcode(barcode) {
            try {
                // ë°”ì½”ë“œ íŒŒì‹±
                const parsedData = parseBarcode(barcode);
                
                if (!parsedData) {
                    showStatus(translations[currentLanguage].invalidBarcode, 'error');
                    return;
                }

                const { partNumber, quantity, uniqueNumber } = parsedData;
                
                // íŒŒíŠ¸ ì°¾ê¸°
                const part = currentParts.find(p => p.partNumber === partNumber);
                
                if (!part) {
                    showStatus(`${translations[currentLanguage].unregisteredPart} ${partNumber}`, 'error');
                    return;
                }

                // ìœ ë‹ˆí¬ ë„˜ë²„ ì¤‘ë³µ ì²´í¬
                if (scannedParts[partNumber] && scannedParts[partNumber].uniqueNumbers && 
                    scannedParts[partNumber].uniqueNumbers.includes(uniqueNumber)) {
                    showStatus(`${translations[currentLanguage].duplicateBox} ${uniqueNumber}`, 'error');
                    return;
                }

                // ìˆ˜ëŸ‰ ì²´í¬ - scannedPartsê°€ ìˆ«ìì¸ ê²½ìš°ë„ ì²˜ë¦¬
                let currentScanned = 0;
                if (scannedParts[partNumber]) {
                    if (typeof scannedParts[partNumber] === 'number') {
                        currentScanned = scannedParts[partNumber];
                        // ìˆ«ìì¸ ê²½ìš° ê°ì²´ë¡œ ë³€í™˜
                        scannedParts[partNumber] = {
                            quantity: currentScanned,
                            uniqueNumbers: []
                        };
                    } else {
                        currentScanned = scannedParts[partNumber].quantity || 0;
                    }
                }
                
                const newTotal = currentScanned + quantity;
                
                if (newTotal > part.quantity) {
                    showStatus(`${partNumber} ${translations[currentLanguage].quantityOverflow} (${newTotal}/${part.quantity})`, 'error');
                    return;
                }

                // ìŠ¤ìº” ë°ì´í„° ì—…ë°ì´íŠ¸
                if (!scannedParts[partNumber]) {
                    scannedParts[partNumber] = {
                        quantity: 0,
                        uniqueNumbers: []
                    };
                }
                
                scannedParts[partNumber].quantity = newTotal;
                scannedParts[partNumber].uniqueNumbers.push(uniqueNumber);
                
                // íŒŒíŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸
                part.scanned = newTotal;
                renderPartsList();
                
                // ì„±ê³µ ë©”ì‹œì§€
                showStatus(`${partNumber} ${translations[currentLanguage].scanComplete} (${newTotal}/${part.quantity})`, 'success');
                
                // ì™„ë£Œëœ ê²½ìš° íŠ¹ë³„í•œ í”¼ë“œë°±
                if (newTotal === part.quantity) {
                    showStatus(`${partNumber} ${translations[currentLanguage].partComplete}`, 'success');
                }
                
            } catch (error) {
                showStatus(translations[currentLanguage].barcodeError, 'error');
                console.error('Barcode processing error:', error);
            }
        }

        // ë°”ì½”ë“œ íŒŒì‹± í•¨ìˆ˜
        function parseBarcode(barcode) {
            // ì˜ˆì‹œ: [)>*06:D032125:5K:23L :24L :P49601S9000:7Q80:3SP11000321253583:VP1100*EOT
            
            try {
                // íŒŒíŠ¸ ë²ˆí˜¸ ì¶”ì¶œ (P49601S9000 -> P49601S9000) - ì›ë³¸ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                const partMatch = barcode.match(/P\d{5}S\d{4}/);
                if (!partMatch) {
                    return null;
                }
                const partNumber = partMatch[0]; // Pì™€ Së¥¼ í¬í•¨í•œ ì›ë³¸ íŒŒíŠ¸ ë²ˆí˜¸
                
                // ìˆ˜ëŸ‰ ì¶”ì¶œ (7Q80 -> 80)
                const quantityMatch = barcode.match(/7Q(\d+)/);
                if (!quantityMatch) {
                    return null;
                }
                const quantity = parseInt(quantityMatch[1]);
                
                // ìœ ë‹ˆí¬ ë„˜ë²„ ì¶”ì¶œ (3SP11000321253583:VP1100 -> P11000321253583)
                const uniqueMatch = barcode.match(/3S(P\d+)/);
                if (!uniqueMatch) {
                    return null;
                }
                const uniqueNumber = uniqueMatch[1];
                
                return {
                    partNumber,
                    quantity,
                    uniqueNumber
                };
                
            } catch (error) {
                console.error('Barcode parsing error:', error);
                return null;
            }
        }

        // ë°”ì½”ë“œ ì…ë ¥ì°½ ì´ˆê¸°í™”
        function clearBarcodeInput() {
            document.getElementById('barcodeInput').value = '';
            document.getElementById('barcodeInput').focus();
        }

        // ìƒíƒœ ë©”ì‹œì§€ í‘œì‹œ
        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            const statusText = document.getElementById('statusText');
            
            statusText.textContent = message;
            statusMessage.className = `glass-card p-4 rounded-xl text-center ${type === 'success' ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500'}`;
            statusMessage.style.display = 'block';
            
            setTimeout(() => {
                statusMessage.style.display = 'none';
            }, 3000);
        }

        // ì¸ì¦ í™•ì¸
        function checkAuth() {
            const authToken = localStorage.getItem('authToken');
            const userMode = localStorage.getItem('userMode');
            
            if (!authToken) {
                window.location.href = '../login.html';
                return;
            }
            
            if (userMode !== 'pda') {
                localStorage.removeItem('userMode');
                window.location.href = '../login.html';
                return;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        function initializePage() {
            // ì–¸ì–´ ì„¤ì • ì´ˆê¸°í™”
            updateLanguage();
            
            // ì¸ì¦ í™•ì¸
            checkAuth();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ì‹¤í–‰
        initializePage();

        // í„°ì¹˜ í”¼ë“œë°± ê°œì„ 
        document.addEventListener('touchstart', function() {}, {passive: true});
        document.addEventListener('touchmove', function() {}, {passive: true});

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë°”ì½”ë“œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
        setTimeout(() => {
            document.getElementById('barcodeInput').focus();
        }, 500);

        // ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ì²˜ë¦¬
        document.getElementById('containerSelect').addEventListener('focus', function() {
            // ë“œë¡­ë‹¤ìš´ì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•ŒëŠ” ë°”ì½”ë“œ ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ë°©ì§€
            this.dataset.dropdownFocused = 'true';
        });

        document.getElementById('containerSelect').addEventListener('blur', function() {
            // ë“œë¡­ë‹¤ìš´ì—ì„œ í¬ì»¤ìŠ¤ê°€ ë²—ì–´ë‚˜ë©´ ë°”ì½”ë“œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            delete this.dataset.dropdownFocused;
            setTimeout(() => {
                if (!this.dataset.dropdownFocused) {
                    document.getElementById('barcodeInput').focus();
                }
            }, 200);
        });

        // í¬ì»¤ìŠ¤ ìœ ì§€ ê¸°ëŠ¥ (ë“œë¡­ë‹¤ìš´ ì œì™¸)
        document.addEventListener('click', function(event) {
            // ë“œë¡­ë‹¤ìš´ì´ë‚˜ ê´€ë ¨ ìš”ì†Œ í´ë¦­ ì‹œ í¬ì»¤ìŠ¤ ìœ ì§€í•˜ì§€ ì•ŠìŒ
            if (event.target.closest('select') || event.target.closest('option')) {
                return;
            }
            
            // ë“œë¡­ë‹¤ìš´ì´ í¬ì»¤ìŠ¤ëœ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ë°”ì½”ë“œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            const containerSelect = document.getElementById('containerSelect');
            if (!containerSelect.dataset.dropdownFocused) {
                setTimeout(() => {
                    document.getElementById('barcodeInput').focus();
                }, 100);
            }
        });

        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ë¡œ í¬ì»¤ìŠ¤ ìœ ì§€ (ë“œë¡­ë‹¤ìš´ ì œì™¸)
        document.addEventListener('keydown', function(event) {
            // ë“œë¡­ë‹¤ìš´ì´ ì—´ë ¤ìˆê±°ë‚˜ ê´€ë ¨ ìš”ì†Œì— í¬ì»¤ìŠ¤ê°€ ìˆì„ ë•ŒëŠ” ê±´ë„ˆë›°ê¸°
            if (event.target.closest('select') || event.target.closest('option')) {
                return;
            }
            
            // ë“œë¡­ë‹¤ìš´ì´ í¬ì»¤ìŠ¤ëœ ìƒíƒœê°€ ì•„ë‹ ë•Œë§Œ ë°”ì½”ë“œ ì…ë ¥ì°½ì— í¬ì»¤ìŠ¤
            const containerSelect = document.getElementById('containerSelect');
            if (!containerSelect.dataset.dropdownFocused && event.target.id !== 'barcodeInput') {
                document.getElementById('barcodeInput').focus();
            }
        });
    </script>
</body>
</html> 