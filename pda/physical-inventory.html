<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title data-i18n="physical_inventory_title">실사 재고 - PDA</title>
    
    <!-- Supabase 클라이언트 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- i18n 스크립트 -->
    <script src="../js/i18n.js"></script>
    
    <!-- Supabase 설정 -->
    <script src="../js/config.js"></script>
    
    <!-- 개발 환경에서만 Tailwind CDN 사용 -->
    <script>
        // 개발 환경 확인
        const isDevelopment = window.location.hostname === 'localhost' || 
                            window.location.hostname === '127.0.0.1' || 
                            window.location.protocol === 'file:';
        
        if (isDevelopment) {
            // 개발 환경에서는 CDN 사용
            const script = document.createElement('script');
            script.src = 'https://cdn.tailwindcss.com';
            document.head.appendChild(script);
        } else {
            // 프로덕션 환경에서는 로컬 CSS 사용
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = '../css/tailwind.css';
            document.head.appendChild(link);
        }
    </script>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script>
        // Tailwind 설정은 CDN 로드 후에 실행
        function configureTailwind() {
            if (window.tailwind) {
                tailwind.config = {
                    theme: {
                        extend: {
                            colors: {
                                primary: '#3B82F6',
                                secondary: '#64748B',
                                success: '#10B981',
                                warning: '#F59E0B',
                                danger: '#EF4444'
                            },
                            animation: {
                                'fade-in': 'fadeIn 0.5s ease-in-out',
                                'slide-up': 'slideUp 0.5s ease-out',
                                'bounce-in': 'bounceIn 0.6s ease-out',
                                'float': 'float 3s ease-in-out infinite',
                                'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                            },
                            keyframes: {
                                fadeIn: {
                                    '0%': { opacity: '0' },
                                    '100%': { opacity: '1' }
                                },
                                slideUp: {
                                    '0%': { transform: 'translateY(20px)', opacity: '0' },
                                    '100%': { transform: 'translateY(0)', opacity: '1' }
                                },
                                bounceIn: {
                                    '0%': { transform: 'scale(0.3)', opacity: '0' },
                                    '50%': { transform: 'scale(1.05)' },
                                    '70%': { transform: 'scale(0.9)' },
                                    '100%': { transform: 'scale(1)', opacity: '1' }
                                },
                                float: {
                                    '0%, 100%': { transform: 'translateY(0px)' },
                                    '50%': { transform: 'translateY(-10px)' }
                                }
                            }
                        }
                    }
                }
            } else {
                // CDN이 아직 로드되지 않았다면 잠시 후 다시 시도
                setTimeout(configureTailwind, 100);
            }
        }
        
        // 페이지 로드 시 Tailwind 설정
        document.addEventListener('DOMContentLoaded', configureTailwind);
    </script>
    <style>
        /* PDA 최적화 스타일 */
        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .action-button {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            border: none;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            padding: 12px 20px;
            font-size: 16px;
            font-weight: 600;
        }
        
        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .action-button:active::before {
            left: 100%;
        }
        
        .action-button:active {
            transform: scale(0.98);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }
        
        .cancel-btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }
        
        .dropdown-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .dropdown-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .scan-input {
            width: 100%;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 18px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
        }
        
        .scan-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }
        
        .main-menu-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            border-radius: 12px;
            padding: 12px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);
            margin-bottom: 20px;
        }
        
        .main-menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }
        
        .main-menu-btn:active {
            transform: scale(0.98);
        }
        
        .language-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        
        .language-btn {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            padding: 8px 16px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .language-btn:hover {
            background: rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
        }
        
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: none;
        }
        
        .language-dropdown.show {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .language-option {
            padding: 12px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .language-option:last-child {
            border-bottom: none;
        }
        
        .language-option:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .language-option.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            font-weight: 600;
        }
        
        /* 실사 재고 전용 스타일 */
        .physical-inventory-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .session-info {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .scan-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .manual-add-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .parts-list {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .parts-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .parts-table th,
        .parts-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        .parts-table th {
            background: rgba(248, 250, 252, 0.8);
            font-weight: bold;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-scanned {
            background: rgba(16, 185, 129, 0.2);
            color: #065f46;
        }
        
        .status-manual {
            background: rgba(245, 158, 11, 0.2);
            color: #92400e;
        }
        
        .progress-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            transition: width 0.3s ease;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #374151;
        }
        
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            background: white;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
            border-color: rgba(16, 185, 129, 0.2);
        }
        
        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            color: #991b1b;
            border-color: rgba(239, 68, 68, 0.2);
        }
        
        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            color: #1e40af;
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            margin: 15% auto;
            padding: 20px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .close {
            color: #64748b;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        
        .close:hover {
            color: #374151;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <!-- 언어 선택기 -->
    <div class="language-selector">
        <button class="language-btn" onclick="toggleLanguageDropdown()">
            <i class="fas fa-globe mr-2"></i>
            <span id="currentLanguage">한국어</span>
            <i class="fas fa-chevron-down ml-2"></i>
        </button>
        <div class="language-dropdown" id="languageDropdown">
            <div class="language-option active" onclick="changeLanguage('ko')">
                <i class="fas fa-flag mr-2"></i><span data-i18n="korean">한국어</span>
            </div>
            <div class="language-option" onclick="changeLanguage('en')">
                <i class="fas fa-flag mr-2"></i><span data-i18n="english">English</span>
            </div>
            <div class="language-option" onclick="changeLanguage('es')">
                <i class="fas fa-flag mr-2"></i><span data-i18n="spanish">Español</span>
            </div>
        </div>
    </div>

    <div class="physical-inventory-container">
        <!-- 메인 메뉴 버튼 -->
        <button onclick="window.location.href='index.html'" class="main-menu-btn">
            <i class="fas fa-home mr-2"></i>
            <span data-i18n="main_menu">메인 메뉴</span>
        </button>
        
        <h1 class="text-3xl font-bold text-white mb-6" data-i18n="physical_inventory_title">실사 재고</h1>
        
        <!-- 세션 정보 -->
        <div class="session-info">
            <h3 class="text-xl font-bold mb-4" data-i18n="session_info">세션 정보</h3>
            <div class="form-group">
                <label for="sessionName" data-i18n="session_name">세션명:</label>
                <input type="text" id="sessionName" class="form-control" data-i18n-placeholder="session_name_placeholder" placeholder="예: 2024년 1월 실사">
            </div>
            <div class="form-group">
                <label for="sessionDate" data-i18n="inventory_date">실사 날짜:</label>
                <input type="date" id="sessionDate" class="form-control" value="">
            </div>
        </div>
        
        <!-- 바코드 스캔 섹션 -->
        <div class="scan-section">
            <h3 class="text-xl font-bold mb-4" data-i18n="barcode_scan">바코드 스캔</h3>
            <input type="text" id="barcodeInput" class="scan-input" data-i18n-placeholder="barcode_scan_placeholder" placeholder="바코드를 스캔하세요..." autocomplete="off">
            <div id="scanAlert" class="alert" style="display: none;"></div>
        </div>
        
        <!-- 수동 등록 버튼 -->
        <div class="manual-add-button-section">
            <button type="button" class="action-button btn-warning" onclick="toggleManualAdd()">
                <i class="fas fa-plus"></i> <span data-i18n="manual_registration">수동 등록</span>
            </button>
        </div>
        
        <!-- 수동 등록 섹션 (기본적으로 숨김) -->
        <div id="manualAddSection" class="manual-add-section" style="display: none;">
            <h3 class="text-xl font-bold mb-4" data-i18n="manual_registration">수동 등록</h3>
            <div class="form-group">
                <label for="manualPartNumber" data-i18n="part_number">파트 번호:</label>
                <select id="manualPartNumber" class="dropdown-select">
                    <option value="" data-i18n="select_part">파트를 선택하세요</option>
                </select>
            </div>
            <div class="form-group">
                <label for="manualQuantity" data-i18n="inventory_quantity">수량:</label>
                <input type="number" id="manualQuantity" class="form-control" data-i18n-placeholder="inventory_quantity_placeholder" placeholder="실사 수량을 입력하세요" min="0">
            </div>
            <div class="action-buttons">
                <button type="button" class="action-button btn-success" onclick="addManualPart()" data-i18n="add">등록</button>
                <button type="button" class="cancel-btn" onclick="toggleManualAdd()" data-i18n="cancel">취소</button>
            </div>
        </div>
        
        <!-- 진행률 및 수량 확인 -->
        <div class="progress-section">
            <h3 class="text-xl font-bold mb-4" data-i18n="progress">진행률 및 수량 확인</h3>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%"></div>
            </div>
            <p id="progressText" class="mt-2 font-semibold" data-i18n="scanned_items">스캔된 항목: 0개</p>
            
            <!-- 수량 요약 카드 -->
            <div class="grid grid-cols-2 gap-4 mt-4" id="quantitySummary" style="display: none;">
                <div class="bg-green-100 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-green-600" id="totalScannedQty">0</div>
                    <div class="text-sm text-green-700">총 스캔 수량</div>
                </div>
                <div class="bg-blue-100 p-3 rounded-lg text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalDbQty">0</div>
                    <div class="text-sm text-blue-700">DB 재고 수량</div>
                </div>
            </div>
        </div>
        
        <!-- 파트 목록 -->
        <div class="parts-list">
            <h3 class="text-xl font-bold p-4" data-i18n="inventory_items_list">실사 항목 목록</h3>
            <table class="parts-table">
                <thead>
                    <tr>
                        <th data-i18n="part_number">파트 번호</th>
                        <th data-i18n="db_stock">DB 재고</th>
                        <th data-i18n="physical_stock">실사 수량</th>
                        <th data-i18n="difference">차이</th>
                        <th data-i18n="registration_method">등록 방식</th>
                        <th data-i18n="registration_time">등록 시간</th>
                        <th data-i18n="action">작업</th>
                    </tr>
                </thead>
                <tbody id="partsTableBody">
                    <!-- 동적으로 생성됨 -->
                </tbody>
            </table>
        </div>
        
        <!-- 액션 버튼 -->
        <div class="action-buttons">
            <button type="button" class="action-button btn-success" onclick="savePhysicalInventory()" data-i18n="save_inventory">실사 저장</button>
            <button type="button" class="action-button btn-warning" onclick="refreshDbStock()" data-i18n="refresh_db_stock">DB 재고 새로고침</button>
            <button type="button" class="action-button btn-info" onclick="viewSavedData()">저장된 데이터 확인</button>
            <button type="button" class="action-button btn-primary" onclick="clearAll()" data-i18n="clear_all">전체 초기화</button>
        </div>
    </div>
    
    <!-- 확인 모달 -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="text-xl font-bold" data-i18n="save_confirmation">실사 저장 확인</h3>
                <span class="close" onclick="closeConfirmModal()">&times;</span>
            </div>
            <p class="mb-4" data-i18n="save_confirmation_text">현재 스캔된 모든 항목을 실사 세션으로 저장하시겠습니까?</p>
            <div class="action-buttons">
                <button type="button" class="action-button btn-success" onclick="confirmSave()" data-i18n="save">저장</button>
                <button type="button" class="action-button btn-danger" onclick="closeConfirmModal()" data-i18n="cancel">취소</button>
            </div>
        </div>
    </div>
    
    <!-- 하단 고정 홈 버튼 -->
    <div class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50">
        <button onclick="window.location.href='index.html'"
                class="bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-4 rounded-full shadow-lg flex items-center space-x-2 transition-all duration-300 transform hover:scale-105">
            <i class="fas fa-home text-xl"></i>
            <span class="font-semibold" data-i18n="main_menu">메인 메뉴</span>
        </button>
    </div>
    
    <script>
        // 언어 선택기 토글
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            dropdown.classList.toggle('show');
        }

        // 언어 변경
        function changeLanguage(lang) {
            // 언어 설정
            i18n.setLanguage(lang);
            
            // 현재 언어 표시 업데이트
            const currentLanguageElement = document.getElementById('currentLanguage');
            const languageNames = {
                'ko': '한국어',
                'en': 'English',
                'es': 'Español'
            };
            currentLanguageElement.textContent = languageNames[lang];
            
            // 드롭다운 닫기
            document.getElementById('languageDropdown').classList.remove('show');
            
            // 활성 옵션 업데이트
            document.querySelectorAll('.language-option').forEach(option => {
                option.classList.remove('active');
            });
            event.currentTarget.classList.add('active');
        }

        // 페이지 외부 클릭 시 드롭다운 닫기
        document.addEventListener('click', function(event) {
            const languageSelector = document.querySelector('.language-selector');
            if (!languageSelector.contains(event.target)) {
                document.getElementById('languageDropdown').classList.remove('show');
            }
        });

        // 페이지 로드 시 현재 언어 표시 업데이트
        document.addEventListener('DOMContentLoaded', function() {
            const currentLanguage = i18n.currentLanguage;
            const languageNames = {
                'ko': '한국어',
                'en': 'English',
                'es': 'Español'
            };
            document.getElementById('currentLanguage').textContent = languageNames[currentLanguage];
        });

        // Supabase 설정
        const supabaseUrl = 'https://vzemucykhxlxgjuldibf.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6ZW11Y3lraHhseGdqdWxkaWJmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMzNzA4MjcsImV4cCI6MjA2ODk0NjgyN30.L9DN-V33rQj6atDnDhVeIOyzGP5I_3uVWSVfMObqrbQ';
        
        // Supabase 클라이언트 초기화
        let supabase;
        
        function initializeSupabase() {
            try {
                if (window.supabase) {
                    supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                    console.log('Supabase 클라이언트 초기화 성공');
                    return true;
                } else {
                    throw new Error('Supabase 라이브러리가 로드되지 않았습니다.');
                }
            } catch (error) {
                console.error('Supabase 클라이언트 초기화 실패:', error);
                return false;
            }
        }
        
        // 페이지 로드 후 Supabase 초기화 시도
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                if (!initializeSupabase()) {
                    alert(i18n.t('supabase_connection_failed'));
                }
            });
        } else {
            if (!initializeSupabase()) {
                alert(i18n.t('supabase_connection_failed'));
            }
        }
        
        // 전역 변수
        let scannedParts = {};
        let scannedUniqueIds = new Set(); // 고유번호 추적용
        let currentSessionId = null;
        let partsList = []; // 파트 목록 저장
        let dbInventory = {}; // DB 재고 캐시
        
        // DB 연결 테스트 함수
        async function testDbConnection() {
            try {
                console.log('=== DB 연결 테스트 시작 ===');
                
                if (!supabase) {
                    throw new Error('Supabase 클라이언트가 초기화되지 않았습니다.');
                }
                
                // 1. parts 테이블 연결 테스트
                console.log('parts 테이블 연결 테스트...');
                const { data: partsData, error: partsError } = await supabase
                    .from('parts')
                    .select('part_number')
                    .limit(1);
                
                if (partsError) {
                    console.error('parts 테이블 연결 실패:', partsError);
                    throw partsError;
                }
                console.log('parts 테이블 연결 성공');
                
                // 2. inventory 테이블 연결 테스트
                console.log('inventory 테이블 연결 테스트...');
                const { data: inventoryData, error: inventoryError } = await supabase
                    .from('inventory')
                    .select('part_number, current_stock')
                    .limit(1);
                
                if (inventoryError) {
                    console.error('inventory 테이블 연결 실패:', inventoryError);
                    throw inventoryError;
                }
                console.log('inventory 테이블 연결 성공');
                
                // 3. physical_inventory_sessions 테이블 구조 확인
                console.log('physical_inventory_sessions 테이블 구조 확인...');
                try {
                    const { data: sessionData, error: sessionError } = await supabase
                        .from('physical_inventory_sessions')
                        .select('*')
                        .limit(1);
                    
                    if (sessionError) {
                        console.warn('physical_inventory_sessions 테이블 조회 실패:', sessionError);
                    } else {
                        console.log('physical_inventory_sessions 테이블 구조:', sessionData);
                    }
                } catch (e) {
                    console.warn('physical_inventory_sessions 테이블이 존재하지 않을 수 있습니다:', e);
                }
                
                // 4. physical_inventory_items 테이블 구조 확인
                console.log('physical_inventory_items 테이블 구조 확인...');
                try {
                    const { data: itemsData, error: itemsError } = await supabase
                        .from('physical_inventory_items')
                        .select('*')
                        .limit(1);
                    
                    if (itemsError) {
                        console.warn('physical_inventory_items 테이블 조회 실패:', itemsError);
                    } else {
                        console.log('physical_inventory_items 테이블 구조:', itemsData);
                    }
                } catch (e) {
                    console.warn('physical_inventory_items 테이블이 존재하지 않을 수 있습니다:', e);
                }
                
                console.log('=== DB 연결 테스트 완료 ===');
                return true;
            } catch (error) {
                console.error('DB 연결 테스트 실패:', error);
                showAlert(`DB 연결 테스트 실패: ${error.message}`, 'danger');
                return false;
            }
        }

        // 전체 파트 DB 재고 로드 함수 (개선된 버전)
        async function loadAllPartsDbStock() {
            try {
                console.log('=== 전체 파트 DB 재고 로드 시작 ===');
                
                if (!supabase) {
                    throw new Error('Supabase 클라이언트가 초기화되지 않았습니다.');
                }
                
                // 1. 먼저 parts 테이블에서 모든 파트 번호 조회
                console.log('parts 테이블에서 파트 목록 조회 중...');
                const { data: partsData, error: partsError } = await supabase
                    .from('parts')
                    .select('part_number')
                    .order('part_number');
                
                if (partsError) {
                    console.error('parts 테이블 조회 오류:', partsError);
                    throw partsError;
                }
                
                console.log(`parts 테이블에서 ${partsData.length}개 파트 발견`);
                
                // 2. inventory 테이블에서 재고 조회
                console.log('inventory 테이블에서 재고 조회 중...');
                const { data: inventoryData, error: inventoryError } = await supabase
                    .from('inventory')
                    .select('part_number, current_stock, last_updated')
                    .order('part_number');
                
                if (inventoryError) {
                    console.error('inventory 테이블 조회 오류:', inventoryError);
                    throw inventoryError;
                }
                
                console.log(`inventory 테이블에서 ${inventoryData.length}개 재고 정보 발견`);
                
                // 3. 재고 정보를 파트 번호로 매핑
                const stockCache = {};
                const inventoryMap = {};
                
                // inventory 데이터를 파트 번호로 매핑
                inventoryData.forEach(item => {
                    inventoryMap[item.part_number] = item.current_stock || 0;
                });
                
                // 모든 파트에 대해 재고 정보 설정 (없으면 0)
                partsData.forEach(part => {
                    const partNumber = part.part_number;
                    const stock = inventoryMap[partNumber] || 0;
                    stockCache[partNumber] = stock;
                    
                    if (stock > 0) {
                        console.log(`파트 ${partNumber}: 재고 ${stock}개`);
                    }
                });
                
                console.log(`전체 파트 DB 재고 로드 완료: ${Object.keys(stockCache).length}개 파트`);
                console.log('재고가 있는 파트들:', Object.entries(stockCache).filter(([part, stock]) => stock > 0));
                
                return stockCache;
            } catch (error) {
                console.error('전체 파트 DB 재고 로드 중 오류:', error);
                return {};
            }
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', async function() {
            // Supabase 클라이언트 초기화 시도
            if (!supabase) {
                if (!initializeSupabase()) {
                    showAlert('Supabase 연결에 실패했습니다. 페이지를 새로고침해주세요.', 'danger');
                    return;
                }
            }
            
            // DB 연결 테스트
            const dbConnected = await testDbConnection();
            if (!dbConnected) {
                showAlert('데이터베이스 연결에 문제가 있습니다. 일부 기능이 제한될 수 있습니다.', 'warning');
            }
            
            // 오늘 날짜를 기본값으로 설정
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('sessionDate').value = today;
            
            // 세션명 자동 생성
            generateSessionName();
            
            // 파트 목록 로드
            loadPartsList();
            
            // 전체 파트 DB 재고 로드
            dbInventory = await loadAllPartsDbStock();
            
            // 바코드 입력 필드에 포커스
            document.getElementById('barcodeInput').focus();
            
            // 바코드 입력 이벤트 리스너
            document.getElementById('barcodeInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleBarcodeScan();
                }
            });
            
            // 바코드 스캔 시 자동 엔터 처리
            document.getElementById('barcodeInput').addEventListener('input', function(e) {
                // 바코드 스캔은 보통 빠르게 입력되므로, 일정 길이 이상이면 자동으로 엔터
                if (this.value.length >= 10) {
                    setTimeout(() => {
                        if (this.value.length >= 10) {
                            handleBarcodeScan();
                        }
                    }, 100);
                }
            });
            
            // 페이지 클릭 시 바코드 입력 필드에 포커스
            document.addEventListener('click', function(e) {
                // 모달이나 특정 버튼이 아닌 경우에만 포커스
                if (!e.target.closest('#manualAddSection') && 
                    !e.target.closest('#confirmModal') &&
                    !e.target.closest('button[onclick="toggleManualAdd()"]')) {
                    document.getElementById('barcodeInput').focus();
                }
            });
            
            // 전역 키보드 이벤트 리스너 (바코드 스캐너용)
            document.addEventListener('keydown', function(e) {
                // 입력 필드가 포커스되어 있지 않은 경우에만 전역 처리
                const activeElement = document.activeElement;
                const isInputFocused = activeElement && (
                    activeElement.tagName === 'INPUT' || 
                    activeElement.tagName === 'SELECT' || 
                    activeElement.tagName === 'TEXTAREA' ||
                    activeElement.contentEditable === 'true'
                );
                
                if (!isInputFocused) {
                    handleGlobalBarcodeInput(e);
                } else if (e.key === 'Escape' || e.key === 'F1') {
                    // ESC 키나 F1 키로 바코드 입력 필드에 포커스
                    document.getElementById('barcodeInput').focus();
                    e.preventDefault();
                }
            });

            // 전역 바코드 입력 상태 표시
            showGlobalBarcodeStatus();
        });
        
        // 전역 바코드 입력 버퍼
        let globalBarcodeBuffer = '';
        let globalBarcodeTimer = null;
        const BARCODE_TIMEOUT = 100; // 바코드 입력 완료 판단 시간 (ms)

        // 전역 바코드 입력 상태 표시
        function showGlobalBarcodeStatus() {
            // 상태 표시 요소 생성
            const statusElement = document.createElement('div');
            statusElement.id = 'globalBarcodeStatus';
            statusElement.className = 'fixed top-20 right-4 bg-green-100 border border-green-400 text-green-700 px-3 py-2 rounded-lg text-sm z-50';
            statusElement.innerHTML = '<i class="fas fa-barcode mr-2"></i>전역 바코드 스캔 활성화';
            document.body.appendChild(statusElement);
            
            // 3초 후 자동 숨김
            setTimeout(() => {
                if (statusElement) {
                    statusElement.style.opacity = '0.5';
                }
            }, 3000);
        }

        // 전역 바코드 입력 처리 함수
        function handleGlobalBarcodeInput(e) {
            // 특수 키는 무시 (Shift, Ctrl, Alt, Tab, Escape 등)
            if (e.key.length > 1 && !['Enter', 'Backspace'].includes(e.key)) {
                return;
            }

            // Enter 키로 바코드 입력 완료
            if (e.key === 'Enter') {
                e.preventDefault();
                
                if (globalBarcodeBuffer.trim().length > 0) {
                    console.log('전역 바코드 입력 완료:', globalBarcodeBuffer);
                    
                    // 바코드 입력창에 값 설정하고 스캔 실행
                    const barcodeInput = document.getElementById('barcodeInput');
                    if (barcodeInput) {
                        barcodeInput.value = globalBarcodeBuffer;
                        scanBarcode();
                    }
                    
                    // 버퍼 초기화
                    globalBarcodeBuffer = '';
                }
                return;
            }

            // Backspace 키 처리
            if (e.key === 'Backspace') {
                e.preventDefault();
                globalBarcodeBuffer = globalBarcodeBuffer.slice(0, -1);
                return;
            }

            // 일반 문자 입력
            if (e.key.length === 1) {
                e.preventDefault();
                globalBarcodeBuffer += e.key;
                
                // 타이머 리셋 (연속 입력 중)
                if (globalBarcodeTimer) {
                    clearTimeout(globalBarcodeTimer);
                }
                
                // GS1-128 바코드 패턴 확인
                const isGS1BarcodePattern = /^[)>*].*P\d{5}[a-zA-Z]\d{4}.*7Q\d+.*3S[^:]+.*\*EOT$/.test(globalBarcodeBuffer);
                
                // 바코드 길이가 30자 이상이거나 GS1 패턴이 맞으면 자동 엔터
                if (globalBarcodeBuffer.length >= 30 || (globalBarcodeBuffer.length >= 20 && isGS1BarcodePattern)) {
                    globalBarcodeTimer = setTimeout(() => {
                        // 엔터키 이벤트 시뮬레이션
                        const enterEvent = new KeyboardEvent('keydown', {
                            key: 'Enter',
                            code: 'Enter',
                            keyCode: 13,
                            which: 13,
                            bubbles: true,
                            cancelable: true
                        });
                        document.dispatchEvent(enterEvent);
                    }, 50);
                } else {
                    // 일반적인 경우 타이머 설정
                    globalBarcodeTimer = setTimeout(() => {
                        if (globalBarcodeBuffer.trim().length > 0) {
                            console.log('전역 바코드 입력 완료 (타이머):', globalBarcodeBuffer);
                            
                            // 바코드 입력창에 값 설정하고 스캔 실행
                            const barcodeInput = document.getElementById('barcodeInput');
                            if (barcodeInput) {
                                barcodeInput.value = globalBarcodeBuffer;
                                scanBarcode();
                            }
                            
                            // 버퍼 초기화
                            globalBarcodeBuffer = '';
                        }
                    }, BARCODE_TIMEOUT);
                }
            }
        }

        // 세션명 자동 생성 함수
        function generateSessionName() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const sessionName = `${year}년 ${month}월 ${day}일 실사 (${hours}:${minutes})`;
            document.getElementById('sessionName').value = sessionName;
            
            // 세션 날짜도 자동 설정
            const sessionDate = now.toISOString().split('T')[0];
            document.getElementById('sessionDate').value = sessionDate;
        }
        
        // GS1-128 바코드 파싱 함수 (개선된 버전)
        function parseGS1Barcode(barcode) {
            const result = {
                partNumber: null,
                quantity: null,
                uniqueId: null
            };
            
            console.log('바코드 파싱 시작:', barcode);
            
            // 다양한 바코드 형식 지원
            const patterns = [
                // GS1-128 형식: (01) 파트번호 (30) 수량 (10) 고유ID
                /\(01\)(\d{14})\(30\)(\d+)\(10\)(.+)/,
                // GS1-128 형식: (01) 파트번호 (10) 고유ID (30) 수량
                /\(01\)(\d{14})\(10\)(.+)\(30\)(\d+)/,
                // GS1-128 형식: (01) 파트번호 (30) 수량
                /\(01\)(\d{14})\(30\)(\d+)/,
                // GS1-128 형식: (01) 파트번호
                /\(01\)(\d{14})/,
                // 실제 바코드 형식: [)>*06:D032125:5K:23L:24L:P49560S9420:7Q200:3SP11000323253537:VP1100*EOT
                /\[\)>\*06:D(\d+):5K:23L:24L:P([^:]+):7Q(\d+):3S([^:]+):VP(\d+)\*EOT/,
                // 다른 실제 바코드 형식: [)>*06:D032125:5K:23L:24L:P49560S9420:7Q200:3SP11000323253537*EOT
                /\[\)>\*06:D(\d+):5K:23L:24L:P([^:]+):7Q(\d+):3S([^:]+)\*EOT/,
                // 간단한 실제 바코드: [)>*06:P49560S9420:7Q200*EOT
                /\[\)>\*06:P([^:]+):7Q(\d+)\*EOT/,
                // 더 간단한 형식: [)>*06:P49560S9420*EOT
                /\[\)>\*06:P([^:]+)\*EOT/,
                // QR 코드 형식: QR:49560S9420:200:P11000323253537
                /^QR:([^:]+):(\d+):(.+)$/,
                // QR 코드 형식: QR:49560S9420:200
                /^QR:([^:]+):(\d+)$/,
                // QR 코드 형식: QR:49560S9420
                /^QR:([^:]+)$/,
                // 하이픈 포함 파트번호: 49560-S9420:200
                /^(\d+-\w+):(\d+)$/,
                // 하이픈 포함 파트번호만: 49560-S9420
                /^(\d+-\w+)$/,
                // 간단한 파트번호만 있는 경우
                /^(\d{14})$/,
                // 파트번호:수량 형식
                /^(\d{14}):(\d+)$/,
                // 알파벳 포함 파트번호: 49560S9420:200
                /^(\d+\w+):(\d+)$/,
                // 알파벳 포함 파트번호만: 49560S9420
                /^(\d+\w+)$/
            ];
            
            for (let i = 0; i < patterns.length; i++) {
                const pattern = patterns[i];
                const match = barcode.match(pattern);
                if (match) {
                    console.log(`패턴 ${i} 매치됨:`, match);
                    
                    if (i === 4) {
                        // 실제 바코드 형식 처리: [)>*06:D032125:5K:23L:24L:P49560S9420:7Q200:3SP11000323253537:VP1100*EOT
                        result.partNumber = match[2]; // P 뒤의 파트번호 (49560S9420)
                        result.quantity = parseInt(match[3]) || 1; // 7Q 뒤의 수량 (200)
                        result.uniqueId = match[4]; // 3S 뒤의 고유번호 (P11000323253537)
                    } else if (i === 5) {
                        // 다른 실제 바코드 형식: [)>*06:D032125:5K:23L:24L:P49560S9420:7Q200:3SP11000323253537*EOT
                        result.partNumber = match[2];
                        result.quantity = parseInt(match[3]) || 1;
                        result.uniqueId = match[4];
                    } else if (i === 6) {
                        // 간단한 실제 바코드: [)>*06:P49560S9420:7Q200*EOT
                        result.partNumber = match[1];
                        result.quantity = parseInt(match[2]) || 1;
                    } else if (i === 7) {
                        // 더 간단한 형식: [)>*06:P49560S9420*EOT
                        result.partNumber = match[1];
                        result.quantity = 1;
                    } else if (i === 8) {
                        // QR 코드 형식: QR:49560S9420:200:P11000323253537
                        result.partNumber = match[1];
                        result.quantity = parseInt(match[2]) || 1;
                        result.uniqueId = match[3];
                    } else if (i === 9) {
                        // QR 코드 형식: QR:49560S9420:200
                        result.partNumber = match[1];
                        result.quantity = parseInt(match[2]) || 1;
                    } else if (i === 10) {
                        // QR 코드 형식: QR:49560S9420
                        result.partNumber = match[1];
                        result.quantity = 1;
                    } else if (i === 11) {
                        // 하이픈 포함 파트번호: 49560-S9420:200
                        result.partNumber = match[1];
                        result.quantity = parseInt(match[2]) || 1;
                    } else if (i === 12) {
                        // 하이픈 포함 파트번호만: 49560-S9420
                        result.partNumber = match[1];
                        result.quantity = 1;
                    } else if (i === 13) {
                        // 14자리 파트번호만
                        result.partNumber = match[1];
                        result.quantity = 1;
                    } else if (i === 14) {
                        // 파트번호:수량 형식
                        result.partNumber = match[1];
                        result.quantity = parseInt(match[2]);
                    } else if (i === 15) {
                        // 알파벳 포함 파트번호: 49560S9420:200
                        result.partNumber = match[1];
                        result.quantity = parseInt(match[2]) || 1;
                    } else if (i === 16) {
                        // 알파벳 포함 파트번호만: 49560S9420
                        result.partNumber = match[1];
                        result.quantity = 1;
                    } else {
                        // 기존 GS1-128 형식
                        result.partNumber = match[1];
                        if (match[2] && !isNaN(match[2])) {
                            result.quantity = parseInt(match[2]);
                        } else if (match[3] && !isNaN(match[3])) {
                            result.quantity = parseInt(match[3]);
                        } else {
                            result.quantity = 1;
                        }
                        if (match[3] && isNaN(match[3])) {
                            result.uniqueId = match[3];
                        } else if (match[2] && isNaN(match[2])) {
                            result.uniqueId = match[2];
                        }
                    }
                    break;
                }
            }
            
            console.log('파싱 결과:', result);
            return result;
        }
        
        // 바코드 스캔 처리
        function handleBarcodeScan() {
            const barcodeInput = document.getElementById('barcodeInput');
            const barcode = barcodeInput.value.trim();
            
            if (!barcode) {
                showAlert('바코드를 입력해주세요.', 'danger');
                return;
            }
            
            const parsed = parseGS1Barcode(barcode);
            
            if (!parsed.partNumber) {
                showAlert('올바른 바코드 형식이 아닙니다.', 'danger');
                barcodeInput.value = '';
                barcodeInput.focus();
                return;
            }
            
            // 고유번호가 있는 경우 중복 스캔 체크
            if (parsed.uniqueId) {
                if (scannedUniqueIds.has(parsed.uniqueId)) {
                    showAlert('이미 스캔된 고유번호입니다.', 'danger');
                    barcodeInput.value = '';
                    barcodeInput.focus();
                    return;
                }
            }
            
            // 파트 번호에 하이픈 추가 (49560S9420 -> 49560-S9420)
            const formattedPartNumber = parsed.partNumber.replace(/(\d+)([A-Z]\d+)/, '$1-$2');
            console.log(`파트 번호 포맷팅: ${parsed.partNumber} -> ${formattedPartNumber}`);
            
            // 파트 정보 가져오기
            getPartInfo(formattedPartNumber).then(partInfo => {
                if (!partInfo) {
                    showAlert(`파트 번호 ${formattedPartNumber}를 찾을 수 없습니다.`, 'danger');
                    barcodeInput.value = '';
                    barcodeInput.focus();
                    return;
                }
                
                // 스캔된 파트 추가
                const quantity = parsed.quantity || 1;
                addScannedPart(formattedPartNumber, quantity, 'scanned', partInfo.description, parsed.uniqueId);
                
                // 스캔 성공 알림 제거 - 연속 스캔을 위해
                // showAlert(`${partInfo.description} (${formattedPartNumber}) - ${quantity}개 스캔됨`, 'success');
                barcodeInput.value = '';
                // 포커스 복원 (약간의 지연을 두어 UI 업데이트 후 실행)
                setTimeout(() => {
                    barcodeInput.focus();
                }, 50);
            });
        }
        
        // 파트 목록 로드
        async function loadPartsList() {
            try {
                if (!supabase) {
                    throw new Error('Supabase 클라이언트가 초기화되지 않았습니다.');
                }
                
                // description 컬럼이 없을 수 있으므로 part_number와 category만 조회
                const { data, error } = await supabase
                    .from('parts')
                    .select('part_number, category')
                    .order('part_number');
                
                if (error) throw error;
                
                partsList = data || [];
                
                // 드롭다운 업데이트
                const select = document.getElementById('manualPartNumber');
                select.innerHTML = `<option value="" data-i18n="select_part">${i18n.t('select_part_placeholder')}</option>`;
                
                partsList.forEach(part => {
                    const option = document.createElement('option');
                    option.value = part.part_number;
                    // description이 없으므로 category를 사용
                    option.textContent = `${part.part_number} - ${part.category}`;
                    select.appendChild(option);
                });
                
                console.log('파트 목록 로드 완료:', partsList.length + '개');
            } catch (error) {
                console.error('파트 목록 로드 오류:', error);
                showAlert('파트 목록 로드 중 오류가 발생했습니다.', 'danger');
            }
        }
        
        // 파트 정보 가져오기
        async function getPartInfo(partNumber) {
            try {
                if (!supabase) {
                    throw new Error('Supabase 클라이언트가 초기화되지 않았습니다.');
                }
                
                const { data, error } = await supabase
                    .from('parts')
                    .select('part_number, category')
                    .eq('part_number', partNumber)
                    .single();
                
                if (error) throw error;
                
                // description 컬럼이 없으므로 category를 description으로 사용
                return {
                    part_number: data.part_number,
                    description: data.category
                };
            } catch (error) {
                console.error('파트 정보 조회 오류:', error);
                showAlert('파트 정보 조회 중 오류가 발생했습니다.', 'danger');
                return null;
            }
        }
        
        // DB 재고 조회 함수 (캐시 우선 버전)
        function getDbStock(partNumber) {
            console.log(`=== DB 재고 조회: ${partNumber} ===`);
            
            // 캐시에서 재고 조회
            const stock = dbInventory[partNumber] || 0;
            console.log(`캐시에서 재고 조회: ${partNumber} = ${stock}`);
            
            // 재고가 0인 경우 상세 정보 출력
            if (stock === 0) {
                console.warn(`⚠️ 파트 ${partNumber}의 재고가 0입니다.`);
                console.log('현재 캐시된 재고 정보:', Object.entries(dbInventory).filter(([part, stock]) => part.includes(partNumber.split('-')[0])));
            }
            
            return stock;
        }

        // 스캔된 파트 추가 (개선된 버전)
        function addScannedPart(partNumber, quantity, type, description, uniqueId = null) {
            const timestamp = new Date().toLocaleString();
            
            // 고유번호가 있는 경우 Set에 추가
            if (uniqueId) {
                scannedUniqueIds.add(uniqueId);
            }
            
            // DB 재고 조회 (캐시에서)
            const dbStock = getDbStock(partNumber);
            
            if (scannedParts[partNumber]) {
                // 기존 파트가 있으면 수량 업데이트
                scannedParts[partNumber].quantity += quantity;
                scannedParts[partNumber].lastUpdated = timestamp;
                scannedParts[partNumber].difference = scannedParts[partNumber].quantity - dbStock;
            } else {
                // 새로운 파트 추가
                scannedParts[partNumber] = {
                    partNumber: partNumber,
                    quantity: quantity,
                    type: type,
                    description: description,
                    timestamp: timestamp,
                    lastUpdated: timestamp,
                    dbStock: dbStock,
                    difference: quantity - dbStock
                };
            }
            
            renderPartsList();
            updateProgress();
            updateQuantitySummary();
        }
        
        // 수동 등록 토글
        function toggleManualAdd() {
            const section = document.getElementById('manualAddSection');
            const barcodeInput = document.getElementById('barcodeInput');
            
            if (section.style.display === 'none' || !section.style.display) {
                section.style.display = 'block';
                barcodeInput.blur(); // 바코드 입력 필드 포커스 해제
                document.getElementById('manualPartNumber').focus();
            } else {
                section.style.display = 'none';
                // 입력 필드 초기화
                document.getElementById('manualPartNumber').value = '';
                document.getElementById('manualQuantity').value = '';
                // 수동 등록 섹션이 닫힐 때만 바코드 입력 필드에 포커스
                setTimeout(() => {
                    barcodeInput.focus();
                }, 100);
            }
        }
        
        // 수동 등록 (개선된 버전)
        function addManualPart() {
            const partNumber = document.getElementById('manualPartNumber').value;
            const quantity = parseInt(document.getElementById('manualQuantity').value);
            
            if (!partNumber) {
                showAlert('파트를 선택해주세요.', 'danger');
                return;
            }
            
            if (!quantity || quantity < 0) {
                showAlert('올바른 수량을 입력해주세요.', 'danger');
                return;
            }
            
            // 선택된 파트 정보 찾기
            const selectedPart = partsList.find(part => part.part_number === partNumber);
            if (!selectedPart) {
                showAlert('선택된 파트 정보를 찾을 수 없습니다.', 'danger');
                return;
            }
            
            // description이 없으므로 category를 사용 (수동 등록은 고유 번호 없음)
            addScannedPart(partNumber, quantity, 'manual', selectedPart.category, null);
            
            // 입력 필드 초기화
            document.getElementById('manualPartNumber').value = '';
            document.getElementById('manualQuantity').value = '';
            
            // 수동 등록 섹션 숨기기
            toggleManualAdd();
            
            // 바코드 입력 필드에 포커스 복원
            setTimeout(() => {
                document.getElementById('barcodeInput').focus();
            }, 100);
            
            // 수동 등록 성공 알림 제거 - 연속 작업을 위해
            // showAlert(`${selectedPart.category} (${partNumber}) - ${quantity}개 수동 등록됨`, 'success');
        }
        
        // 파트 목록 렌더링 (개선된 버전 - 파트별 전체 수량 표시)
        function renderPartsList() {
            const tbody = document.getElementById('partsTableBody');
            tbody.innerHTML = '';
            
            // 파트별로 그룹화하여 전체 수량 계산
            const groupedParts = {};
            Object.values(scannedParts).forEach(part => {
                if (!groupedParts[part.partNumber]) {
                    groupedParts[part.partNumber] = {
                        partNumber: part.partNumber,
                        description: part.description,
                        totalQuantity: 0,
                        dbStock: part.dbStock || 0,
                        lastUpdated: part.lastUpdated,
                        types: new Set()
                    };
                }
                
                groupedParts[part.partNumber].totalQuantity += part.quantity;
                groupedParts[part.partNumber].types.add(part.type);
                
                // 가장 최근 업데이트 시간으로 설정
                if (new Date(part.lastUpdated) > new Date(groupedParts[part.partNumber].lastUpdated)) {
                    groupedParts[part.partNumber].lastUpdated = part.lastUpdated;
                }
            });
            
            // 그룹화된 파트들을 테이블에 렌더링
            Object.values(groupedParts).forEach(part => {
                const row = document.createElement('tr');
                
                // 차이량 계산 (전체 실사 수량 - DB 재고)
                const difference = part.totalQuantity - part.dbStock;
                let differenceClass = '';
                let differenceText = difference;
                
                if (differenceText > 0) {
                    differenceClass = 'text-green-600 font-bold';
                    differenceText = `+${differenceText}`;
                } else if (differenceText < 0) {
                    differenceClass = 'text-red-600 font-bold';
                } else {
                    differenceClass = 'text-gray-600';
                }
                
                // 등록 방식 표시 (스캔/수동 혼합인 경우)
                const typeText = part.types.size > 1 ? '혼합' : (part.types.has('scanned') ? '스캔' : '수동');
                
                row.innerHTML = `
                    <td>${part.partNumber}<br><small>${part.description}</small></td>
                    <td class="text-center font-bold text-blue-600">${part.dbStock}</td>
                    <td class="text-center font-bold text-green-600">${part.totalQuantity}</td>
                    <td class="text-center ${differenceClass}">${differenceText}</td>
                    <td><span class="status-badge status-${part.types.has('scanned') ? 'scanned' : 'manual'}">${typeText}</span></td>
                    <td>${part.lastUpdated}</td>
                    <td>
                        <button type="button" class="btn btn-danger" onclick="removePart('${part.partNumber}')" style="padding: 4px 8px; font-size: 12px;">삭제</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 수량 요약 업데이트 (파트별 전체 수량 반영)
        function updateQuantitySummary() {
            // 파트별로 그룹화하여 전체 수량 계산
            const groupedParts = {};
            Object.values(scannedParts).forEach(part => {
                if (!groupedParts[part.partNumber]) {
                    groupedParts[part.partNumber] = {
                        totalQuantity: 0,
                        dbStock: part.dbStock || 0
                    };
                }
                groupedParts[part.partNumber].totalQuantity += part.quantity;
            });
            
            // 전체 실사 수량과 DB 재고 계산
            const totalScanned = Object.values(groupedParts).reduce((sum, part) => sum + part.totalQuantity, 0);
            const totalDb = Object.values(groupedParts).reduce((sum, part) => sum + part.dbStock, 0);
            
            document.getElementById('totalScannedQty').textContent = totalScanned;
            document.getElementById('totalDbQty').textContent = totalDb;
            
            // 수량 요약 표시
            if (Object.keys(scannedParts).length > 0) {
                document.getElementById('quantitySummary').style.display = 'grid';
            } else {
                document.getElementById('quantitySummary').style.display = 'none';
            }
        }
        
        // 파트 삭제 (개선된 버전 - 파트별 전체 삭제)
        function removePart(partNumber) {
            // 같은 파트 번호의 모든 항목 찾기
            const partsToRemove = Object.keys(scannedParts).filter(key => 
                scannedParts[key].partNumber === partNumber
            );
            
            // 각 항목 삭제
            partsToRemove.forEach(key => {
                const part = scannedParts[key];
                if (part && part.uniqueIds) {
                    // 고유번호들도 Set에서 제거
                    part.uniqueIds.forEach(id => {
                        scannedUniqueIds.delete(id);
                    });
                }
                delete scannedParts[key];
            });
            
            console.log(`파트 ${partNumber}의 ${partsToRemove.length}개 항목 삭제됨`);
            
            renderPartsList();
            updateProgress();
            updateQuantitySummary();
        }
        
        // 진행률 업데이트 (개선된 버전 - 파트별 고유 수량)
        function updateProgress() {
            // 파트별로 그룹화하여 고유 파트 수 계산
            const uniqueParts = new Set();
            Object.values(scannedParts).forEach(part => {
                uniqueParts.add(part.partNumber);
            });
            
            const totalUniqueParts = uniqueParts.size;
            const totalScannedItems = Object.keys(scannedParts).length;
            
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            
            // 진행률 계산 (임시로 스캔된 항목 수로 표시)
            const progress = totalScannedItems > 0 ? 100 : 0;
            
            progressFill.style.width = `${progress}%`;
            progressText.textContent = `스캔된 파트: ${totalUniqueParts}개 (총 ${totalScannedItems}개 항목)`;
        }
        
        // 실사 저장
        function savePhysicalInventory() {
                let sessionName = document.getElementById('sessionName').value.trim();
                const sessionDate = document.getElementById('sessionDate').value;
                
                // 세션명이 비어있으면 자동 생성
                if (!sessionName) {
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    sessionName = `${year}년 ${month}월 ${day}일 실사 (${hours}:${minutes})`;
                    document.getElementById('sessionName').value = sessionName;
                }
            
            if (!sessionDate) {
                showAlert('실사 날짜를 선택해주세요.', 'danger');
                return;
            }
            
            if (Object.keys(scannedParts).length === 0) {
                showAlert('스캔된 항목이 없습니다.', 'danger');
                return;
            }
            
            showConfirmModal();
        }
        
        // 확인 모달 표시
        function showConfirmModal() {
            document.getElementById('confirmModal').style.display = 'block';
        }
        
        // 확인 모달 닫기
        function closeConfirmModal() {
            document.getElementById('confirmModal').style.display = 'none';
        }
        
        // 저장 확인
        async function confirmSave() {
            try {
                if (!supabase) {
                    throw new Error('Supabase 클라이언트가 초기화되지 않았습니다.');
                }
                
                const sessionName = document.getElementById('sessionName').value.trim();
                const sessionDate = document.getElementById('sessionDate').value;
                
                // 1. 실사 세션 생성 (DB 스키마에 맞게 수정)
                const totalParts = Object.keys(scannedParts).length;
                const { data: sessionData, error: sessionError } = await supabase
                    .from('physical_inventory_sessions')
                    .insert({
                        session_date: sessionDate,
                        status: 'PENDING',
                        notes: sessionName,  // 세션명을 notes에 저장
                        total_parts: totalParts,  // 전체 파트 수 저장
                        completed_parts: 0  // 완료된 파트 수 초기화
                    })
                    .select()
                    .single();
                
                if (sessionError) throw sessionError;
                
                currentSessionId = sessionData.id;
                
                // 2. 각 파트별 실사 항목 생성
                const inventoryItems = [];
                
                for (const [partNumber, part] of Object.entries(scannedParts)) {
                    // 캐시에서 DB 재고 조회
                    const dbStock = getDbStock(partNumber);
                    const difference = part.quantity - dbStock;
                    
                    inventoryItems.push({
                        session_id: currentSessionId,
                        part_number: partNumber,
                        system_stock: dbStock,  // db_stock → system_stock
                        physical_stock: part.quantity,  // physical_stocl 오타 수정
                        // difference는 자동 계산되므로 제거
                        // status는 기본값 사용 (PENDING)
                        notes: `${part.type === 'scanned' ? '바코드 스캔' : '수동 등록'} - ${part.description} (차이: ${difference > 0 ? '+' : ''}${difference})`
                    });
                }
                
                // 3. 실사 항목 저장 (DB 스키마에 맞게 수정)
                try {
                    // DB에 저장 시도
                    const { error: itemsError } = await supabase
                        .from('physical_inventory_items')
                        .insert(inventoryItems);
                    
                    if (itemsError) throw itemsError;
                    
                    showAlert('실사 데이터가 성공적으로 저장되었습니다.', 'success');
                } catch (dbError) {
                    console.warn('DB 저장 실패, 로컬 스토리지에 백업 저장:', dbError);
                    
                    // DB 저장 실패 시 로컬 스토리지에 백업
                    const backupData = {
                        sessionId: currentSessionId,
                        sessionName: sessionName,
                        sessionDate: sessionDate,
                        items: inventoryItems,
                        timestamp: new Date().toISOString()
                    };
                    
                    localStorage.setItem(`physical_inventory_backup_${currentSessionId}`, JSON.stringify(backupData));
                    
                    showAlert('DB 저장에 실패했지만 로컬에 백업되었습니다.', 'warning');
                }
                
                closeConfirmModal();
                
                // 성공 후 초기화
                setTimeout(() => {
                    clearAll();
                }, 2000);
                
            } catch (error) {
                console.error('실사 저장 오류:', error);
                showAlert(`실사 저장 중 오류가 발생했습니다: ${error.message}`, 'danger');
            }
        }
        
        // DB 재고 새로고침 함수
        async function refreshDbStock() {
            try {
                console.log('=== DB 재고 새로고침 시작 ===');
                showAlert('DB 재고를 새로고침하는 중...', 'info');
                
                // DB 재고 다시 로드
                const newDbInventory = await loadAllPartsDbStock();
                
                if (Object.keys(newDbInventory).length > 0) {
                    dbInventory = newDbInventory;
                    
                    // 현재 스캔된 파트들의 DB 재고 업데이트
                    Object.values(scannedParts).forEach(part => {
                        part.dbStock = getDbStock(part.partNumber);
                        part.difference = part.quantity - part.dbStock;
                    });
                    
                    // UI 업데이트
                    renderPartsList();
                    updateQuantitySummary();
                    
                    showAlert('DB 재고가 성공적으로 새로고침되었습니다.', 'success');
                    console.log('DB 재고 새로고침 완료');
                } else {
                    showAlert('DB 재고를 불러올 수 없습니다. 데이터베이스 연결을 확인해주세요.', 'danger');
                }
            } catch (error) {
                console.error('DB 재고 새로고침 오류:', error);
                showAlert(`DB 재고 새로고침 중 오류가 발생했습니다: ${error.message}`, 'danger');
            }
        }

        // 전체 초기화 (개선된 버전)
        function clearAll() {
            scannedParts = {};
            scannedUniqueIds.clear(); // 고유번호 Set도 초기화
            dbInventory = {}; // DB 재고 캐시도 초기화
            renderPartsList();
            updateProgress();
            updateQuantitySummary();
            document.getElementById('barcodeInput').value = '';
            document.getElementById('manualPartNumber').value = '';
            document.getElementById('manualQuantity').value = '';
            // 새로운 세션명 생성
            generateSessionName();
            // 바코드 입력 필드에 포커스 (약간의 지연을 두어 UI 업데이트 후 실행)
            setTimeout(() => {
                document.getElementById('barcodeInput').focus();
            }, 100);
        }
        
        // 알림 표시
        function showAlert(message, type) {
            const alertDiv = document.getElementById('scanAlert');
            alertDiv.textContent = message;
            alertDiv.className = `alert alert-${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 3000);
        }
        
        // 저장된 실사 데이터 확인 함수
        function viewSavedData() {
            const savedData = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('physical_inventory_backup_')) {
                    try {
                        const data = JSON.parse(localStorage.getItem(key));
                        savedData.push({
                            key: key,
                            sessionId: data.sessionId,
                            sessionName: data.sessionName,
                            sessionDate: data.sessionDate,
                            itemCount: data.items ? data.items.length : 0,
                            timestamp: data.timestamp
                        });
                    } catch (e) {
                        console.warn('저장된 데이터 파싱 오류:', key, e);
                    }
                }
            }
            
            if (savedData.length === 0) {
                showAlert('저장된 실사 데이터가 없습니다.', 'info');
                return;
            }
            
            console.log('저장된 실사 데이터:', savedData);
            showAlert(`저장된 실사 데이터 ${savedData.length}개를 콘솔에서 확인하세요.`, 'info');
        }

        // 모달 외부 클릭 시 닫기
        window.onclick = function(event) {
            const modal = document.getElementById('confirmModal');
            if (event.target === modal) {
                closeConfirmModal();
            }
        }
    </script>
</body>
</html> 