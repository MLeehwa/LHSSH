<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARN 기능 테스트</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <style>
        .test-section { border: 2px solid #e5e7eb; border-radius: 8px; margin: 20px 0; padding: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .test-success { background-color: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .test-error { background-color: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }
        .test-info { background-color: #dbeafe; border: 1px solid #3b82f6; color: #1e40af; }
        .loading { opacity: 0.5; pointer-events: none; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-800">ARN 기능 테스트</h1>
        
        <!-- 테스트 결과 표시 영역 -->
        <div id="testResults" class="mb-8">
            <h2 class="text-xl font-semibold mb-4">테스트 결과</h2>
            <div id="resultsContainer"></div>
        </div>

        <!-- ARN 번호 생성 테스트 -->
        <div class="test-section">
            <h3 class="text-lg font-semibold mb-4">1. ARN 번호 생성 테스트</h3>
            <button id="testArnGeneration" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                ARN 번호 생성 테스트
            </button>
            <div id="arnGenerationResult" class="mt-4"></div>
        </div>

        <!-- 컨테이너 등록 테스트 -->
        <div class="test-section">
            <h3 class="text-lg font-semibold mb-4">2. 컨테이너 등록 테스트</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">컨테이너 번호</label>
                    <input type="text" id="testContainerNumber" class="w-full p-2 border rounded" value="TEST-CONTAINER-001">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">도착일</label>
                    <input type="date" id="testArrivalDate" class="w-full p-2 border rounded">
                </div>
            </div>
            <button id="testContainerRegistration" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                컨테이너 등록 테스트
            </button>
            <div id="containerRegistrationResult" class="mt-4"></div>
        </div>

        <!-- 파트 등록 테스트 -->
        <div class="test-section">
            <h3 class="text-lg font-semibold mb-4">3. 파트 등록 테스트</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">ARN 번호</label>
                    <input type="text" id="testArnNumber" class="w-full p-2 border rounded" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">파트 번호</label>
                    <input type="text" id="testPartNumber" class="w-full p-2 border rounded" value="TEST-PART-001">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">수량</label>
                    <input type="number" id="testQuantity" class="w-full p-2 border rounded" value="100">
                </div>
            </div>
            <button id="testPartRegistration" class="bg-purple-500 text-white px-4 py-2 rounded hover:bg-purple-600">
                파트 등록 테스트
            </button>
            <div id="partRegistrationResult" class="mt-4"></div>
        </div>

        <!-- 입고 처리 테스트 -->
        <div class="test-section">
            <h3 class="text-lg font-semibold mb-4">4. 입고 처리 테스트</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium mb-2">입고일</label>
                    <input type="date" id="testInboundDate" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">상태</label>
                    <select id="testStatus" class="w-full p-2 border rounded">
                        <option value="PENDING">대기중</option>
                        <option value="INBOUND">입고완료</option>
                        <option value="CANCELLED">취소</option>
                    </select>
                </div>
            </div>
            <button id="testInboundProcessing" class="bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600">
                입고 처리 테스트
            </button>
            <div id="inboundProcessingResult" class="mt-4"></div>
        </div>

        <!-- 데이터 조회 테스트 -->
        <div class="test-section">
            <h3 class="text-lg font-semibold mb-4">5. 데이터 조회 테스트</h3>
            <button id="testDataRetrieval" class="bg-indigo-500 text-white px-4 py-2 rounded hover:bg-indigo-600">
                데이터 조회 테스트
            </button>
            <div id="dataRetrievalResult" class="mt-4"></div>
        </div>

        <!-- 전체 테스트 -->
        <div class="test-section">
            <h3 class="text-lg font-semibold mb-4">6. 전체 기능 테스트</h3>
            <button id="runAllTests" class="bg-red-500 text-white px-6 py-3 rounded hover:bg-red-600 font-semibold">
                전체 테스트 실행
            </button>
            <div id="allTestsResult" class="mt-4"></div>
        </div>

        <!-- 테스트 데이터 표시 -->
        <div class="test-section">
            <h3 class="text-lg font-semibold mb-4">7. 테스트 데이터</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <h4 class="font-medium mb-2">컨테이너 데이터</h4>
                    <div id="containerData" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-60"></div>
                </div>
                <div>
                    <h4 class="font-medium mb-2">파트 데이터</h4>
                    <div id="partData" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-60"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ARNTestManager {
            constructor() {
                this.testResults = [];
                this.currentArnNumber = null;
                this.currentContainerNumber = null;
                this.initializeTests();
            }

            initializeTests() {
                // 오늘 날짜 설정
                document.getElementById('testArrivalDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('testInboundDate').value = new Date().toISOString().split('T')[0];

                // 이벤트 바인딩
                document.getElementById('testArnGeneration').addEventListener('click', () => this.testArnGeneration());
                document.getElementById('testContainerRegistration').addEventListener('click', () => this.testContainerRegistration());
                document.getElementById('testPartRegistration').addEventListener('click', () => this.testPartRegistration());
                document.getElementById('testInboundProcessing').addEventListener('click', () => this.testInboundProcessing());
                document.getElementById('testDataRetrieval').addEventListener('click', () => this.testDataRetrieval());
                document.getElementById('runAllTests').addEventListener('click', () => this.runAllTests());

                this.addResult('시스템 초기화', '테스트 시스템이 준비되었습니다.', 'info');
            }

            addResult(testName, message, type = 'info') {
                const result = { testName, message, type, timestamp: new Date() };
                this.testResults.push(result);
                this.displayResult(result);
                console.log(`[${type.toUpperCase()}] ${testName}: ${message}`);
            }

            displayResult(result) {
                const container = document.getElementById('resultsContainer');
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result test-${result.type}`;
                resultDiv.innerHTML = `
                    <strong>${result.testName}</strong> - ${result.message}
                    <small class="block text-xs opacity-75">${result.timestamp.toLocaleTimeString()}</small>
                `;
                container.appendChild(resultDiv);
                container.scrollTop = container.scrollHeight;
            }

            async testArnGeneration() {
                try {
                    this.addResult('ARN 번호 생성', 'ARN 번호 생성 테스트 시작...', 'info');
                    
                    // ARN 번호 생성 로직
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const time = String(now.getHours()).padStart(2, '0') + 
                               String(now.getMinutes()).padStart(2, '0') + 
                               String(now.getSeconds()).padStart(2, '0');
                    
                    const arnNumber = `ARN${year}${month}${day}${time}`;
                    this.currentArnNumber = arnNumber;
                    
                    document.getElementById('testArnNumber').value = arnNumber;
                    
                    this.addResult('ARN 번호 생성', `ARN 번호가 생성되었습니다: ${arnNumber}`, 'success');
                    return arnNumber;
                } catch (error) {
                    this.addResult('ARN 번호 생성', `오류 발생: ${error.message}`, 'error');
                    throw error;
                }
            }

            async testContainerRegistration() {
                try {
                    this.addResult('컨테이너 등록', '컨테이너 등록 테스트 시작...', 'info');
                    
                    const containerNumber = document.getElementById('testContainerNumber').value;
                    const arrivalDate = document.getElementById('testArrivalDate').value;
                    
                    if (!containerNumber || !arrivalDate) {
                        throw new Error('컨테이너 번호와 도착일을 입력해주세요.');
                    }

                    // ARN 번호가 없으면 생성
                    if (!this.currentArnNumber) {
                        await this.testArnGeneration();
                    }

                    // 컨테이너 데이터 준비
                    const containerData = {
                        arn_number: this.currentArnNumber,
                        container_number: containerNumber,
                        arrival_date: arrivalDate,
                        status: 'PENDING',
                        notes: '테스트 컨테이너',
                        created_at: new Date().toISOString()
                    };

                    // Supabase에 저장
                    const { data, error } = await window.supabaseClient
                        .from('arn_containers')
                        .insert([containerData])
                        .select();

                    if (error) {
                        throw new Error(`컨테이너 저장 오류: ${error.message}`);
                    }

                    this.currentContainerNumber = containerNumber;
                    this.addResult('컨테이너 등록', `컨테이너가 성공적으로 등록되었습니다: ${containerNumber}`, 'success');
                    
                    // 데이터 새로고침
                    await this.refreshTestData();
                    
                } catch (error) {
                    this.addResult('컨테이너 등록', `오류 발생: ${error.message}`, 'error');
                    throw error;
                }
            }

            async testPartRegistration() {
                try {
                    this.addResult('파트 등록', '파트 등록 테스트 시작...', 'info');
                    
                    const partNumber = document.getElementById('testPartNumber').value;
                    const quantity = parseInt(document.getElementById('testQuantity').value);
                    
                    if (!partNumber || quantity <= 0) {
                        throw new Error('파트 번호와 수량을 입력해주세요.');
                    }

                    if (!this.currentArnNumber || !this.currentContainerNumber) {
                        throw new Error('먼저 컨테이너를 등록해주세요.');
                    }

                    // 파트 데이터 준비
                    const partData = {
                        arn_number: this.currentArnNumber,
                        container_number: this.currentContainerNumber,
                        part_number: partNumber,
                        quantity: quantity,
                        status: 'PENDING',
                        notes: '테스트 파트',
                        created_at: new Date().toISOString()
                    };

                    // Supabase에 저장
                    const { data, error } = await window.supabaseClient
                        .from('arn_parts')
                        .insert([partData])
                        .select();

                    if (error) {
                        throw new Error(`파트 저장 오류: ${error.message}`);
                    }

                    this.addResult('파트 등록', `파트가 성공적으로 등록되었습니다: ${partNumber} (${quantity}개)`, 'success');
                    
                    // 데이터 새로고침
                    await this.refreshTestData();
                    
                } catch (error) {
                    this.addResult('파트 등록', `오류 발생: ${error.message}`, 'error');
                    throw error;
                }
            }

            async testInboundProcessing() {
                try {
                    this.addResult('입고 처리', '입고 처리 테스트 시작...', 'info');
                    
                    const inboundDate = document.getElementById('testInboundDate').value;
                    const status = document.getElementById('testStatus').value;
                    
                    if (!inboundDate) {
                        throw new Error('입고일을 입력해주세요.');
                    }

                    if (!this.currentArnNumber) {
                        throw new Error('먼저 컨테이너를 등록해주세요.');
                    }

                    // 컨테이너 상태 업데이트
                    const { error: containerError } = await window.supabaseClient
                        .from('arn_containers')
                        .update({
                            status: status,
                            inbound_date: inboundDate,
                            updated_at: new Date().toISOString()
                        })
                        .eq('arn_number', this.currentArnNumber);

                    if (containerError) {
                        throw new Error(`컨테이너 상태 업데이트 오류: ${containerError.message}`);
                    }

                    // 파트 상태 업데이트
                    const { error: partsError } = await window.supabaseClient
                        .from('arn_parts')
                        .update({
                            status: status,
                            updated_at: new Date().toISOString()
                        })
                        .eq('arn_number', this.currentArnNumber);

                    if (partsError) {
                        throw new Error(`파트 상태 업데이트 오류: ${partsError.message}`);
                    }

                    this.addResult('입고 처리', `입고 처리가 완료되었습니다. 상태: ${status}`, 'success');
                    
                    // 데이터 새로고침
                    await this.refreshTestData();
                    
                } catch (error) {
                    this.addResult('입고 처리', `오류 발생: ${error.message}`, 'error');
                    throw error;
                }
            }

            async testDataRetrieval() {
                try {
                    this.addResult('데이터 조회', '데이터 조회 테스트 시작...', 'info');
                    
                    // 컨테이너 데이터 조회
                    const { data: containers, error: containerError } = await window.supabaseClient
                        .from('arn_containers')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(10);

                    if (containerError) {
                        throw new Error(`컨테이너 조회 오류: ${containerError.message}`);
                    }

                    // 파트 데이터 조회
                    const { data: parts, error: partsError } = await window.supabaseClient
                        .from('arn_parts')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(10);

                    if (partsError) {
                        throw new Error(`파트 조회 오류: ${partsError.message}`);
                    }

                    this.addResult('데이터 조회', `컨테이너 ${containers.length}개, 파트 ${parts.length}개 조회 완료`, 'success');
                    
                    // 데이터 표시
                    this.displayTestData(containers, parts);
                    
                } catch (error) {
                    this.addResult('데이터 조회', `오류 발생: ${error.message}`, 'error');
                    throw error;
                }
            }

            displayTestData(containers, parts) {
                // 컨테이너 데이터 표시
                const containerDiv = document.getElementById('containerData');
                containerDiv.innerHTML = containers.map(container => `
                    <div class="mb-2 p-2 bg-white rounded border">
                        <strong>${container.container_number}</strong><br>
                        ARN: ${container.arn_number}<br>
                        상태: ${container.status}<br>
                        도착일: ${container.arrival_date}
                    </div>
                `).join('');

                // 파트 데이터 표시
                const partDiv = document.getElementById('partData');
                partDiv.innerHTML = parts.map(part => `
                    <div class="mb-2 p-2 bg-white rounded border">
                        <strong>${part.part_number}</strong><br>
                        수량: ${part.quantity}<br>
                        컨테이너: ${part.container_number}<br>
                        상태: ${part.status}
                    </div>
                `).join('');
            }

            async refreshTestData() {
                await this.testDataRetrieval();
            }

            async runAllTests() {
                try {
                    this.addResult('전체 테스트', '전체 기능 테스트를 시작합니다...', 'info');
                    
                    // 테스트 순서대로 실행
                    await this.testArnGeneration();
                    await this.testContainerRegistration();
                    await this.testPartRegistration();
                    await this.testInboundProcessing();
                    await this.testDataRetrieval();
                    
                    this.addResult('전체 테스트', '모든 테스트가 성공적으로 완료되었습니다!', 'success');
                    
                } catch (error) {
                    this.addResult('전체 테스트', `테스트 중 오류 발생: ${error.message}`, 'error');
                }
            }
        }

        // 페이지 로드 시 테스트 매니저 초기화
        document.addEventListener('DOMContentLoaded', () => {
            // Supabase 클라이언트 초기화 확인
            if (typeof window.supabaseClient === 'undefined') {
                console.error('Supabase 클라이언트가 초기화되지 않았습니다.');
                alert('Supabase 연결에 실패했습니다. config.js 파일을 확인해주세요.');
                return;
            }

            // 테스트 매니저 초기화
            window.arnTestManager = new ARNTestManager();
        });
    </script>
</body>
</html> 