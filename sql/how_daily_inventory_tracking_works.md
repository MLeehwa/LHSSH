# 일자별 재고 현황 추적 방법

## 현재 시스템의 일자별 재고 계산 방식

### 재고 현황 페이지의 `calculateDateStock()` 함수 동작 원리

1. **현재 재고에서 역산**
   - 현재 `inventory` 테이블의 재고를 기준으로 시작
   - 기준일 이후의 모든 거래 내역을 역산하여 전날 재고 계산
   - 예: 11/13 재고에서 11/6~11/13 거래를 역산 → 11/5 재고 계산

2. **기준일 거래 내역 집계**
   - `inventory_transactions`에서 기준일의 모든 거래 내역 조회
   - 입고(INBOUND), 출고(OUTBOUND), 조정(ADJUSTMENT) 합계 계산

3. **해당일 재고 계산**
   ```
   해당일 재고 = 전날 재고 + 해당일 입고 - 해당일 출고 + 해당일 조정
   ```

### 예시: 11/5 재고 계산

```
현재 재고 (11/13): 125개
11/6~11/13 거래 내역:
  - 11/6: 입고 +20
  - 11/7: 출고 -10
  - 11/8: 입고 +15
  - 11/9: 출고 -5
  - 11/10: 조정 +2
  - 11/11: 입고 +10
  - 11/12: 출고 -8
  - 11/13: 입고 +5

역산 계산:
  11/5 재고 = 125 - 20 + 10 - 15 + 5 - 2 - 10 + 8 - 5 = 96개

11/5 거래 내역:
  - 입고: +15
  - 출고: -8
  - 조정: 0

11/5 재고 = 96 + 15 - 8 = 103개
```

## 마이그레이션 후 일자별 재고 추적

### 시나리오: 11/1~11/13 거래 내역 + 11/13 마감 재고만 있는 경우

**질문: 11/5 같은 특정 날짜의 재고를 자동으로 계산할 수 있나요?**

**답변: 네, 가능합니다!** 하지만 시작 재고를 먼저 설정해야 합니다.

### 방법 1: 역산으로 시작 재고 설정 (권장)

1. **11/1 시작 재고 역산 계산**
   ```sql
   -- 11/13 마감 재고 - (11/1~11/13 거래 내역 합계) = 11/1 시작 재고
   WITH transaction_summary AS (
       SELECT 
           part_number,
           SUM(
               CASE 
                   WHEN transaction_type = 'INBOUND' THEN quantity
                   WHEN transaction_type = 'OUTBOUND' THEN -quantity
                   WHEN transaction_type = 'ADJUSTMENT' THEN quantity
               END
           ) AS net_change
       FROM inventory_transactions
       WHERE transaction_date >= '2024-11-01' 
         AND transaction_date <= '2024-11-13'
       GROUP BY part_number
   ),
   final_stock AS (
       -- 실제 11/13 마감 재고
       SELECT '49560-L3010' AS part_number, 125 AS final_stock
   )
   INSERT INTO inventory (part_number, current_stock, last_updated)
   SELECT 
       fs.part_number,
       fs.final_stock - COALESCE(ts.net_change, 0) AS initial_stock,
       '2024-11-01'
   FROM final_stock fs
   LEFT JOIN transaction_summary ts ON fs.part_number = ts.part_number;
   ```

2. **11/1~11/13 거래 내역 삽입**
   - 날짜 순서대로 삽입
   - 트리거가 자동으로 재고 업데이트

3. **일자별 재고 추적 가능**
   - 재고 현황 페이지에서 11/5 선택
   - 시스템이 자동으로 계산:
     - 현재 재고(11/13)에서 11/6~11/13 거래 역산 → 11/5 전날 재고
     - 11/5 거래 내역 집계
     - 11/5 재고 = 전날 재고 + 11/5 입고 - 11/5 출고 + 11/5 조정

### 방법 2: 트리거 비활성화 후 직접 설정 (간단하지만 제한적)

1. 트리거 비활성화
2. 11/1~11/13 거래 내역 삽입 (기록만)
3. 11/13 마감 재고를 `inventory`에 직접 설정
4. 트리거 재활성화

**⚠️ 주의:** 이 방법은 거래 내역이 기록만 되고 재고 계산에는 반영되지 않습니다.
- 일자별 재고 추적은 가능하지만, 역산 계산이 부정확할 수 있습니다.
- 현재 재고에서 역산하는 방식이므로, 시작 재고가 없으면 오차가 발생할 수 있습니다.

## 권장 방법

**방법 1 (역산으로 시작 재고 설정)**을 권장합니다:
- 11/13 마감 재고와 11/1~11/13 거래 내역만 있으면 됨
- 11/1 시작 재고를 자동으로 역산 계산
- 이후 모든 날짜의 재고를 정확하게 추적 가능
- 재고 현황 페이지에서 어떤 날짜든 선택하면 자동 계산

## 일자별 재고 추적 작동 원리

```
현재 재고 (inventory 테이블)
  ↓
기준일 이후 거래 내역 역산
  ↓
전날 재고 계산
  ↓
기준일 거래 내역 집계
  ↓
해당일 재고 = 전날 재고 + 입고 - 출고 + 조정
```

## 검증

재고 현황 페이지에서:
1. 날짜 선택 (예: 2024-11-05)
2. "재고 계산" 버튼 클릭
3. 시스템이 자동으로:
   - 현재 재고에서 11/6~11/13 거래 역산
   - 11/5 거래 내역 집계
   - 11/5 재고 계산 및 표시

## 결론

**네, 가능합니다!**

- 11/1~11/13 거래 내역을 올리고
- 11/13 마감 재고를 올리면
- 역산으로 11/1 시작 재고를 계산하여 설정
- 이후 재고 현황 페이지에서 어떤 날짜든 선택하면 자동으로 해당 날짜의 재고를 계산하여 보여줍니다

